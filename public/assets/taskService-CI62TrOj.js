const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-BQmY0BmM.js","assets/lucide-react-CAeuRJQk.js","assets/index-YbdY78QJ.css","assets/permissions-gaCIgPOa.js","assets/rolePermissionsService-BQ7cNajw.js"])))=>i.map(i=>d[i]);
var ot=Object.defineProperty,ct=Object.defineProperties;var dt=Object.getOwnPropertyDescriptors;var et=Object.getOwnPropertySymbols;var lt=Object.prototype.hasOwnProperty,ut=Object.prototype.propertyIsEnumerable;var at=(t,e,a)=>e in t?ot(t,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[e]=a,k=(t,e)=>{for(var a in e||(e={}))lt.call(e,a)&&at(t,a,e[a]);if(et)for(var a of et(e))ut.call(e,a)&&at(t,a,e[a]);return t},q=(t,e)=>ct(t,dt(e));var w=(t,e,a)=>new Promise((i,o)=>{var r=d=>{try{s(a.next(d))}catch(c){o(c)}},n=d=>{try{s(a.throw(d))}catch(c){o(c)}},s=d=>d.done?i(d.value):Promise.resolve(d.value).then(r,n);s((a=a.apply(t,e)).next())});import{D as b,E as g,G as D,F as C,au as F,A as $,W as Z,N as T,O as h,H as U,K as L,J as E,Q as N,av as mt,M as R,P as Y,T as G,X as j,_ as x,r as K,R as O,k as pt,aw as V}from"./index-BQmY0BmM.js";const wt=(t,e)=>{const a={code:(t==null?void 0:t.code)||"unknown",message:(t==null?void 0:t.message)||"Unknown error",operation:e.operation,collection:e.collection,documentId:e.documentId,userId:e.userId,timestamp:new Date().toISOString(),data:st(e.data)};console.error("ðŸš« Permission Error:",q(k({},a),{fullError:t}));const i=`
Permission HatasÄ± DetaylarÄ±:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Ä°ÅŸlem: ${e.operation}
Collection: ${e.collection||"N/A"}
Document ID: ${e.documentId||"N/A"}
KullanÄ±cÄ± ID: ${e.userId||"N/A"}
Hata Kodu: ${a.code}
Hata MesajÄ±: ${a.message}
Zaman: ${a.timestamp}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
`;console.error(i),e.collection&&(console.warn("ðŸ“‹ Firebase Console'da Security Rules'u kontrol edin:"),console.warn("   https://console.firebase.google.com/project/revpad-15232/firestore/rules"),console.warn(`   Collection: ${e.collection}`),console.warn(`   Operation: ${e.operation}`))},st=t=>{if(!t||typeof t!="object")return t;const e=["password","token","secret","key","apiKey"],a=k({},t);for(const i of e)i in a&&(a[i]="[REDACTED]");for(const i in a)typeof a[i]=="object"&&a[i]!==null&&(a[i]=st(a[i]));return a},J=(t,e)=>{var a,i,o;if((t==null?void 0:t.code)==="permission-denied"||(t==null?void 0:t.code)===7||(a=t==null?void 0:t.message)!=null&&a.includes("Missing or insufficient permissions")||(i=t==null?void 0:t.message)!=null&&i.includes("permission-denied")||(o=t==null?void 0:t.message)!=null&&o.includes("PERMISSION_DENIED")){wt(t,e),{create:"oluÅŸturma",update:"gÃ¼ncelleme",delete:"silme",read:"okuma"}[e.operation]||e.operation;const n="Yetkiniz yok. Bu iÅŸlemi yapmak iÃ§in ekip lideri veya yÃ¶neticiye ulaÅŸabilirsiniz.";return new Error(n)}return t instanceof Error?t:new Error((t==null?void 0:t.message)||"Bilinmeyen hata")},X=t=>{var e,a,i;return(t==null?void 0:t.code)==="permission-denied"||(t==null?void 0:t.code)===7||((e=t==null?void 0:t.message)==null?void 0:e.includes("Missing or insufficient permissions"))||((a=t==null?void 0:t.message)==null?void 0:a.includes("permission-denied"))||((i=t==null?void 0:t.message)==null?void 0:i.includes("PERMISSION_DENIED"))},gt=(t,e)=>w(void 0,null,function*(){var a;try{let i=$(b(g,"notifications"),D("userId","==",t),C("createdAt","desc"));return e!=null&&e.unreadOnly&&(i=$(i,D("read","==",!1))),e!=null&&e.limit&&(i=$(i,F(e.limit))),(yield U(i)).docs.map(r=>k({id:r.id},r.data()))}catch(i){if(console.error("Get notifications error:",i),typeof i=="object"&&i!==null&&"code"in i&&i.code==="failed-precondition"&&"message"in i&&typeof i.message=="string"&&i.message.includes("index")){const n=(a=i.message.match(/https:\/\/[^\s]+/))==null?void 0:a[0];if(n){console.warn("âš ï¸ Firestore index gerekiyor! LÃ¼tfen ÅŸu linke tÄ±klayarak index'i oluÅŸturun:"),console.warn(n);const s=new Error("Firestore index gerekiyor. LÃ¼tfen index'i oluÅŸturun.");throw s.indexUrl=n,s.code="index-required",s}}throw i}}),S=t=>w(void 0,null,function*(){try{const e=yield L(b(g,"notifications"),q(k({},t),{createdAt:E()})),a=yield N(e);if(!a.exists())throw new Error("Bildirim oluÅŸturulamadÄ±");const i=k({id:a.id},a.data());try{const o=yield N(h(g,"users",t.userId));if(o.exists()){const r=o.data();if(r!=null&&r.email)try{const n=yield mt(r.email,t.title,t.message,t.type,t.relatedId||null);n.success,n.success}catch(n){}}}catch(o){}return i}catch(e){throw console.error("Create notification error:",e),e}}),I=(t,e)=>w(void 0,null,function*(){try{yield T(h(g,"notifications",t),e)}catch(a){throw console.error("Update notification error:",a),a}}),yt=t=>w(void 0,null,function*(){try{yield T(h(g,"notifications",t),{read:!0})}catch(e){throw console.error("Mark notification as read error:",e),e}}),ft=t=>w(void 0,null,function*(){try{const e=$(b(g,"notifications"),D("userId","==",t),D("read","==",!1)),i=(yield U(e)).docs.map(o=>T(o.ref,{read:!0}));yield Promise.all(i)}catch(e){throw console.error("Mark all notifications as read error:",e),e}}),ht=(t,e={},a)=>{try{const i=b(g,"notifications");let r=(()=>{const s=[D("userId","==",t),C("createdAt","desc")];return e!=null&&e.unreadOnly&&s.push(D("read","==",!1)),e!=null&&e.limit&&s.push(F(e.limit)),$(i,...s)})();return Z(r,s=>{try{const d=s.docs.map(c=>k({id:c.id},c.data()));a(d)}catch(d){console.error("Subscribe to notifications error:",d),a([])}},s=>{var d,c,l,u;if((s==null?void 0:s.code)==="unavailable"||(s==null?void 0:s.code)==="not-found"||(d=s==null?void 0:s.message)!=null&&d.includes("404")||(c=s==null?void 0:s.message)!=null&&c.includes("network")||(l=s==null?void 0:s.message)!=null&&l.includes("transport errored")){a([]);return}if((s==null?void 0:s.code)==="failed-precondition"||(u=s==null?void 0:s.message)!=null&&u.includes("index"))try{const m=$(i,D("userId","==",t),C("createdAt","desc"));return Z(m,p=>{try{let f=p.docs.map(v=>k({id:v.id},v.data()));e!=null&&e.unreadOnly&&(f=f.filter(v=>!v.read)),e!=null&&e.limit&&(f=f.slice(0,e.limit)),a(f)}catch(f){console.error("Fallback subscribe to notifications error:",f),a([])}},p=>{console.error("Fallback notifications snapshot error:",p),a([])})}catch(m){console.error("Fallback query setup error:",m),a([])}else a([])})}catch(i){return console.error("Subscribe to notifications setup error:",i),()=>{}}},W=Object.freeze(Object.defineProperty({__proto__:null,createNotification:S,getNotifications:gt,markAllNotificationsAsRead:ft,markNotificationAsRead:yt,subscribeToNotifications:ht,updateNotification:I},Symbol.toStringTag,{value:"Module"})),M="projects",kt=t=>w(void 0,null,function*(){var e;try{let a=$(b(g,M),C("createdAt","desc"));return t!=null&&t.status&&(a=$(a,D("status","==",t.status))),t!=null&&t.createdBy&&(a=$(a,D("createdBy","==",t.createdBy))),(yield U(a)).docs.map(o=>k({id:o.id},o.data()))}catch(a){if((a==null?void 0:a.code)==="failed-precondition"||(e=a==null?void 0:a.message)!=null&&e.includes("index"))try{const i=$(b(g,M),C("createdAt","desc"));let r=(yield U(i)).docs.map(n=>k({id:n.id},n.data()));return t!=null&&t.status&&(r=r.filter(n=>n.status===t.status)),t!=null&&t.createdBy&&(r=r.filter(n=>n.createdBy===t.createdBy)),r}catch(i){console.error("Fallback query de baÅŸarÄ±sÄ±z:",i);let r=(yield U(b(g,M))).docs.map(n=>k({id:n.id},n.data()));return t!=null&&t.status&&(r=r.filter(n=>n.status===t.status)),t!=null&&t.createdBy&&(r=r.filter(n=>n.createdBy===t.createdBy)),r.sort((n,s)=>{var l,u;const d=((l=n.createdAt)==null?void 0:l.toMillis())||0;return(((u=s.createdAt)==null?void 0:u.toMillis())||0)-d}),r}throw console.error("Get projects error:",a),a}}),Q=t=>w(void 0,null,function*(){try{const e=yield N(h(g,M,t));return e.exists()?k({id:e.id},e.data()):null}catch(e){throw console.error("Get project by id error:",e),e}}),vt=t=>w(void 0,null,function*(){try{const e=q(k({},t),{createdAt:E(),updatedAt:E()}),a=yield L(b(g,M),e),i=yield Q(a.id);if(!i)throw new Error("Proje oluÅŸturulamadÄ±");return yield R("CREATE","projects",a.id,t.createdBy,null,i),i}catch(e){throw console.error("Create project error:",e),e}}),Et=(t,e,a)=>w(void 0,null,function*(){try{const i=yield Q(t);yield T(h(g,M,t),q(k({},e),{updatedAt:E()}));const o=yield Q(t);a&&(yield R("UPDATE","projects",t,a,i,o))}catch(i){throw console.error("Update project error:",i),i}}),At=(t,e)=>w(void 0,null,function*(){try{const a=yield Q(t),i=yield it({projectId:t});yield Promise.all(i.map(o=>nt(o.id,e))),yield Y(h(g,M,t)),e&&(yield R("DELETE","projects",t,e,a,null))}catch(a){throw console.error("Delete project error:",a),a}}),ee=Object.freeze(Object.defineProperty({__proto__:null,createProject:vt,deleteProject:At,getProjectById:Q,getProjects:kt,updateProject:Et},Symbol.toStringTag,{value:"Module"})),it=t=>w(void 0,null,function*(){var e,a,i,o,r;try{const n=b(g,"tasks"),s=l=>{const u=[];return l!=null&&l.skipOrder||u.push(C("createdAt","desc")),t!=null&&t.createdBy&&u.push(D("createdBy","==",t.createdBy)),t!=null&&t.status&&u.push(D("status","==",t.status)),t!=null&&t.projectId&&u.push(D("projectId","==",t.projectId)),t!=null&&t.productionOrderId&&u.push(D("productionOrderId","==",t.productionOrderId)),t!=null&&t.approvalStatus&&u.push(D("approvalStatus","==",t.approvalStatus)),u.push(F(500)),u.length?$(n,...u):$(n,F(500))};let d;try{d=yield U(s())}catch(l){if(typeof(l==null?void 0:l.message)=="string"&&l.message.includes("requires an index"))console.warn("âš ï¸ Firestore index gerekiyor, sÄ±ralama olmadan gÃ¶revler getiriliyor. Index linki:",((e=l.message.match(/https:\/\/[^\s]+/))==null?void 0:e[0])||"â€“"),d=yield U(s({skipOrder:!0}));else throw l}let c=d.docs.map(l=>k({id:l.id},l.data()));if(t!=null&&t.projectId&&(c=c.filter(l=>l.projectId===t.projectId&&l.projectId!==null&&l.projectId!==void 0).sort((l,u)=>{const m=l.createdAt instanceof G?l.createdAt.toMillis():0;return(u.createdAt instanceof G?u.createdAt.toMillis():0)-m})),t!=null&&t.assignedTo)c=(yield Promise.all(c.map(u=>w(void 0,null,function*(){return u.isPrivate?u.createdBy===t.assignedTo||(yield z(u.id)).some(v=>v.assignedTo===t.assignedTo&&v.status!=="rejected")?u:null:(yield z(u.id)).some(p=>p.assignedTo===t.assignedTo&&p.status!=="rejected")?u:null})))).filter(u=>u!==null);else{const l=(i=(a=j)==null?void 0:a.currentUser)==null?void 0:i.uid;l?c=yield Promise.all(c.map(u=>w(void 0,null,function*(){return u.onlyInMyTasks?u.createdBy===l?u:null:!u.isPrivate||u.createdBy===l||(yield z(u.id)).some(p=>p.assignedTo===l)?u:null}))).then(u=>u.filter(m=>m!==null)):c=c.filter(u=>!u.onlyInMyTasks)}return c}catch(n){throw console.error("Get tasks error:",n),X(n)?J(n,{operation:"read",collection:"tasks",userId:(r=(o=j)==null?void 0:o.currentUser)==null?void 0:r.uid}):n}}),Tt=(t={},e)=>{try{const a=b(g,"tasks");let o=(n=>{const s=[];return n!=null&&n.skipOrder||s.push(C("createdAt","desc")),t!=null&&t.createdBy&&s.push(D("createdBy","==",t.createdBy)),t!=null&&t.status&&s.push(D("status","==",t.status)),t!=null&&t.projectId&&s.push(D("projectId","==",t.projectId)),t!=null&&t.productionOrderId&&s.push(D("productionOrderId","==",t.productionOrderId)),t!=null&&t.approvalStatus&&s.push(D("approvalStatus","==",t.approvalStatus)),s.push(F(500)),s.length?$(a,...s):$(a,F(500))})();return Z(o,n=>w(void 0,null,function*(){var s,d;try{let c=n.docs.map(l=>k({id:l.id},l.data()));if(t!=null&&t.projectId&&(c=c.filter(l=>l.projectId===t.projectId&&l.projectId!==null&&l.projectId!==void 0).sort((l,u)=>{const m=l.createdAt instanceof G?l.createdAt.toMillis():0;return(u.createdAt instanceof G?u.createdAt.toMillis():0)-m})),t!=null&&t.assignedTo)c=(yield Promise.all(c.map(u=>w(void 0,null,function*(){return u.isPrivate?u.createdBy===t.assignedTo||(yield z(u.id)).some(v=>v.assignedTo===t.assignedTo&&v.status!=="rejected")?u:null:(yield z(u.id)).some(p=>p.assignedTo===t.assignedTo&&p.status!=="rejected")?u:null})))).filter(u=>u!==null);else{const l=(d=(s=j)==null?void 0:s.currentUser)==null?void 0:d.uid;l?c=yield Promise.all(c.map(u=>w(void 0,null,function*(){return u.onlyInMyTasks?u.createdBy===l?u:null:!u.isPrivate||u.createdBy===l||(yield z(u.id)).some(p=>p.assignedTo===l)?u:null}))).then(u=>u.filter(m=>m!==null)):c=c.filter(u=>!u.onlyInMyTasks)}e(c)}catch(c){console.error("Subscribe to tasks error:",c),e([])}}),n=>{var s,d,c;if((n==null?void 0:n.code)==="unavailable"||(n==null?void 0:n.code)==="not-found"||(s=n==null?void 0:n.message)!=null&&s.includes("404")||(d=n==null?void 0:n.message)!=null&&d.includes("network")||(c=n==null?void 0:n.message)!=null&&c.includes("transport errored")){e([]);return}e([])})}catch(a){return console.error("Subscribe to tasks setup error:",a),()=>{}}},B=t=>w(void 0,null,function*(){var e,a;try{const i=yield N(h(g,"tasks",t));return i.exists()?k({id:i.id},i.data()):null}catch(i){throw console.error("Get task by id error:",i),X(i)?J(i,{operation:"read",collection:"tasks",documentId:t,userId:(a=(e=j)==null?void 0:e.currentUser)==null?void 0:a.uid}):i}}),_t=t=>w(void 0,null,function*(){try{const e=q(k({},t),{createdAt:E(),updatedAt:E()});t.dueDate!==void 0&&t.dueDate!==null?t.dueDate instanceof Date?e.dueDate=G.fromDate(t.dueDate):typeof t.dueDate=="string"&&(e.dueDate=G.fromDate(new Date(t.dueDate))):e.dueDate=null;const a=yield L(b(g,"tasks"),e),i=yield B(a.id);if(!i)throw new Error("GÃ¶rev oluÅŸturulamadÄ±");yield R("CREATE","tasks",a.id,t.createdBy,null,i);try{const o=yield tt(i),{createNotification:r}=yield x(()=>w(void 0,null,function*(){const{createNotification:c}=yield Promise.resolve().then(()=>W);return{createNotification:c}}),void 0),{getUserProfile:n}=yield x(()=>w(void 0,null,function*(){const{getUserProfile:c}=yield import("./index-BQmY0BmM.js").then(l=>l.bc);return{getUserProfile:c}}),__vite__mapDeps([0,1,2])),s=yield n(t.createdBy),d=(s==null?void 0:s.fullName)||(s==null?void 0:s.displayName)||(s==null?void 0:s.email)||"Bir kullanÄ±cÄ±";yield Promise.all(o.map(c=>w(void 0,null,function*(){try{if(c===t.createdBy)return;yield r({userId:c,type:"task_created",title:"Yeni gÃ¶rev oluÅŸturuldu",message:`${d} "${i.title}" adlÄ± yeni bir gÃ¶rev oluÅŸturdu.`,read:!1,relatedId:a.id,metadata:{createdBy:t.createdBy}})}catch(l){console.error("Error sending task creation notification to team leader:",c,l)}})))}catch(o){console.error("Error sending task creation notifications:",o)}return i}catch(e){throw console.error("Create task error:",e),X(e)?J(e,{operation:"create",collection:"tasks",userId:t.createdBy,data:t}):e}}),tt=t=>w(void 0,null,function*(){if(!t)return[];try{const e=yield pt(),a=[];if(t.createdBy){const i=yield O(t.createdBy);if(i!=null&&i.approvedTeams&&i.approvedTeams.length>0)for(const o of i.approvedTeams){const r=e.find(n=>n.id===o);r!=null&&r.managerId&&!a.includes(r.managerId)&&a.push(r.managerId)}}if(t.projectId)try{const i=yield Q(t.projectId)}catch(i){console.error("Error fetching project:",i)}return a}catch(e){return console.error("Error getting team leaders:",e),[]}}),bt=(t,e,a)=>w(void 0,null,function*(){var i,o;try{const r=yield B(t),n=q(k({},e),{updatedAt:E()});e.dueDate!==void 0&&(e.dueDate===null?n.dueDate=null:e.dueDate instanceof Date&&(n.dueDate=G.fromDate(e.dueDate))),yield T(h(g,"tasks",t),n);const s=yield B(t);if(a&&(yield R("UPDATE","tasks",t,a,r,s)),s&&a)try{const d=yield z(t),l=(yield K()).find(m=>m.id===a),u=d.filter(m=>m.status==="accepted"||m.status==="pending").map(m=>m.assignedTo).filter(m=>m!==a);yield Promise.all(u.map(m=>w(void 0,null,function*(){try{yield S({userId:m,type:"task_updated",title:"GÃ¶rev gÃ¼ncellendi",message:`${(l==null?void 0:l.fullName)||(l==null?void 0:l.email)||"Bir kullanÄ±cÄ±"} "${s.title}" gÃ¶revinde deÄŸiÅŸiklik yaptÄ±.`,read:!1,relatedId:t,metadata:null})}catch(y){console.error("Error sending notification to user:",m,y)}})))}catch(d){console.error("Error sending task update notifications:",d)}}catch(r){throw console.error("Update task error:",r),X(r)?J(r,{operation:"update",collection:"tasks",documentId:t,userId:a||((o=(i=j)==null?void 0:i.currentUser)==null?void 0:o.uid),data:e}):r}}),Bt=(t,e)=>w(void 0,null,function*(){var a,i,o,r,n;try{const s=yield B(t);if(!s)throw new Error("GÃ¶rev bulunamadÄ±");const d=s.status,c=(i=(a=j)==null?void 0:a.currentUser)==null?void 0:i.uid,l={status:e,updatedAt:E()};if(d!==e&&c&&(l.statusUpdatedBy=c,l.statusUpdatedAt=E()),yield T(h(g,"tasks",t),l),yield R("UPDATE","tasks",t,((r=(o=j)==null?void 0:o.currentUser)==null?void 0:r.uid)||"system",{status:d},{status:e}),d!==e)try{const u=yield z(t),m=yield K(),y=(n=j)==null?void 0:n.currentUser,p=m.find(_=>_.id===(y==null?void 0:y.uid)),f={pending:"Beklemede",in_progress:"Devam Ediyor",completed:"TamamlandÄ±",cancelled:"Ä°ptal Edildi"},v=f[e]||e,P=f[d]||d;if(s.createdBy&&s.createdBy!==(y==null?void 0:y.uid))try{yield S({userId:s.createdBy,type:"task_updated",title:"GÃ¶rev durumu deÄŸiÅŸti",message:`${(p==null?void 0:p.fullName)||(p==null?void 0:p.email)||"Bir kullanÄ±cÄ±"} "${s.title}" gÃ¶revinin durumunu "${P}" â†’ "${v}" olarak deÄŸiÅŸtirdi.`,read:!1,relatedId:t,metadata:{oldStatus:d,newStatus:e}})}catch(_){console.error("Error sending notification to task creator:",_)}const A=u.filter(_=>(_.status==="accepted"||_.status==="pending")&&_.assignedTo!==(y==null?void 0:y.uid)).map(_=>_.assignedTo);yield Promise.all(A.map(_=>w(void 0,null,function*(){try{yield S({userId:_,type:"task_updated",title:"GÃ¶rev durumu deÄŸiÅŸti",message:`${(p==null?void 0:p.fullName)||(p==null?void 0:p.email)||"Bir kullanÄ±cÄ±"} "${s.title}" gÃ¶revinin durumunu "${P}" â†’ "${v}" olarak deÄŸiÅŸtirdi.`,read:!1,relatedId:t,metadata:{oldStatus:d,newStatus:e}})}catch(H){console.error("Error sending notification to assigned user:",_,H)}})))}catch(u){console.error("Error sending task status change notifications:",u)}}catch(s){throw console.error("Update task status error:",s),s}}),nt=(t,e)=>w(void 0,null,function*(){var a;try{const i=yield B(t);if(!i)throw new Error("GÃ¶rev bulunamadÄ±");let o=[],r=[],n;try{o=yield z(t),r=yield K(),n=r.find(s=>s.id===e)}catch(s){console.error("Error fetching data for notifications:",s)}yield Y(h(g,"tasks",t)),e&&(yield R("DELETE","tasks",t,e,i,null));try{const s=(a=j)==null?void 0:a.currentUser;if(i.createdBy&&i.createdBy!==(s==null?void 0:s.uid))try{yield S({userId:i.createdBy,type:"task_deleted",title:"GÃ¶rev silindi",message:`${(n==null?void 0:n.fullName)||(n==null?void 0:n.email)||"Bir kullanÄ±cÄ±"} "${i.title}" gÃ¶revini sildi.`,read:!1,relatedId:t,metadata:{taskTitle:i.title}})}catch(c){console.error("Error sending notification to task creator:",c)}const d=o.filter(c=>(c.status==="accepted"||c.status==="pending")&&c.assignedTo!==(s==null?void 0:s.uid)).map(c=>c.assignedTo);yield Promise.all(d.map(c=>w(void 0,null,function*(){try{yield S({userId:c,type:"task_deleted",title:"GÃ¶rev silindi",message:`${(n==null?void 0:n.fullName)||(n==null?void 0:n.email)||"Bir kullanÄ±cÄ±"} "${i.title}" gÃ¶revini sildi.`,read:!1,relatedId:t,metadata:{taskTitle:i.title}})}catch(l){console.error("Error sending notification to assigned user:",c,l)}})))}catch(s){console.error("Error sending task deletion notifications:",s)}}catch(i){throw console.error("Delete task error:",i),i}}),rt=(t,e,a,i)=>w(void 0,null,function*(){try{const o={taskId:t,assignedTo:e,assignedBy:a,status:"pending",notes:i||null,assignedAt:G.now(),acceptedAt:null,completedAt:null},r=yield L(b(g,"tasks",t,"assignments"),o),n=h(g,"tasks",t),s=yield N(n);if(s.exists()){const c=s.data().assignedUsers||[];c.includes(e)||(yield T(n,{assignedUsers:[...c,e]}))}try{const[d,c]=yield Promise.all([B(t),O(a)]);d&&(yield S({userId:e,type:"task_assigned",title:"Yeni gÃ¶rev atandÄ±",message:`${(c==null?void 0:c.fullName)||(c==null?void 0:c.email)||"Bir yÃ¶netici"} size "${d.title}" gÃ¶revini atadÄ±. Bildirim Ã¼zerinden kabul veya reddedebilirsiniz.`,read:!1,relatedId:t,metadata:{assignment_id:r.id}}))}catch(d){}return yield R("CREATE","task_assignments",r.id,a,null,o),k({id:r.id},o)}catch(o){throw console.error("Assign task error:",o),o}}),Dt=(t,e)=>w(void 0,null,function*(){var a,i;try{yield T(h(g,"tasks",t,"assignments",e),{status:"accepted",acceptedAt:E()});const o=yield B(t);yield R("UPDATE","task_assignments",e,((i=(a=j)==null?void 0:a.currentUser)==null?void 0:i.uid)||"system",{status:"pending"},{status:"accepted",taskId:t,taskTitle:o==null?void 0:o.title});try{const n=(yield N(h(g,"tasks",t,"assignments",e))).data();if(n){const{getNotifications:s}=yield x(()=>w(void 0,null,function*(){const{getNotifications:l}=yield Promise.resolve().then(()=>W);return{getNotifications:l}}),void 0),c=(yield s(n.assignedTo,{limit:100})).find(l=>{if(l.type!=="task_assigned"||l.relatedId!==t)return!1;const u=l.metadata;return u&&typeof u=="object"&&"assignment_id"in u?u.assignment_id===e:!1});if(c){const l=q(k({},c.metadata),{action:"accepted"});yield I(c.id,{metadata:l,read:!0})}}}catch(r){console.error("Error updating assignment notification:",r)}try{const r=yield B(t),s=(yield N(h(g,"tasks",t,"assignments",e))).data();if(r&&s){const d=yield tt(r),l=(yield K()).find(u=>u.id===s.assignedTo);yield Promise.all(d.map(u=>w(void 0,null,function*(){try{yield S({userId:u,type:"task_assigned",title:"GÃ¶rev kabul edildi",message:`${(l==null?void 0:l.fullName)||(l==null?void 0:l.email)||"Bir kullanÄ±cÄ±"} "${r.title}" gÃ¶revini kabul etti.`,read:!1,relatedId:t,metadata:{assignment_id:e,action:"accepted"}})}catch(m){console.error("Error sending notification to team leader:",u,m)}})))}}catch(r){console.error("Error sending acceptance notifications:",r)}}catch(o){throw console.error("Accept task assignment error:",o),o}}),jt=(t,e,a)=>w(void 0,null,function*(){var i,o,r,n,s,d;try{if(a.trim().length<20)throw new Error("Red sebebi en az 20 karakter olmalÄ±dÄ±r");yield T(h(g,"tasks",t,"assignments",e),{status:"rejected",rejectionReason:a.trim()});const c=yield B(t);yield R("UPDATE","task_assignments",e,((o=(i=j)==null?void 0:i.currentUser)==null?void 0:o.uid)||"system",{status:"pending"},{status:"rejected",rejectionReason:a.trim(),taskId:t,taskTitle:c==null?void 0:c.title});try{const u=(yield N(h(g,"tasks",t,"assignments",e))).data();if(u){const{getNotifications:m}=yield x(()=>w(void 0,null,function*(){const{getNotifications:f}=yield Promise.resolve().then(()=>W);return{getNotifications:f}}),void 0),p=(yield m(u.assignedTo,{limit:100})).find(f=>{if(f.type!=="task_assigned"||f.relatedId!==t)return!1;const v=f.metadata;return v&&typeof v=="object"&&"assignment_id"in v?v.assignment_id===e:!1});if(p){const f=q(k({},p.metadata),{action:"rejected"});yield I(p.id,{metadata:f,read:!0})}}}catch(l){console.error("Error updating assignment notification:",l)}try{const l=yield B(t),m=(yield N(h(g,"tasks",t,"assignments",e))).data();if(l&&m){const y=yield K(),p=y.find(A=>A.id===m.assignedTo),f=y.find(A=>A.id===l.createdBy),v=y.find(A=>A.id===m.assignedBy);if(m.assignedBy&&m.assignedBy!==((n=(r=j)==null?void 0:r.currentUser)==null?void 0:n.uid))try{yield S({userId:m.assignedBy,type:"task_assigned",title:"GÃ¶rev reddedildi",message:`${(p==null?void 0:p.fullName)||(p==null?void 0:p.email)||"Bir kullanÄ±cÄ±"} "${l.title}" gÃ¶revini reddetti. Sebep: ${a.trim().substring(0,100)}${a.trim().length>100?"...":""}`,read:!1,relatedId:t,metadata:{assignment_id:e,action:"rejected",reason:a.trim(),assigned_user_id:m.assignedTo}})}catch(A){console.error("Error sending notification to task assigner:",A)}if(l.createdBy&&l.createdBy!==((d=(s=j)==null?void 0:s.currentUser)==null?void 0:d.uid)&&l.createdBy!==m.assignedBy)try{yield S({userId:l.createdBy,type:"task_assigned",title:"GÃ¶rev reddedildi - OnayÄ±nÄ±z gerekiyor",message:`${(p==null?void 0:p.fullName)||(p==null?void 0:p.email)||"Bir kullanÄ±cÄ±"} "${l.title}" gÃ¶revini reddetti. Sebep: ${a.trim().substring(0,100)}${a.trim().length>100?"...":""}. LÃ¼tfen reddi onaylayÄ±n veya reddedin.`,read:!1,relatedId:t,metadata:{assignment_id:e,action:"rejection_pending_approval",reason:a.trim(),assigned_user_id:m.assignedTo}})}catch(A){console.error("Error sending notification to task creator:",A)}const P=yield tt(l);yield Promise.all(P.filter(A=>A!==l.createdBy&&A!==m.assignedBy).map(A=>w(void 0,null,function*(){try{yield S({userId:A,type:"task_assigned",title:"GÃ¶rev reddedildi",message:`${(p==null?void 0:p.fullName)||(p==null?void 0:p.email)||"Bir kullanÄ±cÄ±"} "${l.title}" gÃ¶revini reddetti. Sebep: ${a.trim().substring(0,100)}${a.trim().length>100?"...":""}`,read:!1,relatedId:t,metadata:{assignment_id:e,action:"rejected",reason:a.trim()}})}catch(_){console.error("Error sending notification to team leader:",A,_)}})))}}catch(l){console.error("Error sending rejection notifications:",l)}}catch(c){throw console.error("Reject task assignment error:",c),c}}),z=t=>w(void 0,null,function*(){try{return(yield U(b(g,"tasks",t,"assignments"))).docs.map(a=>k({id:a.id},a.data()))}catch(e){throw console.error("Get task assignments error:",e),e}}),Rt=(t,e,a)=>w(void 0,null,function*(){try{const i=h(g,"tasks",t,"assignments",e),o=yield N(i);if(!o.exists())return;const r=o.data();if(yield Y(i),r){const n=h(g,"tasks",t),s=yield N(n);if(s.exists()){const c=s.data().assignedUsers||[];c.includes(r.assignedTo)&&(yield T(n,{assignedUsers:c.filter(l=>l!==r.assignedTo)}))}if(r)try{const[d,c,l]=yield Promise.all([B(t),a?O(a):Promise.resolve(null),O(r.assignedTo)]);if(d&&l){const u=yield S({userId:r.assignedTo,type:"task_updated",title:"GÃ¶rev atamanÄ±z kaldÄ±rÄ±ldÄ±",message:`${(c==null?void 0:c.fullName)||(c==null?void 0:c.email)||"Bir yÃ¶netici"} sizi "${d.title}" gÃ¶revinden kaldÄ±rdÄ±.`,read:!1,relatedId:t,metadata:{assignment_id:e,action:"removed"}});if(d.createdBy&&d.createdBy!==a&&d.createdBy!==r.assignedTo){const m=yield S({userId:d.createdBy,type:"task_updated",title:"GÃ¶rev atamasÄ± kaldÄ±rÄ±ldÄ±",message:`${(c==null?void 0:c.fullName)||(c==null?void 0:c.email)||"Bir yÃ¶netici"} "${(l==null?void 0:l.fullName)||(l==null?void 0:l.email)||"bir kullanÄ±cÄ±"}" kullanÄ±cÄ±sÄ±nÄ± "${d.title}" gÃ¶revinden kaldÄ±rdÄ±.`,read:!1,relatedId:t,metadata:{assignment_id:e,action:"removed",removed_user_id:r.assignedTo}})}}}catch(d){}}}catch(i){throw i}}),Nt=(t,e,a)=>w(void 0,null,function*(){try{const i={taskId:t,title:e,items:a.map(r=>({id:`${Date.now()}-${Math.random()}`,text:r.text,completed:r.completed||!1,createdAt:G.now(),completedAt:null})),createdAt:G.now(),updatedAt:G.now()},o=yield L(b(g,"tasks",t,"checklists"),i);return k({id:o.id},i)}catch(i){throw console.error("Create checklist error:",i),i}}),$t=(t,e,a,i,o)=>w(void 0,null,function*(){var r,n;try{if(o){const u=yield B(t);if(!u)throw new Error("GÃ¶rev bulunamadÄ±");const{isAdmin:m,isMainAdmin:y}=yield x(()=>w(void 0,null,function*(){const{isAdmin:v,isMainAdmin:P}=yield import("./permissions-gaCIgPOa.js");return{isAdmin:v,isMainAdmin:P}}),__vite__mapDeps([3,4,0,1,2])),{getUserProfile:p}=yield x(()=>w(void 0,null,function*(){const{getUserProfile:v}=yield import("./index-BQmY0BmM.js").then(P=>P.bc);return{getUserProfile:v}}),__vite__mapDeps([0,1,2])),f=yield p(o);if(!(f&&(m(f)||y(f)))){if(!(yield z(t)).some(A=>A.assignedTo===o&&(A.status==="accepted"||A.status==="pending"))&&u.createdBy!==o)throw new Error("Checklist iÅŸaretleme yetkiniz yok. Sadece size atanan gÃ¶revlerin checklist'lerini iÅŸaretleyebilirsiniz.")}}const s=h(g,"tasks",t,"checklists",e),d=yield N(s);if(!d.exists())throw new Error("Checklist bulunamadÄ±");const l=d.data().items.map(u=>u.id===a?q(k({},u),{completed:i,completedAt:i?G.now():null}):u);yield T(s,{items:l,updatedAt:E()}),yield R("UPDATE","checklist_items",`${t}/${e}/${a}`,o||((n=(r=j)==null?void 0:r.currentUser)==null?void 0:n.uid)||"system",{completed:!i},{completed:i})}catch(s){throw console.error("Update checklist item error:",s),s}}),St=t=>w(void 0,null,function*(){try{return(yield U(b(g,"tasks",t,"checklists"))).docs.map(a=>k({id:a.id},a.data()))}catch(e){throw console.error("Get checklists error:",e),e}}),Pt=(t,e,a)=>w(void 0,null,function*(){try{const i=h(g,"tasks",t,"checklists",e),o=yield N(i);if(!o.exists())throw new Error("Checklist bulunamadÄ±");const r=o.data(),n={id:`${Date.now()}-${Math.random()}`,text:a,completed:!1,createdAt:G.now(),completedAt:null};yield T(i,{items:[...r.items,n],updatedAt:E()})}catch(i){throw console.error("Add checklist item error:",i),i}}),Ut=(t,e)=>w(void 0,null,function*(){try{yield Y(h(g,"tasks",t,"checklists",e))}catch(a){throw console.error("Delete checklist error:",a),a}}),Gt=(t,e,a)=>w(void 0,null,function*(){try{const i=h(g,"tasks",t,"checklists",e),o=yield N(i);if(!o.exists())throw new Error("Checklist bulunamadÄ±");const n=o.data().items.filter(s=>s.id!==a);yield T(i,{items:n,updatedAt:E()})}catch(i){throw console.error("Delete checklist item error:",i),i}}),zt=t=>w(void 0,null,function*(){try{return(yield U($(b(g,"tasks",t,"comments"),C("createdAt","desc")))).docs.map(a=>k({id:a.id},a.data()))}catch(e){throw console.error("Get task comments error:",e),e}}),qt=(t,e,a,i,o,r,n)=>w(void 0,null,function*(){try{const s={taskId:t,userId:e,userName:r,userEmail:n,action:a,description:i,metadata:o||{},createdAt:G.now()};return(yield L(b(g,"tasks",t,"activities"),s)).id}catch(s){return console.error("Add task activity error:",s),""}}),Ot=t=>w(void 0,null,function*(){try{return(yield U($(b(g,"tasks",t,"activities"),C("createdAt","desc")))).docs.map(a=>k({id:a.id},a.data()))}catch(e){throw console.error("Get task activities error:",e),e}}),Ct=(t,e)=>w(void 0,null,function*(){var a,i,o,r,n,s;try{const d=yield B(t);if(!d)throw new Error("GÃ¶rev bulunamadÄ±");const c=(i=(a=j)==null?void 0:a.currentUser)==null?void 0:i.uid;if(!c)throw new Error("KullanÄ±cÄ± oturumu bulunamadÄ±");const l=yield O(c);if(!l)throw new Error("KullanÄ±cÄ± profili bulunamadÄ±");if(!(((o=l.role)==null?void 0:o.includes("admin"))||((r=l.role)==null?void 0:r.includes("super_admin"))||((n=l.role)==null?void 0:n.includes("main_admin")))&&!(d.createdBy===c)&&!(yield z(t)).filter(_=>_.status==="accepted").map(_=>_.assignedTo).includes(c))throw new Error("Bu gÃ¶reve dosya eklemek iÃ§in yetkiniz yok. Sadece size atanan gÃ¶revlere veya oluÅŸturduÄŸunuz gÃ¶revlere dosya ekleyebilirsiniz.");const m=q(k({},e),{uploadedAt:E()}),y=yield L(b(g,"tasks",t,"attachments"),m),p=yield N(y);return q(k({id:y.id},p.data()),{uploadedAt:((s=p.data())==null?void 0:s.uploadedAt)||G.now()})}catch(d){throw console.error("Add task attachment error:",d),d}}),xt=t=>w(void 0,null,function*(){try{return(yield U($(b(g,"tasks",t,"attachments"),C("uploadedAt","desc")))).docs.map(a=>k({id:a.id},a.data()))}catch(e){throw console.error("Get task attachments error:",e),e}}),Mt=(t,e)=>w(void 0,null,function*(){var a,i,o,r,n;try{const s=yield B(t);if(!s)throw new Error("GÃ¶rev bulunamadÄ±");const d=(i=(a=j)==null?void 0:a.currentUser)==null?void 0:i.uid;if(!d)throw new Error("KullanÄ±cÄ± oturumu bulunamadÄ±");const c=yield O(d);if(!c)throw new Error("KullanÄ±cÄ± profili bulunamadÄ±");if(!(((o=c.role)==null?void 0:o.includes("admin"))||((r=c.role)==null?void 0:r.includes("super_admin"))||((n=c.role)==null?void 0:n.includes("main_admin")))&&!(s.createdBy===d)&&!(yield z(t)).filter(f=>f.status==="accepted").map(f=>f.assignedTo).includes(d))throw new Error("Bu gÃ¶revden dosya silmek iÃ§in yetkiniz yok. Sadece size atanan gÃ¶revlerden veya oluÅŸturduÄŸunuz gÃ¶revlerden dosya silebilirsiniz.");yield Y(h(g,"tasks",t,"attachments",e))}catch(s){throw console.error("Delete task attachment error:",s),s}}),Lt=(t,e)=>w(void 0,null,function*(){try{const a=h(g,"tasks",t),i=yield N(a);if(!i.exists())throw new Error("GÃ¶rev bulunamadÄ±");const o=i.data(),r=o.poolRequests||[];if(r.includes(e))throw new Error("Bu gÃ¶rev iÃ§in zaten talep yaptÄ±nÄ±z");yield T(a,{poolRequests:[...r,e],updatedAt:E()}),yield R("UPDATE","tasks",t,e,{poolRequests:r},{poolRequests:[...r,e]});const n=o.createdBy;if(n&&n!==e)try{const s=yield O(e),d=(s==null?void 0:s.fullName)||(s==null?void 0:s.displayName)||(s==null?void 0:s.email)||"Bir kullanÄ±cÄ±";yield S({userId:n,type:"task_pool_request",title:"GÃ¶rev Talebi",message:`${d} "${o.title}" gÃ¶revi iÃ§in talep gÃ¶nderdi.`,read:!1,metadata:{taskId:t,taskTitle:o.title,requestedBy:e,requestedByName:d,link:`/tasks/${t}`}})}catch(s){console.error("Bildirim gÃ¶nderme hatasÄ±:",s)}}catch(a){throw console.error("Request task from pool error:",a),a}}),Kt=(t,e,a,i=!1)=>w(void 0,null,function*(){try{const o=h(g,"tasks",t),r=yield N(o);if(!r.exists())throw new Error("GÃ¶rev bulunamadÄ±");const s=r.data().poolRequests||[];if(!s.includes(e))throw new Error("Bu kullanÄ±cÄ± iÃ§in talep bulunamadÄ±");yield rt(t,e,a);const d={poolRequests:s.filter(c=>c!==e),updatedAt:E()};i||(d.isInPool=!1,d.poolRequests=[]),yield T(o,d),yield R("UPDATE","tasks",t,a,{isInPool:!0,poolRequests:s},{isInPool:i,poolRequests:d.poolRequests,assignedTo:e})}catch(o){throw console.error("Approve pool request error:",o),o}}),Ft=(t,e)=>w(void 0,null,function*(){var a,i;try{const o=h(g,"tasks",t),r=yield N(o);if(!r.exists())throw new Error("GÃ¶rev bulunamadÄ±");const s=r.data().poolRequests||[];if(!s.includes(e))throw new Error("Bu kullanÄ±cÄ± iÃ§in talep bulunamadÄ±");yield T(o,{poolRequests:s.filter(d=>d!==e),updatedAt:E()}),yield R("UPDATE","tasks",t,((i=(a=j)==null?void 0:a.currentUser)==null?void 0:i.uid)||"system",{poolRequests:s},{poolRequests:s.filter(d=>d!==e),rejectedUser:e})}catch(o){throw console.error("Reject pool request error:",o),o}}),Qt=(t,e)=>w(void 0,null,function*(){var a,i,o;try{const r=yield B(t);if(!r)throw new Error("GÃ¶rev bulunamadÄ±");if(r.approvalStatus==="pending")return;if(r.approvalStatus==="approved")throw new Error("Bu gÃ¶rev zaten onaylanmÄ±ÅŸ.");const n=yield O(e);if(!n)throw new Error("KullanÄ±cÄ± profili bulunamadÄ±");if(!(((a=n.role)==null?void 0:a.includes("admin"))||((i=n.role)==null?void 0:i.includes("super_admin"))||((o=n.role)==null?void 0:o.includes("main_admin")))&&!(yield z(t)).filter(u=>u.status==="accepted").map(u=>u.assignedTo).includes(e))throw new Error("Bu gÃ¶revi onaya gÃ¶ndermek iÃ§in yetkiniz yok. Sadece size atanan gÃ¶revleri onaya gÃ¶nderebilirsiniz.");yield T(h(g,"tasks",t),{approvalStatus:"pending",approvalRequestedBy:e,updatedAt:E()}),yield R("UPDATE","tasks",t,e,{approvalStatus:r.approvalStatus||"none"},{approvalStatus:"pending"});try{if(r&&r.createdBy){const{getNotifications:d}=yield x(()=>w(void 0,null,function*(){const{getNotifications:u}=yield Promise.resolve().then(()=>W);return{getNotifications:u}}),void 0);(yield d(r.createdBy,{unreadOnly:!0})).some(u=>{var m;return u.type==="task_approval"&&u.relatedId===t&&((m=u.metadata)==null?void 0:m.action)==="approval_requested"})||(yield S({userId:r.createdBy,type:"task_approval",title:"GÃ¶rev onayÄ± bekleniyor",message:`${(n==null?void 0:n.fullName)||(n==null?void 0:n.email)||"Bir kullanÄ±cÄ±"} "${r.title}" gÃ¶revini tamamladÄ± ve onayÄ±nÄ±zÄ± bekliyor.`,read:!1,relatedId:t,metadata:{action:"approval_requested"}}))}}catch(d){console.error("Error sending approval request notification:",d)}}catch(r){throw console.error("Request task approval error:",r),r}}),Vt=(t,e)=>w(void 0,null,function*(){var a,i,o,r,n;try{const s=yield B(t);if(!s)throw new Error("GÃ¶rev bulunamadÄ±");if(s.approvalStatus==="approved")throw new Error("Bu gÃ¶rev zaten onaylanmÄ±ÅŸ. Tekrar onaylanamaz.");if(s.approvalStatus!=="pending")throw new Error("Bu gÃ¶rev onay beklenmiyor.");const d=yield O(e);if(!d)throw new Error("KullanÄ±cÄ± profili bulunamadÄ±");const c=((a=d.role)==null?void 0:a.includes("admin"))||((i=d.role)==null?void 0:i.includes("super_admin"))||((o=d.role)==null?void 0:o.includes("main_admin")),l=(r=d.role)==null?void 0:r.includes("team_leader"),u=s.createdBy===e;if(!c&&!(l&&u))throw new Error("Bu gÃ¶revi onaylamak iÃ§in yetkiniz yok. Sadece yÃ¶neticiler veya gÃ¶revi veren ekip liderleri onaylayabilir.");const m=s.status,y=(n=j)==null?void 0:n.currentUser;yield T(h(g,"tasks",t),{approvalStatus:"approved",status:"completed",approvedBy:e,approvedAt:E(),updatedAt:E()}),m!=="completed"&&(y!=null&&y.uid)&&(yield T(h(g,"tasks",t),{statusUpdatedBy:y.uid,statusUpdatedAt:E()})),yield R("UPDATE","tasks",t,e,{approvalStatus:"pending",status:m},{approvalStatus:"approved",status:"completed"});try{const p=yield B(t),f=yield O(e);if(p&&p.approvalRequestedBy){const{getNotifications:v}=yield x(()=>w(void 0,null,function*(){const{getNotifications:_}=yield Promise.resolve().then(()=>W);return{getNotifications:_}}),void 0);(yield v(p.approvalRequestedBy,{unreadOnly:!0})).some(_=>{var H;return _.type==="task_approval"&&_.relatedId===t&&((H=_.metadata)==null?void 0:H.action)==="approved"})||(yield S({userId:p.approvalRequestedBy,type:"task_approval",title:"GÃ¶rev onaylandÄ±",message:`${(f==null?void 0:f.fullName)||(f==null?void 0:f.email)||"YÃ¶netici"} "${p.title}" gÃ¶revini onayladÄ± ve tamamlandÄ± olarak iÅŸaretlendi.`,read:!1,relatedId:t,metadata:{action:"approved"}}))}}catch(p){console.error("Error sending approval notification:",p)}}catch(s){throw console.error("Approve task error:",s),s}}),Yt=(t,e,a)=>w(void 0,null,function*(){var i;try{const o=yield B(t);if(!o)throw new Error("GÃ¶rev bulunamadÄ±");const r=o.status,n=(i=j)==null?void 0:i.currentUser;yield T(h(g,"tasks",t),{approvalStatus:"rejected",status:"in_progress",rejectedBy:e,rejectedAt:E(),rejectionReason:a||null,updatedAt:E()}),r!=="in_progress"&&(n!=null&&n.uid)&&(yield T(h(g,"tasks",t),{statusUpdatedBy:n.uid,statusUpdatedAt:E()})),yield R("UPDATE","tasks",t,e,{approvalStatus:"pending",status:r},{approvalStatus:"rejected",status:"in_progress",rejectionReason:a});try{const s=yield B(t),d=yield O(e);if(s){const l=(yield z(t)).filter(y=>y.status!=="rejected").map(y=>y.assignedTo),u=new Set;l.forEach(y=>u.add(y)),s.createdBy&&!u.has(s.createdBy)&&u.add(s.createdBy),s.approvalRequestedBy&&!u.has(s.approvalRequestedBy)&&u.add(s.approvalRequestedBy);const m=a?`${(d==null?void 0:d.fullName)||(d==null?void 0:d.email)||"YÃ¶netici"} "${s.title}" gÃ¶revi iÃ§in tamamlanma onayÄ±nÄ± reddetti. Not: ${a}`:`${(d==null?void 0:d.fullName)||(d==null?void 0:d.email)||"YÃ¶netici"} "${s.title}" gÃ¶revi iÃ§in tamamlanma onayÄ±nÄ± reddetti.`;yield Promise.all(Array.from(u).map(y=>w(void 0,null,function*(){try{yield S({userId:y,type:"task_approval",title:"GÃ¶rev onayÄ± reddedildi",message:m,read:!1,relatedId:t,metadata:{action:"rejected",rejectionReason:a}})}catch(p){}})))}}catch(s){}}catch(o){throw console.error("Reject task approval error:",o),o}}),Wt=(t,e)=>w(void 0,null,function*(){var a,i;try{const o=(i=(a=j)==null?void 0:a.currentUser)==null?void 0:i.uid;if(!o)throw new Error("KullanÄ±cÄ± kimliÄŸi bulunamadÄ±");const r=h(g,"tasks",t,"assignments",e),n=yield N(r);if(!n.exists())throw new Error("GÃ¶rev atamasÄ± bulunamadÄ±");const s=n.data();if(s.status!=="rejected")throw new Error("GÃ¶rev reddedilmemiÅŸ");yield T(r,{rejectionApprovedBy:o,rejectionApprovedAt:E()});const d=yield B(t);yield R("UPDATE","task_assignments",e,o,{rejectionApprovedBy:null},{rejectionApprovedBy:o,taskId:t,taskTitle:d==null?void 0:d.title});try{const c=yield K(),l=c.find(m=>m.id===s.assignedTo),u=c.find(m=>m.id===o);l&&(yield S({userId:s.assignedTo,type:"task_assigned",title:"GÃ¶rev reddi onaylandÄ±",message:`${(u==null?void 0:u.fullName)||(u==null?void 0:u.email)||"YÃ¶netici"} "${d==null?void 0:d.title}" gÃ¶revi iÃ§in reddinizi onayladÄ±. GÃ¶rev artÄ±k baÅŸka birine atanabilir.`,read:!1,relatedId:t,metadata:{assignment_id:e,action:"rejection_approved"}}))}catch(c){console.error("Error sending approval notification:",c)}}catch(o){throw console.error("Approve task rejection error:",o),o}}),Ht=(t,e,a)=>w(void 0,null,function*(){var i,o;try{const r=(o=(i=j)==null?void 0:i.currentUser)==null?void 0:o.uid;if(!r)throw new Error("KullanÄ±cÄ± kimliÄŸi bulunamadÄ±");if(a.trim().length<20)throw new Error("Red sebebi en az 20 karakter olmalÄ±dÄ±r");const n=h(g,"tasks",t,"assignments",e),s=yield N(n);if(!s.exists())throw new Error("GÃ¶rev atamasÄ± bulunamadÄ±");const d=s.data();if(d.status!=="rejected")throw new Error("GÃ¶rev reddedilmemiÅŸ");yield T(n,{status:"pending",rejectionRejectedBy:r,rejectionRejectedAt:E(),rejectionRejectionReason:a.trim(),rejectionReason:null});const c=yield B(t);yield R("UPDATE","task_assignments",e,r,{status:"rejected"},{status:"pending",rejectionRejectedBy:r,rejectionRejectionReason:a.trim(),taskId:t,taskTitle:c==null?void 0:c.title});try{const l=yield K(),u=l.find(y=>y.id===d.assignedTo),m=l.find(y=>y.id===r);u&&(yield S({userId:d.assignedTo,type:"task_assigned",title:"GÃ¶rev reddi reddedildi",message:`${(m==null?void 0:m.fullName)||(m==null?void 0:m.email)||"YÃ¶netici"} "${c==null?void 0:c.title}" gÃ¶revi iÃ§in reddinizi reddetti. GÃ¶rev tekrar size atandÄ±. Not: ${a.trim().substring(0,100)}${a.trim().length>100?"...":""}`,read:!1,relatedId:t,metadata:{assignment_id:e,action:"rejection_rejected",reason:a.trim()}}))}catch(l){console.error("Error sending rejection notification:",l)}}catch(r){throw console.error("Reject task rejection error:",r),r}}),Jt=(t,e)=>w(void 0,null,function*(){try{yield T(h(g,"tasks",t),{isArchived:!0,updatedAt:E()}),yield R("UPDATE","tasks",t,e,{isArchived:!1},{isArchived:!0})}catch(a){throw console.error("Archive task error:",a),a}}),Xt=(t,e)=>w(void 0,null,function*(){try{yield T(h(g,"tasks",t),{isArchived:!1,updatedAt:E()}),yield R("UPDATE","tasks",t,e,{isArchived:!0},{isArchived:!1})}catch(a){throw console.error("Unarchive task error:",a),a}}),Zt=t=>w(void 0,null,function*(){try{const e=b(g,"tasks"),a=yield U(e);let i=V(g),o=0;const r=500;for(const c of a.docs){const l=c.data(),u=c.id,m=l.assignedUsers||[];if(m.includes(t)){const f=m.filter(A=>A!==t),v=f.length===0,P={assignedUsers:f};v&&(P.isInPool=!0,P.poolRequests=[]),i.update(c.ref,P),o++,o>=r&&(yield i.commit(),o=0,i=V(g))}const y=b(g,`tasks/${u}/assignments`),p=yield U($(y,D("assignedTo","==",t)));for(const f of p.docs)i.delete(f.ref),o++,o>=r&&(yield i.commit(),o=0,i=V(g))}o>0&&(yield i.commit());const n=yield U($(e,D("createdBy","==",t)));let s=V(g),d=0;for(const c of n.docs)s.update(c.ref,{createdBy:"deleted_user",createdByName:"SilinmiÅŸ KullanÄ±cÄ±"}),d++,d>=r&&(yield s.commit(),d=0,s=V(g));d>0&&(yield s.commit())}catch(e){throw console.error("Error removing user from tasks:",e),e}}),ae=Object.freeze(Object.defineProperty({__proto__:null,acceptTaskAssignment:Dt,addChecklistItem:Pt,addTaskActivity:qt,addTaskAttachment:Ct,approvePoolRequest:Kt,approveTask:Vt,approveTaskRejection:Wt,archiveTask:Jt,assignTask:rt,createChecklist:Nt,createTask:_t,deleteChecklist:Ut,deleteChecklistItem:Gt,deleteTask:nt,deleteTaskAssignment:Rt,deleteTaskAttachment:Mt,getChecklists:St,getTaskActivities:Ot,getTaskAssignments:z,getTaskAttachments:xt,getTaskById:B,getTaskComments:zt,getTasks:it,rejectPoolRequest:Ft,rejectTaskApproval:Yt,rejectTaskAssignment:jt,rejectTaskRejection:Ht,removeUserFromAllTasks:Zt,requestTaskApproval:Qt,requestTaskFromPool:Lt,subscribeToTasks:Tt,unarchiveTask:Xt,updateChecklistItem:$t,updateTask:bt,updateTaskStatus:Bt},Symbol.toStringTag,{value:"Module"}));export{Ut as A,Pt as B,$t as C,Gt as D,bt as E,S as F,Rt as G,rt as H,qt as I,Xt as J,_t as K,vt as L,Et as M,At as N,ht as O,yt as P,ft as Q,I as R,X as S,J as T,W as U,ee as V,ae as W,kt as a,it as b,z as c,nt as d,Jt as e,Qt as f,Q as g,B as h,Lt as i,Kt as j,Ft as k,zt as l,Ot as m,St as n,xt as o,Wt as p,Ht as q,jt as r,Tt as s,Dt as t,Bt as u,Ct as v,Mt as w,Vt as x,Yt as y,Nt as z};

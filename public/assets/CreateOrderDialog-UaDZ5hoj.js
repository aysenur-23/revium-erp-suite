const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/MainLayout-DW7UjMSA.js","assets/index-Xd90qdO9.js","assets/index-HS3kTX7E.css","assets/taskService-CQO0i9v5.js"])))=>i.map(i=>d[i]);
import{k as J,r as h,_ as U,b as y,j as e,C as W,c as X,d as Z,e as ee,w as c,R as g,V as f,S,p as C,q,s as T,t as o,L,B as $,T as R}from"./index-Xd90qdO9.js";import{g as re,D as te,a as se,b as ae,f as ne,c as ie,T as M,h as de}from"./MainLayout-DW7UjMSA.js";import{C as le}from"./CustomerCombobox-B9g9riZZ.js";const oe=d=>typeof d=="object"&&d!==null&&"toDate"in d&&typeof d.toDate=="function",ce=d=>{if(d instanceof Date)return d;if(d instanceof R)return d.toDate();if(typeof d=="string"){const u=new Date(d);if(!Number.isNaN(u.getTime()))return u}if(oe(d)){const u=d.toDate();if(u instanceof Date)return u}return new Date},xe=({open:d,onOpenChange:u,onSuccess:E})=>{var A;const{user:b}=J(),[k,v]=h.useState(!1),[N,w]=h.useState(!1),[t,l]=h.useState({order_number:"",product_name:"",product_id:"",quantity:"",unit:"Adet",customer_id:"",customer_name:"",due_date:"",priority:"0",status:"planned",notes:"",shipping_address:"",shipping_notes:""}),[n,p]=h.useState({}),[j,B]=h.useState([]),[D,F]=h.useState(!1),O=h.useCallback(async()=>{try{const r=new Date,s=r.getFullYear(),a=String(r.getMonth()+1).padStart(2,"0"),i=String(r.getDate()).padStart(2,"0"),{getOrders:m}=await U(async()=>{const{getOrders:x}=await import("./MainLayout-DW7UjMSA.js").then(_=>_.as);return{getOrders:x}},__vite__mapDeps([0,1,2,3])),K=await m(),Y=`${s}-${a}-${i}`,H=K.filter(x=>{const _=ce(x.createdAt);return`${_.getFullYear()}-${String(_.getMonth()+1).padStart(2,"0")}-${String(_.getDate()).padStart(2,"0")}`===Y}).length,Q=String(H+1).padStart(3,"0"),G=`PROD-${s}${a}${i}-${Q}`;l(x=>N&&x.order_number?x:{...x,order_number:G})}catch{const s=`PROD-${Date.now()}`;l(a=>N&&a.order_number?a:{...a,order_number:s})}},[N]),P=h.useCallback(async()=>{try{F(!0);const r=await re();B(r)}catch(r){console.error("Fetch products error:",r),y.error("Ürün listesi alınamadı. Lütfen sayfayı yenileyin.")}finally{F(!1)}},[]);h.useEffect(()=>{d&&(w(!1),O(),P())},[d,O,P]);const I=r=>{if(r==="none"||r===""){l(a=>({...a,product_id:"",product_name:""}));return}if(r==="manual"){l(a=>({...a,product_id:"manual",product_name:""}));return}const s=j.find(a=>a.id===r);s&&(l(a=>({...a,product_id:r,product_name:s.name})),n.product_name&&p(a=>{const{product_name:i,...m}=a;return m}))},V=r=>{l(s=>{if(s.product_id==="manual")return{...s,product_name:r};const a=j.find(m=>m.id===s.product_id),i=a&&a.name===r?s.product_id:"";return{...s,product_name:r,product_id:i}}),n.product_name&&p(s=>{const{product_name:a,...i}=s;return i})},z=async r=>{r.preventDefault();const s={};t.order_number.trim()||(s.order_number="Sipariş numarası zorunludur."),t.product_name.trim()||(s.product_name="Ürün adı zorunludur.");const a=Number(t.quantity);if((!t.quantity||Number.isNaN(a)||a<=0)&&(s.quantity="Miktar 0'dan büyük bir sayı olmalıdır."),t.due_date||(s.due_date="Termin tarihi zorunludur."),Object.keys(s).length>0){p(s);return}v(!0);try{if(!b){y.error("Oturumunuz sona erdi. Lütfen tekrar giriş yapın."),v(!1);return}const i=t.due_date?R.fromDate(new Date(t.due_date)):null,m=[{productId:t.product_id==="manual"?null:t.product_id||null,productName:t.product_name,quantity:a,unitPrice:0,total:0}];await de({orderNumber:t.order_number,order_number:t.order_number,customerId:t.customer_id||null,customer_id:t.customer_id||null,customerName:t.customer_name||null,customer_name:t.customer_name||null,status:t.status||"planned",totalAmount:0,total_amount:0,currency:"TRY",dueDate:i,due_date:t.due_date||null,notes:t.notes||null,itemsCount:a,totalQuantity:a,createdBy:b.id,created_by:b.id},m),y.success("Üretim siparişi başarıyla oluşturuldu"),E(),u(!1),l({order_number:"",product_name:"",product_id:"",quantity:"",unit:"Adet",customer_id:"",customer_name:"",due_date:"",priority:"0",status:"planned",notes:"",shipping_address:"",shipping_notes:""}),p({}),w(!1)}catch(i){console.error("Create production order error:",i);const m=i instanceof Error?i.message:"Sipariş oluşturulurken hata oluştu";y.error(m)}finally{v(!1)}};return e.jsx(te,{open:d,onOpenChange:u,children:e.jsx(se,{className:"!max-w-[100vw] sm:!max-w-[95vw] !w-[100vw] sm:!w-[95vw] !h-[100vh] sm:!h-[90vh] !max-h-[100vh] sm:!max-h-[90vh] !left-0 sm:!left-[2.5vw] !top-0 sm:!top-[5vh] !right-0 sm:!right-auto !bottom-0 sm:!bottom-auto !translate-x-0 !translate-y-0 overflow-hidden !p-0 gap-0 bg-white flex flex-col !m-0 !rounded-none sm:!rounded-lg !border-0 sm:!border",children:e.jsxs("div",{className:"flex flex-col h-full min-h-0",children:[e.jsx(ae,{className:"p-3 sm:p-4 border-b bg-white flex-shrink-0",children:e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3",children:[e.jsx("div",{className:"h-8 w-8 sm:h-10 sm:w-10 rounded-lg bg-primary/10 flex items-center justify-center border border-primary/20 flex-shrink-0",children:e.jsx(ne,{className:"h-4 w-4 sm:h-5 sm:w-5 text-primary"})}),e.jsx(ie,{className:"text-lg sm:text-xl font-semibold text-foreground truncate",children:"Yeni Üretim Siparişi"})]})}),e.jsx("div",{className:"flex-1 overflow-hidden bg-gray-50/50 p-3 sm:p-4 min-h-0",children:e.jsx("div",{className:"max-w-full mx-auto h-full overflow-y-auto",children:e.jsxs("form",{id:"production-order-create-form",onSubmit:z,className:"space-y-4 sm:space-y-6",children:[e.jsxs(W,{children:[e.jsx(X,{children:e.jsx(Z,{className:"text-lg",children:"Sipariş Bilgileri"})}),e.jsxs(ee,{className:"space-y-4 sm:space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"order_number",showRequired:!0,children:"Sipariş No"}),e.jsx(g,{id:"order_number",value:t.order_number,onChange:r=>{w(!0),l({...t,order_number:r.target.value}),n.order_number&&p(s=>{const{order_number:a,...i}=s;return i})},"aria-invalid":!!n.order_number,className:f(n.order_number&&"border-destructive focus-visible:ring-destructive","min-h-[44px] sm:min-h-0"),required:!0}),n.order_number&&e.jsx("p",{className:"text-sm text-destructive",children:n.order_number})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"status",children:"Durum"}),e.jsxs(S,{value:t.status||"planned",onValueChange:r=>l({...t,status:r}),children:[e.jsx(C,{className:"min-h-[44px] sm:min-h-0",children:e.jsx(q,{})}),e.jsxs(T,{children:[e.jsx(o,{value:"planned",children:"Planlanan"}),e.jsx(o,{value:"in_production",children:"Üretimde"}),e.jsx(o,{value:"quality_check",children:"Kalite Kontrol"}),e.jsx(o,{value:"completed",children:"Tamamlandı"}),e.jsx(o,{value:"on_hold",children:"Beklemede"})]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"customer_name",children:"Müşteri Adı"}),e.jsx(le,{value:t.customer_id,onChange:(r,s)=>l({...t,customer_id:r,customer_name:s}),placeholder:"Müşteri seçin veya ara..."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"product_name",showRequired:!0,children:"Ürün Adı"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(S,{value:t.product_id==="manual"?"manual":t.product_id||"none",onValueChange:I,disabled:D,children:[e.jsx(C,{className:f(n.product_name&&"border-destructive focus-visible:ring-destructive","min-h-[44px] sm:min-h-0"),children:e.jsx(q,{placeholder:D?"Ürünler yükleniyor...":"Ürün seçin (Opsiyonel)"})}),e.jsxs(T,{children:[e.jsx(o,{value:"none",children:"Ürün seçmeden devam et"}),j.map(r=>e.jsx(o,{value:r.id,children:r.name},r.id)),e.jsx(o,{value:"manual",children:"Diğer"})]})]}),D&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(L,{className:"h-4 w-4 animate-spin"})," Ürünler yükleniyor..."]}),e.jsx(g,{id:"product_name",placeholder:"Ürün adı girin (dropdown'dan seçebilir veya elle yazabilirsiniz)",value:t.product_name,onChange:r=>V(r.target.value),"aria-invalid":!!n.product_name,className:f(n.product_name&&"border-destructive focus-visible:ring-destructive","min-h-[44px] sm:min-h-0"),required:!0}),t.product_id&&t.product_id!=="manual"&&e.jsxs("p",{className:"text-xs text-muted-foreground flex items-center gap-1",children:[e.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-green-500"}),"Dropdown'dan seçili ürün: ",(A=j.find(r=>r.id===t.product_id))==null?void 0:A.name]})]}),n.product_name&&e.jsx("p",{className:"text-sm text-destructive",children:n.product_name})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"quantity",showRequired:!0,children:"Miktar"}),e.jsx(g,{id:"quantity",type:"number",value:t.quantity,onChange:r=>{l({...t,quantity:r.target.value}),n.quantity&&p(s=>{const{quantity:a,...i}=s;return i})},"aria-invalid":!!n.quantity,className:f(n.quantity&&"border-destructive focus-visible:ring-destructive","min-h-[44px] sm:min-h-0"),required:!0}),n.quantity&&e.jsx("p",{className:"text-sm text-destructive",children:n.quantity})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"unit",children:"Birim"}),e.jsxs(S,{value:t.unit,onValueChange:r=>l({...t,unit:r}),children:[e.jsx(C,{className:"min-h-[44px] sm:min-h-0",children:e.jsx(q,{})}),e.jsxs(T,{children:[e.jsx(o,{value:"Adet",children:"Adet"}),e.jsx(o,{value:"Kg",children:"Kg"}),e.jsx(o,{value:"Lt",children:"Lt"}),e.jsx(o,{value:"Mt",children:"Mt"}),e.jsx(o,{value:"M2",children:"M²"})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"due_date",showRequired:!0,children:"Termin Tarihi"}),e.jsx(g,{id:"due_date",type:"date",value:t.due_date,onChange:r=>{l({...t,due_date:r.target.value}),n.due_date&&p(s=>{const{due_date:a,...i}=s;return i})},"aria-invalid":!!n.due_date,className:f(n.due_date&&"border-destructive focus-visible:ring-destructive","min-h-[44px] sm:min-h-0"),required:!0}),n.due_date&&e.jsx("p",{className:"text-sm text-destructive",children:n.due_date})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"priority",children:"Öncelik (0-5)"}),e.jsx(g,{id:"priority",type:"number",min:"0",max:"5",value:t.priority,onChange:r=>l({...t,priority:r.target.value}),className:"min-h-[44px] sm:min-h-0"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"notes",className:"text-sm sm:text-base",children:"Notlar"}),e.jsx(M,{id:"notes",value:t.notes,onChange:r=>l({...t,notes:r.target.value}),rows:3,className:"min-h-[44px] sm:min-h-0",placeholder:"Sipariş ile ilgili notlar..."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{className:"text-sm sm:text-base",children:"Teslimat Bilgileri"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"shipping_address",className:"text-xs text-muted-foreground",children:"Teslimat Adresi"}),e.jsx(g,{id:"shipping_address",value:t.shipping_address||"",onChange:r=>l({...t,shipping_address:r.target.value}),className:"min-h-[44px] sm:min-h-0",placeholder:"Teslimat adresi..."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"shipping_notes",className:"text-xs text-muted-foreground",children:"Teslimat Notları"}),e.jsx(M,{id:"shipping_notes",value:t.shipping_notes||"",onChange:r=>l({...t,shipping_notes:r.target.value}),rows:2,className:"min-h-[44px] sm:min-h-0",placeholder:"Teslimat ile ilgili notlar..."})]})]})]})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row justify-end gap-2 pt-4 border-t",children:[e.jsx($,{type:"button",variant:"outline",onClick:()=>u(!1),className:"min-h-[44px] sm:min-h-0",children:"İptal"}),e.jsx($,{type:"submit",disabled:k,className:"min-h-[44px] sm:min-h-0",children:k?e.jsxs(e.Fragment,{children:[e.jsx(L,{className:"h-4 w-4 mr-2 animate-spin"}),"Oluşturuluyor..."]}):"Oluştur"})]})]})})})]})})})};export{xe as C};

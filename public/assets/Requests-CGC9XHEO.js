import{k as ce,r as i,j as e,B as b,X as de,L as le,C as F,c as V,d as H,e as P,w as x,S as K,p as X,q as W,s as J,t as g,R as _,g as me,b as d,T as ie,l as oe,m as xe,n as Q,aj as Z,i as re,ab as ne}from"./index-Xd90qdO9.js";import{D as he,a as ue,b as pe,W as je,c as ge,T as fe,M as ve,w as q,B as ee,C as ye}from"./MainLayout-DW7UjMSA.js";import{T as Ne,a as be,b as se,c as f,d as we,e as m}from"./table-CHpYTcky.js";import{c as Te,g as De,d as Ce,u as Se}from"./requestService-BZtc3QPN.js";import{a as ke}from"./currency-BpxR3_y8.js";import{S as Be}from"./save-Bgz0wbo5.js";import{A as Ae,a as Re,b as Me,c as ze,d as Oe,e as Le,f as Ee,g as Ye}from"./alert-dialog-BVp-ELLM.js";import{P as _e}from"./plus-D9uLCipi.js";import{T as Fe}from"./trash-2-DlZRXDqX.js";import{f as ae}from"./format-DuC-NjES.js";import"./taskService-CQO0i9v5.js";const Ve=({open:t,onOpenChange:w,onSuccess:T})=>{const{user:v}=ce(),[h,M]=i.useState(!1),[n,U]=i.useState("purchase"),[z,D]=i.useState(""),[C,S]=i.useState(""),[k,O]=i.useState(""),[u,L]=i.useState("TRY"),[B,y]=i.useState(""),[N,A]=i.useState(""),[c,p]=i.useState(""),[I,R]=i.useState([]);i.useEffect(()=>{t&&(async()=>{try{const G=(await me()).filter(j=>!j||!j.role?!1:(Array.isArray(j.role)?j.role:[j.role]).some(a=>a==="admin"||a==="super_admin"||a==="team_leader"||typeof a=="string"&&(a.includes("admin")||a.includes("team_leader"))));R(G)}catch(o){console.error("Yöneticiler yüklenemedi",o),d.error("Yöneticiler yüklenirken hata oluştu: "+(o.message||"Bilinmeyen hata")),R([])}})()},[t]);const E=async l=>{if(l&&l.preventDefault(),!!v){if(!z.trim()||!C.trim()||!c){d.error("Lütfen gerekli alanları doldurun.");return}M(!0);try{await Te({type:n,title:z,description:C,amount:k?parseFloat(k):void 0,currency:k?u:void 0,createdBy:v.id,assignedTo:c,startDate:B?ie.fromDate(new Date(B)):void 0,endDate:N?ie.fromDate(new Date(N)):void 0}),d.success("Talep başarıyla oluşturuldu"),T==null||T(),w(!1),D(""),S(""),O(""),y(""),A(""),p("")}catch(o){console.error("Request creation error:",o),d.error("Talep oluşturulamadı: "+o.message)}finally{M(!1)}}};return e.jsx(he,{open:t,onOpenChange:w,children:e.jsx(ue,{className:"!max-w-[100vw] sm:!max-w-[95vw] !w-[100vw] sm:!w-[95vw] !h-[100vh] sm:!h-[90vh] !max-h-[100vh] sm:!max-h-[90vh] !left-0 sm:!left-[2.5vw] !top-0 sm:!top-[5vh] !right-0 sm:!right-auto !bottom-0 sm:!bottom-auto !translate-x-0 !translate-y-0 overflow-hidden !p-0 gap-0 bg-white flex flex-col !m-0 !rounded-none sm:!rounded-lg !border-0 sm:!border",children:e.jsxs("div",{className:"flex flex-col h-full min-h-0",children:[e.jsx(pe,{className:"p-3 sm:p-4 border-b bg-white flex-shrink-0 relative pr-12 sm:pr-16",children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3 flex-1 min-w-0",children:[e.jsx("div",{className:"h-8 w-8 sm:h-10 sm:w-10 rounded-lg bg-primary/10 flex items-center justify-center border border-primary/20 flex-shrink-0",children:e.jsx(je,{className:"h-4 w-4 sm:h-5 sm:w-5 text-primary"})}),e.jsx(ge,{className:"text-lg sm:text-xl font-semibold text-foreground truncate",children:"Yeni Talep Oluştur"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 flex-shrink-0",children:[e.jsxs(b,{variant:"outline",size:"sm",className:"border-primary/20 hover:bg-primary/5 rounded-lg px-3 py-1.5 font-medium text-xs sm:text-sm flex-shrink-0",onClick:()=>w(!1),disabled:h,children:[e.jsx(de,{className:"h-3 w-3 sm:h-4 sm:w-4 mr-1.5 flex-shrink-0"}),"İptal"]}),e.jsxs(b,{variant:"default",size:"sm",className:"bg-primary hover:bg-primary/90 rounded-lg px-3 py-1.5 font-medium text-xs sm:text-sm flex-shrink-0 text-white",onClick:E,disabled:h,children:[h?e.jsx(le,{className:"h-3 w-3 sm:h-4 sm:w-4 mr-1.5 flex-shrink-0 animate-spin"}):e.jsx(Be,{className:"h-3 w-3 sm:h-4 sm:w-4 mr-1.5 flex-shrink-0"}),"Oluştur"]})]})]})}),e.jsx("div",{className:"flex-1 overflow-hidden bg-gray-50/50 p-3 sm:p-4 min-h-0",children:e.jsx("div",{className:"max-w-full mx-auto h-full overflow-y-auto",children:e.jsx("form",{onSubmit:E,className:"space-y-4 sm:space-y-6",children:e.jsxs(F,{children:[e.jsx(V,{children:e.jsx(H,{className:"text-base sm:text-lg",children:"Talep Bilgileri"})}),e.jsxs(P,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(x,{className:"text-sm sm:text-base",children:["Kime (Yönetici Seçimi) ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs(K,{value:c,onValueChange:p,children:[e.jsx(X,{className:"min-h-[44px] sm:min-h-0",children:e.jsx(W,{placeholder:"Yönetici seçin"})}),e.jsx(J,{children:I.map(l=>e.jsxs(g,{value:l.id,children:[l.fullName||l.displayName||l.email," (",l.role.includes("super_admin")?"Yönetici":l.role.includes("team_leader")?"Ekip Lideri":"Admin",")"]},l.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{className:"text-sm sm:text-base",children:"Talep Türü"}),e.jsxs(K,{value:n,onValueChange:U,children:[e.jsx(X,{className:"min-h-[44px] sm:min-h-0",children:e.jsx(W,{})}),e.jsxs(J,{children:[e.jsx(g,{value:"purchase",children:"Satın Alma Talebi"}),e.jsx(g,{value:"leave",children:"İzin Talebi"}),e.jsx(g,{value:"advance",children:"Avans Talebi"}),e.jsx(g,{value:"expense",children:"Masraf Bildirimi"}),e.jsx(g,{value:"other",children:"Diğer"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(x,{className:"text-sm sm:text-base",children:["Başlık ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(_,{placeholder:"Talebinizi özetleyin...",value:z,onChange:l=>D(l.target.value),className:"min-h-[44px] sm:min-h-0",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(x,{className:"text-sm sm:text-base",children:["Açıklama ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(fe,{placeholder:"Detaylı açıklama...",value:C,onChange:l=>S(l.target.value),rows:4,className:"min-h-[100px] sm:min-h-[120px]",required:!0})]}),(n==="purchase"||n==="advance"||n==="expense")&&e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4",children:[e.jsxs("div",{className:"sm:col-span-2 space-y-2",children:[e.jsx(x,{className:"text-sm sm:text-base",children:"Tutar"}),e.jsx(_,{type:"number",placeholder:"0.00",value:k,onChange:l=>O(l.target.value),min:"0",step:"0.01",className:"min-h-[44px] sm:min-h-0"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{className:"text-sm sm:text-base",children:"Para Birimi"}),e.jsxs(K,{value:u,onValueChange:L,children:[e.jsx(X,{className:"min-h-[44px] sm:min-h-0",children:e.jsx(W,{})}),e.jsx(J,{children:ke.map(l=>e.jsx(g,{value:l.value,children:l.label},l.value))})]})]})]}),n==="leave"&&e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{className:"text-sm sm:text-base",children:"Başlangıç Tarihi"}),e.jsx(_,{type:"date",value:B,onChange:l=>y(l.target.value),className:"min-h-[44px] sm:min-h-0"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{className:"text-sm sm:text-base",children:"Bitiş Tarihi"}),e.jsx(_,{type:"date",value:N,onChange:l=>A(l.target.value),className:"min-h-[44px] sm:min-h-0"})]})]})]})]})})})})]})})})},Ze=()=>{const{user:t,isAdmin:w,isTeamLeader:T,isSuperAdmin:v}=ce(),[h,M]=i.useState([]),[n,U]=i.useState({}),[z,D]=i.useState(!0),[C,S]=i.useState(!1),[k,O]=i.useState("my_requests"),[u,L]=i.useState(null),[B,y]=i.useState(!1),[N,A]=i.useState(null),c=w||T,p=async()=>{if(t){D(!0);try{const a={isSuperAdmin:v,createdBy:t.id,assignedTo:t.id},r=await De(a);M(r);const s=await me(),te={};s.forEach($=>te[$.id]=$.fullName||$.email),U(te)}catch(a){console.error("Fetch requests error:",a),d.error("Talepler yüklenirken hata oluştu")}finally{D(!1)}}};i.useEffect(()=>{t&&p()},[t]);const I=h.filter(a=>a.createdBy===(t==null?void 0:t.id)),R=c?h.filter(a=>(a.assignedTo===(t==null?void 0:t.id)||v)&&a.status==="pending"):[],E=c?h.filter(a=>(a.assignedTo===(t==null?void 0:t.id)||v)&&a.status!=="pending"):[],l=async(a,r)=>{if(t){L(a);try{let s="";r==="rejected"&&(s=prompt("Reddetme sebebi (isteğe bağlı):")||""),await Se(a,r,t.id,s),d.success(r==="approved"?"Talep onaylandı":"Talep reddedildi"),p()}catch(s){console.error("Update status error:",s),d.error("İşlem başarısız")}finally{L(null)}}},o=async()=>{if(N)try{await Ce(N),d.success("Talep silindi"),y(!1),A(null),p()}catch{d.error("Silme işlemi başarısız")}},G=a=>{switch(a){case"approved":return e.jsxs(ee,{className:"bg-emerald-500 hover:bg-emerald-600",children:[e.jsx(re,{className:"w-3 h-3 mr-1"})," Onaylandı"]});case"rejected":return e.jsxs(ee,{variant:"destructive",children:[e.jsx(ne,{className:"w-3 h-3 mr-1"})," Reddedildi"]});default:return e.jsxs(ee,{variant:"secondary",className:"bg-yellow-100 text-yellow-800 hover:bg-yellow-200",children:[e.jsx(ye,{className:"w-3 h-3 mr-1"})," Bekliyor"]})}},j=a=>({leave:"İzin",purchase:"Satın Alma",advance:"Avans",expense:"Masraf",other:"Diğer"})[a]||a,Y=(a,r=!1)=>e.jsx("div",{className:"rounded-md border overflow-x-auto -mx-4 sm:mx-0",children:e.jsx("div",{className:"inline-block min-w-full align-middle px-4 sm:px-0",children:e.jsxs(Ne,{className:"min-w-[600px]",children:[e.jsx(be,{children:e.jsxs(se,{children:[e.jsx(f,{children:"Tür"}),e.jsx(f,{children:"Başlık"}),e.jsx(f,{children:"Talep Eden"}),e.jsx(f,{children:"Tarih"}),e.jsx(f,{children:"Tutar/Detay"}),e.jsx(f,{children:"Durum"}),r&&e.jsx(f,{className:"text-right",children:"İşlemler"})]})}),e.jsx(we,{children:a.length===0?e.jsx(se,{children:e.jsx(m,{colSpan:r?7:6,className:"text-center py-8 text-muted-foreground",children:"Kayıt bulunamadı"})}):a.map(s=>e.jsxs(se,{children:[e.jsx(m,{className:"font-medium",children:j(s.type)}),e.jsx(m,{children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:s.title}),e.jsx("span",{className:"text-xs text-muted-foreground truncate max-w-[200px]",children:s.description})]})}),e.jsx(m,{children:n[s.createdBy]||"Bilinmiyor"}),e.jsx(m,{children:s.createdAt instanceof Object?ae(s.createdAt.toDate(),"d MMM yyyy",{locale:q}):"-"}),e.jsxs(m,{children:[s.amount?`${s.amount} ${s.currency}`:"-",s.startDate&&e.jsxs("div",{className:"text-xs text-muted-foreground",children:[ae(s.startDate.toDate(),"d MMM",{locale:q}),s.endDate?` - ${ae(s.endDate.toDate(),"d MMM",{locale:q})}`:""]})]}),e.jsx(m,{children:e.jsxs("div",{className:"flex flex-col gap-1",children:[G(s.status),s.rejectionReason&&e.jsx("span",{className:"text-[10px] text-red-500 max-w-[150px]",children:s.rejectionReason}),s.approvedBy&&e.jsxs("span",{className:"text-[10px] text-muted-foreground",children:["Onaylayan: ",n[s.approvedBy]]})]})}),r&&e.jsx(m,{className:"text-right",children:e.jsx("div",{className:"flex justify-end gap-2",children:s.status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx(b,{size:"sm",className:"bg-emerald-600 hover:bg-emerald-700 text-white min-h-[44px] min-w-[44px] sm:min-h-0 sm:min-w-0 sm:h-8 sm:w-8 p-0",onClick:()=>l(s.id,"approved"),disabled:!!u,children:u===s.id?e.jsx(le,{className:"w-4 h-4 animate-spin"}):e.jsx(re,{className:"w-4 h-4"})}),e.jsx(b,{size:"sm",variant:"destructive",className:"min-h-[44px] min-w-[44px] sm:min-h-0 sm:min-w-0 sm:h-8 sm:w-8 p-0",onClick:()=>l(s.id,"rejected"),disabled:!!u,children:u===s.id?e.jsx(le,{className:"w-4 h-4 animate-spin"}):e.jsx(ne,{className:"w-4 h-4"})})]})})}),!r&&s.createdBy===(t==null?void 0:t.id)&&s.status==="pending"&&e.jsx(m,{className:"text-right",children:e.jsx(b,{size:"sm",variant:"ghost",className:"h-8 w-8 p-0 text-muted-foreground hover:text-destructive",onClick:()=>{A(s.id),y(!0)},children:e.jsx(Fe,{className:"w-4 h-4"})})})]},s.id))})]})})});return e.jsx(ve,{children:e.jsxs("div",{className:"space-y-3 sm:space-y-4 md:space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h1",{className:"text-xl sm:text-2xl md:text-3xl font-bold tracking-tight",children:"Talep Yönetimi"}),e.jsx("p",{className:"text-muted-foreground mt-0.5 sm:mt-1 text-xs sm:text-sm",children:"İzin, satın alma ve diğer taleplerinizi yönetin."})]}),e.jsxs(b,{onClick:()=>S(!0),className:"w-full sm:w-auto min-h-[44px] sm:min-h-0 gap-2",children:[e.jsx(_e,{className:"h-4 w-4"}),"Yeni Talep"]})]}),e.jsxs(oe,{defaultValue:"my_requests",onValueChange:O,className:"w-full",children:[e.jsx("div",{className:"overflow-x-auto pb-2 -mx-4 px-4 sm:mx-0 sm:px-0 sm:pb-0",children:e.jsxs(xe,{className:"w-full sm:w-auto",children:[e.jsx(Q,{value:"my_requests",className:"min-h-[44px] sm:min-h-0",children:"Taleplerim"}),c&&e.jsxs(Q,{value:"incoming",className:"min-h-[44px] sm:min-h-0",children:["Gelen Talepler (",R.length,")"]}),c&&e.jsx(Q,{value:"history",className:"min-h-[44px] sm:min-h-0",children:"Talep Geçmişi"})]})}),e.jsx(Z,{value:"my_requests",className:"mt-4",children:e.jsxs(F,{children:[e.jsx(V,{children:e.jsx(H,{children:"Taleplerim"})}),e.jsx(P,{children:Y(I)})]})}),c&&e.jsxs(e.Fragment,{children:[e.jsx(Z,{value:"incoming",className:"mt-3 sm:mt-4",children:e.jsxs(F,{children:[e.jsx(V,{children:e.jsx(H,{children:"Onay Bekleyen Talepler"})}),e.jsx(P,{children:Y(R,!0)})]})}),e.jsx(Z,{value:"history",className:"mt-3 sm:mt-4",children:e.jsxs(F,{children:[e.jsx(V,{children:e.jsx(H,{children:"Tüm Talep Geçmişi"})}),e.jsx(P,{children:Y(E,!1)})]})})]})]}),e.jsx(Ve,{open:C,onOpenChange:S,onSuccess:p}),e.jsx(Ae,{open:B,onOpenChange:y,children:e.jsxs(Re,{children:[e.jsxs(Me,{children:[e.jsx(ze,{children:"Emin misiniz?"}),e.jsx(Oe,{children:"Bu talebi silmek istediğinize emin misiniz? Bu işlem geri alınamaz."})]}),e.jsxs(Le,{children:[e.jsx(Ee,{children:"İptal"}),e.jsx(Ye,{onClick:o,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Sil"})]})]})})]})})};export{Ze as default};

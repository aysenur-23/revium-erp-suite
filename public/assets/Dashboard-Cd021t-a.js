import{T as Z,a as ee,k as te,r as se,j as t,L as B,o as re,C as G,c as z,d as K,e as Q,K as ne}from"./index-Xd90qdO9.js";import{x as ae,y as oe,g as J,M as V,f as ce,P as ie,z as le,B as S,C as de}from"./MainLayout-DW7UjMSA.js";import{u as Y,S as N}from"./StatCard-Dh2Sp8Wp.js";import{b as X,a as ue}from"./taskService-CQO0i9v5.js";import{getSavedReports as me}from"./reportService-eZYvGhBr.js";import{g as xe}from"./materialService-fdlP1ZS7.js";import{T as U}from"./trending-up-DyiN6Ad2.js";import"./storageService-pEqhfEwa.js";import"./driveService-020R8zku.js";const O=(e,c)=>{if(isNaN(e)||isNaN(c))return 0;if(c===0)return e>0?100:0;const o=(e-c)/c*100;return isNaN(o)?0:o},ge=e=>typeof e=="object"&&e!==null&&"toDate"in e&&typeof e.toDate=="function",k=e=>{if(e instanceof Date)return e;if(e instanceof Z)return e.toDate();if(typeof e=="string"){const c=new Date(e);if(!Number.isNaN(c.getTime()))return c}if(ge(e)){const c=e.toDate();if(c instanceof Date)return c}return new Date},he=e=>typeof e=="object"&&e!==null,pe=e=>{if(!he(e))return 0;const c=e.grandTotal;if(typeof c=="number")return c;if(typeof c=="string"){const o=Number(c);return Number.isFinite(o)?o:0}return 0},fe=()=>Y({queryKey:["dashboard-stats"],queryFn:async()=>{let e=[];try{e=await me({reportType:"sales_quote"})}catch(r){console.warn("Sales quotes yüklenemedi, devam ediliyor:",r),e=[]}const[c,o,g,l]=await Promise.all([ae(),oe(),J(),X()]),u=new Date().getMonth(),j=u===0?11:u-1,h=new Date().getFullYear(),b=u===0?h-1:h,p=o.filter(r=>{const a=k(r.createdAt);return a.getMonth()===u&&a.getFullYear()===h}),M=o.filter(r=>{const a=k(r.createdAt);return a.getMonth()===j&&a.getFullYear()===b}),m=p.reduce((r,a)=>{const s=Number(a.totalAmount)||0;return r+(isNaN(s)?0:s)},0),f=M.reduce((r,a)=>{const s=Number(a.totalAmount)||0;return r+(isNaN(s)?0:s)},0),R=o.filter(r=>r.status!=="completed"&&r.status!=="cancelled"),w=g.filter(r=>{const a=r.stock||0,s=r.minStock||0;return a<=s}),T=o.slice(0,5).map(r=>({id:r.id,order_number:r.orderNumber||r.order_number||"",customer_name:r.customerName||r.customer_name||"",total:Number(r.totalAmount||r.total_amount||0)||0,order_date:k(r.createdAt).toISOString(),status:r.status})),A=c.filter(r=>{const a=k(r.createdAt);return a.getMonth()===u&&a.getFullYear()===h}),C=c.filter(r=>{const a=k(r.createdAt);return a.getMonth()===j&&a.getFullYear()===b}),F=g.filter(r=>{const a=k(r.createdAt);return a.getMonth()===u&&a.getFullYear()===h}),q=g.filter(r=>{const a=k(r.createdAt);return a.getMonth()===j&&a.getFullYear()===b}),L=(Array.isArray(e)?e:[]).reduce((r,a)=>{const s=pe(a.metadata);return r+s},0),y=new Set;e.forEach(r=>{if(r.metadata&&typeof r.metadata=="object"){const a=r.metadata.customerId;a&&typeof a=="string"&&y.add(a)}});const _=new Set;o.forEach(r=>{r.customerId&&_.add(r.customerId)});const D=y.size,$=Array.from(y).filter(r=>_.has(r)).length,I=D>0?$/D*100:0;return{customers:{total:c.length,trend:O(A.length,C.length)},orders:{total:o.length,active:R.length,trend:O(p.length,M.length)},products:{total_stock:g.reduce((r,a)=>{const s=Number(a.stock)||0;return r+(isNaN(s)?0:s)},0),low_stock_count:w.length,trend:O(F.length,q.length)},revenue:{current_month:m,trend:O(m,f)},recent_orders:T,low_stock_products:w.map(r=>({id:r.id,name:r.name,stock:r.stock||0,min_stock:r.minStock||0})),quotes:{total_amount:L,count:Array.isArray(e)?e.length:0},quote_conversion_rate:I}},refetchInterval:3e4,refetchOnWindowFocus:!0,refetchOnMount:!0,retry:2,retryDelay:5e3,staleTime:15e3}),Se=()=>{var T,A,C,F,q,L,y,_,D,$,I,P,r,a;const{data:e,isLoading:c}=fe(),o=ee(),{isAdmin:g,user:l}=te(),{data:u=[],isLoading:j}=Y({queryKey:["dashboard-tasks"],queryFn:async()=>{try{return await X()}catch(s){return console.error("Tasks yüklenirken hata:",s),[]}},refetchInterval:3e4,refetchOnWindowFocus:!0,staleTime:15e3}),{data:h=new Map,isLoading:b}=Y({queryKey:["dashboard-task-assignments",u.map(s=>s.id).join(",")],queryFn:async()=>{if(!(l!=null&&l.id)||u.length===0)return new Map;try{const s=new Map;return await Promise.all(u.map(async d=>{try{const x=await ue(d.id);s.set(d.id,x)}catch(x){console.error(`Task ${d.id} assignments yüklenirken hata:`,x),s.set(d.id,[])}})),s}catch(s){return console.error("Task assignments yüklenirken hata:",s),new Map}},enabled:u.length>0&&!!(l!=null&&l.id),refetchInterval:3e4,refetchOnWindowFocus:!0,staleTime:15e3}),{data:p=[],isLoading:M}=Y({queryKey:["dashboard-low-stock-items"],queryFn:async()=>{try{const[s,d]=await Promise.all([J(),xe()]),x=s.filter(n=>{const i=Number(n.stock)||0,v=Number(n.minStock)||0;return i===0||v>0&&i<v}).map(n=>({id:n.id,name:n.name,stock:n.stock||0,min_stock:n.minStock||0,type:"product",unit:n.unit||"Adet"})),H=d.filter(n=>{const i=Number(n.currentStock)||0,v=Number(n.minStock)||0;return i===0||v>0&&i<v}).map(n=>({id:n.id,name:n.name,stock:n.currentStock||0,min_stock:n.minStock||0,type:"rawMaterial",unit:n.unit||"Adet"}));return[...x,...H].sort((n,i)=>n.stock===0&&i.stock!==0?-1:n.stock!==0&&i.stock===0?1:n.stock-i.stock)}catch(s){return console.error("Düşük stoklu ürünler ve hammaddeler yüklenirken hata:",s),[]}},refetchInterval:2e4,refetchOnWindowFocus:!0,staleTime:1e4}),{overdueTasks:m,upcomingTasks:f,myTasksCount:R}=se.useMemo(()=>{const s=new Date;s.setHours(0,0,0,0);const d=new Date(s);d.setDate(d.getDate()+7);const x=u.filter(n=>!(l!=null&&l.id)||n.status==="completed"||n.status==="cancelled"||n.isArchived?!1:n.createdBy===l.id?!0:n.onlyInMyTasks?n.createdBy===l.id:!!(h.get(n.id)||[]).find(W=>W.assignedTo===l.id&&W.status==="accepted")),H=x.filter(n=>{if(!n.dueDate)return!1;const i=n.dueDate.toDate();return i.setHours(0,0,0,0),i<s}),E=x.filter(n=>{if(!n.dueDate)return!1;const i=n.dueDate.toDate();return i.setHours(0,0,0,0),i>=s&&i<=d});return{overdueTasks:H,upcomingTasks:E,myTasksCount:x.length}},[u,l==null?void 0:l.id,h]),w=c||j||b;return w?t.jsx(V,{children:t.jsx("div",{className:"flex items-center justify-center h-[60vh]",children:t.jsx(B,{className:"h-8 w-8 animate-spin text-primary"})})}):t.jsx(V,{children:t.jsxs("div",{className:"space-y-2 sm:space-y-3 md:space-y-4",children:[t.jsxs("div",{children:[t.jsx("h1",{className:"text-xl sm:text-2xl md:text-3xl font-bold text-foreground",children:"Dashboard"}),t.jsx("p",{className:"text-muted-foreground mt-0.5 sm:mt-1 text-xs sm:text-sm",children:"Hoş geldiniz, işte bugünkü özet"})]}),t.jsxs("div",{className:g?"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 sm:gap-6":"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6",children:[t.jsx(N,{title:"Toplam Müşteri",value:((T=e==null?void 0:e.customers)==null?void 0:T.total)!=null&&!isNaN(e.customers.total)?e.customers.total.toString():"0",icon:re,trend:{value:((A=e==null?void 0:e.customers)==null?void 0:A.trend)!==void 0&&!isNaN(e.customers.trend)?`${e.customers.trend>0?"+":""}${e.customers.trend.toFixed(1)}% bu ay`:"Veri yok",positive:(((C=e==null?void 0:e.customers)==null?void 0:C.trend)!=null&&!isNaN(e.customers.trend)?e.customers.trend:0)>=0},variant:"primary",onClick:()=>o("/customers"),clickable:!0}),t.jsx(N,{title:"Aktif Siparişler",value:((F=e==null?void 0:e.orders)==null?void 0:F.active)!=null&&!isNaN(e.orders.active)?e.orders.active.toString():"0",icon:ce,trend:{value:((q=e==null?void 0:e.orders)==null?void 0:q.trend)!==void 0&&!isNaN(e.orders.trend)?`${e.orders.trend>0?"+":""}${e.orders.trend.toFixed(1)}% bu ay`:"Veri yok",positive:(((L=e==null?void 0:e.orders)==null?void 0:L.trend)!=null&&!isNaN(e.orders.trend)?e.orders.trend:0)>=0},variant:"success",onClick:()=>o("/orders"),clickable:!0}),t.jsx(N,{title:"Ürün Stok",value:((y=e==null?void 0:e.products)==null?void 0:y.total_stock)!=null&&!isNaN(e.products.total_stock)?e.products.total_stock.toString():"0",icon:ie,trend:{value:(((_=e==null?void 0:e.products)==null?void 0:_.low_stock_count)||0)>0?`${e.products.low_stock_count} ürün düşük`:"Stoklar yeterli",positive:(((D=e==null?void 0:e.products)==null?void 0:D.low_stock_count)||0)===0},variant:"info",onClick:()=>o("/products"),clickable:!0}),t.jsx(N,{title:"Görevlerim",value:R.toString(),icon:le,trend:{value:`${m.length} gecikmiş, ${f.length} yaklaşan`,positive:m.length===0},variant:"primary",onClick:()=>o("/tasks?tab=my-tasks"),clickable:!0}),g&&t.jsx(N,{title:"Aylık Ciro",value:`₺${((($=e==null?void 0:e.revenue)==null?void 0:$.current_month)!=null&&!isNaN(e.revenue.current_month)?e.revenue.current_month:0).toLocaleString("tr-TR")}`,icon:U,trend:{value:((I=e==null?void 0:e.revenue)==null?void 0:I.trend)!==void 0&&!isNaN(e.revenue.trend)?`${e.revenue.trend>0?"+":""}${e.revenue.trend.toFixed(1)}% bu ay`:"Veri yok",positive:(((P=e==null?void 0:e.revenue)==null?void 0:P.trend)!=null&&!isNaN(e.revenue.trend)?e.revenue.trend:0)>=0},variant:"warning",onClick:()=>{o("/reports")},clickable:!0}),g&&(e==null?void 0:e.quote_conversion_rate)!==void 0&&t.jsx(N,{title:"Teklif Dönüşüm Oranı",value:`${e.quote_conversion_rate.toFixed(1)}%`,icon:U,trend:{value:`${((r=e.quotes)==null?void 0:r.count)??0} teklif, ${Math.round((((a=e.quotes)==null?void 0:a.count)??0)*(e.quote_conversion_rate/100))} sipariş`,positive:e.quote_conversion_rate>=50},variant:"info",onClick:()=>o("/reports"),clickable:!0})]}),t.jsxs("div",{className:"grid gap-4 sm:gap-6 grid-cols-1 lg:grid-cols-2",children:[t.jsxs(G,{children:[t.jsx(z,{children:t.jsx(K,{className:"text-lg sm:text-xl",children:"Son Siparişler"})}),t.jsx(Q,{children:!(e!=null&&e.recent_orders)||e.recent_orders.length===0?t.jsx("p",{className:"text-muted-foreground text-center py-8 text-sm sm:text-base",children:"Henüz sipariş yok"}):t.jsx("div",{className:"space-y-3 sm:space-y-4",children:(Array.isArray(e.recent_orders)?e.recent_orders:[]).map(s=>t.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 sm:gap-0 py-2 border-b last:border-0 cursor-pointer hover:bg-muted/50 rounded-lg px-2 transition-colors",onClick:()=>o("/orders"),children:[t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[t.jsx("p",{className:"font-medium truncate text-sm sm:text-base",children:s.order_number}),s.status&&t.jsx(S,{variant:s.status==="confirmed"||s.status==="in_progress"?"default":s.status==="completed"?"secondary":"outline",className:"text-xs",children:s.status==="confirmed"?"Onaylandı":s.status==="pending"?"Beklemede":s.status==="in_progress"?"İşlemde":s.status==="completed"?"Tamamlandı":s.status==="cancelled"?"İptal":s.status})]}),t.jsx("p",{className:"text-xs sm:text-sm text-muted-foreground truncate",children:s.customer_name})]}),t.jsxs("div",{className:"text-left sm:text-right sm:ml-4 flex-shrink-0",children:[t.jsxs("p",{className:"font-medium text-sm sm:text-base",children:["₺",(Number(s.total)||0).toLocaleString("tr-TR")]}),t.jsx("p",{className:"text-xs sm:text-sm text-muted-foreground",children:new Date(s.order_date).toLocaleDateString("tr-TR")})]})]},s.id))})})]}),t.jsxs(G,{children:[t.jsx(z,{children:t.jsx(K,{className:"text-lg sm:text-xl",children:"Gecikmiş ve Yaklaşan Görevler"})}),t.jsx(Q,{children:w?t.jsx("div",{className:"flex items-center justify-center py-8",children:t.jsx(B,{className:"h-6 w-6 animate-spin text-primary"})}):m.length===0&&f.length===0?t.jsx("p",{className:"text-muted-foreground text-center py-8 text-sm sm:text-base",children:"Gecikmiş veya yaklaşan görev yok"}):t.jsxs("div",{className:"space-y-4",children:[m.length>0&&t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[t.jsx(ne,{className:"h-4 w-4 text-destructive"}),t.jsxs("p",{className:"text-sm font-semibold text-destructive",children:["Gecikmiş (",m.length,")"]})]}),t.jsx("div",{className:"space-y-2",children:m.slice(0,5).map(s=>{var d;return t.jsxs("div",{className:"flex items-center justify-between p-2 rounded border border-destructive/20 bg-destructive/5 cursor-pointer hover:bg-destructive/10 transition-colors",onClick:()=>o(`/tasks/${s.id}`),children:[t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("p",{className:"font-medium text-sm truncate",children:s.title}),t.jsx("p",{className:"text-xs text-muted-foreground",children:(d=s.dueDate)==null?void 0:d.toDate().toLocaleDateString("tr-TR")})]}),t.jsx(S,{variant:"destructive",className:"text-xs",children:"Gecikmiş"})]},s.id)})})]}),f.length>0&&t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[t.jsx(de,{className:"h-4 w-4 text-warning"}),t.jsxs("p",{className:"text-sm font-semibold",children:["Yaklaşan (",f.length,")"]})]}),t.jsx("div",{className:"space-y-2",children:f.slice(0,5).map(s=>{var d;return t.jsxs("div",{className:"flex items-center justify-between p-2 rounded border border-warning/20 bg-warning/5 cursor-pointer hover:bg-warning/10 transition-colors",onClick:()=>o(`/tasks/${s.id}`),children:[t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("p",{className:"font-medium text-sm truncate",children:s.title}),t.jsx("p",{className:"text-xs text-muted-foreground",children:(d=s.dueDate)==null?void 0:d.toDate().toLocaleDateString("tr-TR")})]}),t.jsx(S,{variant:"outline",className:"text-xs",children:"Yaklaşan"})]},s.id)})})]})]})})]}),t.jsxs(G,{children:[t.jsx(z,{children:t.jsx(K,{className:"text-lg sm:text-xl",children:"Düşük Stoklu Ürünler ve Hammaddeler"})}),t.jsx(Q,{children:M?t.jsx("div",{className:"flex items-center justify-center py-8",children:t.jsx(B,{className:"h-6 w-6 animate-spin text-primary"})}):!p||p.length===0?t.jsx("p",{className:"text-muted-foreground text-center py-8 text-sm sm:text-base",children:"Düşük stoklu ürün veya hammadde yok"}):t.jsx("div",{className:"space-y-3 sm:space-y-4",children:(Array.isArray(p)?p:[]).map(s=>t.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 sm:gap-0 py-2 border-b last:border-0 hover:bg-muted/50 rounded-lg px-2 transition-colors cursor-pointer",onClick:()=>o(s.type==="rawMaterial"?"/raw-materials":"/products"),children:[t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("p",{className:"font-medium text-sm sm:text-base",children:s.name}),t.jsx(S,{variant:"outline",className:"text-xs",children:s.type==="rawMaterial"?"Hammadde":"Ürün"})]}),t.jsxs("p",{className:"text-xs sm:text-sm text-muted-foreground",children:["Min: ",s.min_stock," ",s.unit]})]}),t.jsx("div",{className:"text-left sm:text-right sm:ml-4 flex-shrink-0",children:t.jsxs(S,{variant:s.stock===0?"destructive":"secondary",className:"text-xs",children:[s.stock," ",s.unit]})})]},s.id))})})]})]})]})})};export{Se as default};

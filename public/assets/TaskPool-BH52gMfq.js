const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/taskService-CI62TrOj.js","assets/index-BQmY0BmM.js","assets/lucide-react-CAeuRJQk.js","assets/index-YbdY78QJ.css"])))=>i.map(i=>d[i]);
var Re=Object.defineProperty,_e=Object.defineProperties;var Ee=Object.getOwnPropertyDescriptors;var re=Object.getOwnPropertySymbols;var Me=Object.prototype.hasOwnProperty,Fe=Object.prototype.propertyIsEnumerable;var ne=(t,u,d)=>u in t?Re(t,u,{enumerable:!0,configurable:!0,writable:!0,value:d}):t[u]=d,k=(t,u)=>{for(var d in u||(u={}))Me.call(u,d)&&ne(t,d,u[d]);if(re)for(var d of re(u))Fe.call(u,d)&&ne(t,d,u[d]);return t},C=(t,u)=>_e(t,Ee(u));var j=(t,u,d)=>new Promise((w,z)=>{var G=x=>{try{S(d.next(x))}catch(A){z(A)}},D=x=>{try{S(d.throw(x))}catch(A){z(A)}},S=x=>x.done?w(x.value):Promise.resolve(x.value).then(G,D);S((d=d.apply(t,u)).next())});import{u as Ve,r as qe,_ as He,a as h,j as e,m as Ke,n as Ye,o as ie,B as b,C as $e,p as Je,q as We,S as le,c as oe,d as ce,e as de,f as E,b as Xe,L as Qe,T as Ze}from"./index-BQmY0BmM.js";import{r as m,m as Ue,P as es,U as me,k as ss,l as as,X as ts,n as rs}from"./lucide-react-CAeuRJQk.js";import{M as ue,B as I,D as K,a as Y,b as $,c as J,e as W,k as ns}from"./MainLayout-Dv9j77B5.js";import{S as is}from"./search-input-DCf0xYml.js";import{b as ls,a as os,i as cs,j as ds,k as ms,c as us,f as xs,u as hs}from"./taskService-CI62TrOj.js";import{A as ps,a as gs,b as fs,c as js,d as vs,e as ys,f as Ns}from"./alert-dialog-vDPnsgl6.js";import{T as xe}from"./TaskInlineForm-BjPlHrJk.js";import{C as bs}from"./checkbox-DKBysPlW.js";import{T as ws}from"./TaskBoard-BI6dI0L7.js";import"./storageService-BUAGZT8Z.js";import"./driveService-ChwQKMyd.js";import"./UserMultiSelect-BycFT8u0.js";import"./popover-Bq_PZ6uK.js";import"./avatar-CROuoa6p.js";import"./permissions-gaCIgPOa.js";import"./rolePermissionsService-BQ7cNajw.js";import"./format-CN3feEER.js";import"./isToday-imnuOj2q.js";import"./isSameDay-CbFR9PGK.js";import"./addDays-DpNspVkx.js";const Ks=()=>{var se;const{user:t,isAdmin:u,isTeamLeader:d,isSuperAdmin:w}=Ve(),[z,G]=m.useState(!0),[D,S]=m.useState([]),[x,A]=m.useState([]),[v,he]=m.useState({}),[pe,ge]=m.useState({}),[fe,M]=m.useState(!1),[c,X]=m.useState(null),[P,je]=m.useState(""),[L,ve]=m.useState("createdAt"),[ye,B]=m.useState(!1),[F,V]=m.useState(null),[Ne,be]=m.useState([]),[Q,we]=m.useState("list"),[Te,q]=m.useState("pending"),[ke,R]=m.useState(!1),[Z,Ce]=m.useState(null),[_,O]=m.useState({isOpen:!1,taskId:"",userId:"",userName:"",keepInPool:!1});m.useEffect(()=>{f()},[]),m.useEffect(()=>{Ie()},[D,P,L]);const f=()=>j(void 0,null,function*(){G(!0);try{const[s,a,r]=yield Promise.all([ls(),os(),qe()]),l=s.filter(i=>i.isInPool===!0&&!i.onlyInMyTasks);S(l);const n={};a.forEach(i=>{var g,N;i.id==="general"||((g=i.name)==null?void 0:g.toLowerCase())==="genel görevler"||((N=i.name)==null?void 0:N.toLowerCase())==="genel"||(n[i.id]=i)}),ge(n);const p=(yield Promise.all(a.map(i=>j(void 0,null,function*(){if(!i.isPrivate||u||w||d||t!=null&&t.id&&i.createdBy===t.id)return i;if(t!=null&&t.id)try{const{getTasks:g,getTaskAssignments:N}=yield He(()=>j(void 0,null,function*(){const{getTasks:T,getTaskAssignments:ae}=yield import("./taskService-CI62TrOj.js").then(te=>te.W);return{getTasks:T,getTaskAssignments:ae}}),__vite__mapDeps([0,1,2,3])),Le=yield g({projectId:i.id});for(const T of Le)if(T.createdBy===t.id||T.assignedUsers&&T.assignedUsers.includes(t.id)||(yield N(T.id)).some(H=>H.assignedTo===t.id&&(H.status==="accepted"||H.status==="pending")))return i}catch(g){console.error("Error checking project tasks:",g)}return null})))).filter(i=>{var g,N;return!(i===null||i.status!=="active"||i.id==="general"||((g=i.name)==null?void 0:g.toLowerCase())==="genel görevler"||((N=i.name)==null?void 0:N.toLowerCase())==="genel"||i.name==="Gizli Görevler"&&i.isPrivate===!0&&i.description==="Projesi olmayan gizli görevler için otomatik oluşturulan proje")});be(p);const y={};r.forEach(i=>{y[i.id]=i}),he(y)}catch(s){h.error("Görev havuzu yüklenirken hata: "+s.message)}finally{G(!1)}}),De=s=>j(void 0,null,function*(){if(!(t!=null&&t.id)){h.error("Kullanıcı bilgisi bulunamadı");return}try{yield cs(s,t.id),h.success("Görev talebi gönderildi"),f()}catch(a){h.error("Talep hatası: "+a.message)}}),Se=(s,a,r)=>{O({isOpen:!0,taskId:s,userId:a,userName:r,keepInPool:!1})},Ae=()=>j(void 0,null,function*(){const{taskId:s,userId:a,keepInPool:r}=_;if(t!=null&&t.id)try{if(yield ds(s,a,t.id,r),h.success("Görev talebi onaylandı"),c){const l=(c.poolRequests||[]).filter(p=>p!==a),n=[...c.assignedUsers||[],a],o=C(k({},c),{poolRequests:r?l:[],isInPool:r,assignedUsers:n});X(o)}O(l=>C(k({},l),{isOpen:!1})),f()}catch(l){h.error("Onaylama hatası: "+l.message)}}),Pe=(s,a)=>j(void 0,null,function*(){try{yield ms(s,a),h.success("Görev talebi reddedildi"),f()}catch(r){h.error("Reddetme hatası: "+r.message)}}),Be=s=>{X(s),M(!0)},U=s=>{Ce(s),R(!0)},Oe=(s,a)=>{if(s==="new"){a&&["pending","in_progress","completed"].includes(a)?q(a):q("pending"),B(!0);return}U(s)},Ie=()=>{let s=[...D];if(P.trim()){const a=P.toLocaleLowerCase("tr-TR");s=s.filter(r=>{var l,n;return(((l=r.title)==null?void 0:l.toLocaleLowerCase("tr-TR"))||"").includes(a)||(((n=r.description)==null?void 0:n.toLocaleLowerCase("tr-TR"))||"").includes(a)})}s.sort((a,r)=>{var l,n,o,p;if(L==="title")return(a.title||"").localeCompare(r.title||"");if(L==="dueDate"){const y=((l=a.dueDate)==null?void 0:l.toMillis())||0,i=((n=r.dueDate)==null?void 0:n.toMillis())||0;return y-i}else{const y=((o=a.createdAt)==null?void 0:o.toMillis())||0;return(((p=r.createdAt)==null?void 0:p.toMillis())||0)-y}}),A(s)},ee=u||d||w,ze=m.useMemo(()=>x.map(s=>{const a=n=>{if(!n)return null;if(n instanceof Ze||typeof(n==null?void 0:n.toDate)=="function")return n.toDate().toISOString();try{return new Date(n).toISOString()}catch(o){return null}};let r=[];if(Array.isArray(s.labels))r=s.labels.map(n=>typeof n=="string"?{name:n,color:"#61BD4F"}:n);else if(typeof s.labels=="string")try{const n=JSON.parse(s.labels);Array.isArray(n)&&(r=n.map(o=>typeof o=="string"?{name:o,color:"#61BD4F"}:o))}catch(n){r=[]}const l=(s.assignedUsers||[]).map(n=>{const o=v[n];return{assigned_to:n,assigned_to_name:(o==null?void 0:o.fullName)||(o==null?void 0:o.email)||"Kullanıcı",assigned_to_email:(o==null?void 0:o.email)||""}});return{id:s.id,title:s.title,description:s.description||"",status:s.status||"pending",priority:s.priority||0,due_date:a(s.dueDate),created_at:a(s.createdAt)||new Date().toISOString(),createdBy:s.createdBy,labels:r,assignments:l}}),[x,v]),Ge=(s,a)=>j(void 0,null,function*(){if(t)try{const r=a,l=D.find(p=>p.id===s);if(!l){h.error("Görev bulunamadı");return}if(!u&&!d&&!w&&!(yield us(s)).map(g=>g.assignedTo).includes(t.id)){h.error("Bu görevin durumunu değiştirme yetkiniz yok. Sadece size atanan görevlerin durumunu değiştirebilirsiniz.");return}const n=(l==null?void 0:l.createdBy)===t.id;if(r==="completed"&&!(u||d||w||n)){yield xs(s,t.id),h.success("Görev tamamlandı olarak işaretlendi ve onay için gönderildi."),f();return}yield hs(s,r),h.success("Görev durumu güncellendi"),f()}catch(r){console.error("Task pool status change error:",r),h.error(r.message||"Durum güncellenemedi")}});return z?e.jsx(ue,{children:e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(Ue,{className:"h-8 w-8 animate-spin text-primary"})})}):e.jsx(ue,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-foreground",children:"Görev Havuzu"}),e.jsx("p",{className:"text-muted-foreground mt-1 text-sm sm:text-base",children:"Henüz atanmamış görevleri görüntüleyin ve talep edin"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Ke,{value:Q,onValueChange:s=>we(s),children:e.jsxs(Ye,{children:[e.jsx(ie,{value:"list",children:"Liste"}),e.jsx(ie,{value:"board",children:"Pano"})]})}),ee&&e.jsxs(b,{onClick:()=>{q("pending"),B(!0)},children:[e.jsx(es,{className:"h-4 w-4 mr-2"}),"Havuza Görev Ekle"]})]})]}),e.jsxs($e,{children:[e.jsx(Je,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(me,{className:"h-5 w-5"}),e.jsx(We,{children:"Açık Görevler"})]}),e.jsxs(I,{variant:"secondary",children:[x.length," görev"]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-center gap-3",children:[e.jsx(is,{placeholder:"Görev ara...",value:P,onChange:s=>je(s.target.value),containerClassName:"flex-1 w-full"}),e.jsxs(le,{value:L,onValueChange:s=>ve(s),children:[e.jsx(oe,{className:"w-full sm:w-[180px]",children:e.jsx(ce,{placeholder:"Sırala"})}),e.jsxs(de,{children:[e.jsx(E,{value:"createdAt",children:"Yeni Önce"}),e.jsx(E,{value:"title",children:"Başlığa Göre"}),e.jsx(E,{value:"dueDate",children:"Bitiş Tarihine Göre"})]})]})]})]})}),e.jsx(Xe,{children:Q==="list"?x.length===0?e.jsx("div",{className:"text-center py-12 text-muted-foreground border-2 border-dashed rounded-xl",children:P?"Arama sonucu bulunamadı":"Görev havuzunda şu an açık görev yok."}):e.jsx("div",{className:"space-y-4",children:x.map(s=>{const a=s.poolRequests||[],r=(t==null?void 0:t.id)&&a.includes(t.id),l=s.createdBy===(t==null?void 0:t.id),n=s.dueDate?s.dueDate.toDate():null,o=s.projectId?pe[s.projectId]:null;return e.jsx("div",{className:"flex flex-col gap-4 p-4 rounded-lg border bg-card hover:bg-accent/5 transition-colors cursor-pointer",onClick:()=>U(s.id),children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-start justify-between gap-4",children:[e.jsxs("div",{className:"space-y-2 flex-1",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("h3",{className:"font-semibold text-lg",children:s.title}),o&&e.jsx(I,{variant:"secondary",className:"text-xs font-normal",children:o.name}),s.priority===5&&e.jsx(I,{variant:"destructive",className:"text-xs",children:"Kritik"})]}),s.description&&e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2",children:s.description}),e.jsxs("div",{className:"flex flex-wrap items-center gap-4 text-sm text-muted-foreground",children:[n&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ss,{className:"h-4 w-4"}),e.jsx("span",{children:n.toLocaleDateString("tr-TR")})]}),s.createdBy&&v[s.createdBy]&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(as,{className:"h-4 w-4"}),e.jsxs("span",{children:["Oluşturan: ",v[s.createdBy].fullName||v[s.createdBy].email||"Bilinmeyen"]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(me,{className:"h-4 w-4"}),e.jsxs("span",{children:[a.length," talep"]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 self-end sm:self-start",onClick:p=>p.stopPropagation(),children:[r?e.jsx(I,{variant:"outline",className:"bg-primary/10 text-primary border-primary/20",children:"Talep Gönderildi"}):e.jsx(b,{size:"sm",onClick:()=>De(s.id),disabled:a.includes((t==null?void 0:t.id)||""),children:"Görevi Talep Et"}),(ee||l)&&a.length>0&&e.jsx(b,{size:"sm",variant:"outline",onClick:()=>Be(s),children:"Talepleri Yönet"})]})]})},s.id)})}):e.jsx("div",{className:"-mx-4 sm:mx-0",children:e.jsx(ws,{tasks:ze,onTaskClick:Oe,onStatusChange:Ge})})})]}),e.jsx(ps,{open:fe,onOpenChange:M,children:e.jsxs(gs,{children:[e.jsxs(fs,{children:[e.jsx(js,{children:"Görev Taleplerini Yönet"}),e.jsxs(vs,{children:['"',c==null?void 0:c.title,'" görevi için gelen talepleri onaylayın veya reddedin.']})]}),e.jsxs("div",{className:"py-4 space-y-4 max-h-[60vh] overflow-y-auto",children:[(c==null?void 0:c.assignedUsers)&&c.assignedUsers.length>0&&e.jsxs("div",{className:"mb-4",children:[e.jsx("h4",{className:"text-sm font-medium text-muted-foreground mb-2",children:"Atanan Kullanıcılar"}),e.jsx("div",{className:"space-y-2",children:c.assignedUsers.map(s=>{var r,l;const a=v[s];return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 border border-green-100 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-green-100 flex items-center justify-center text-green-700 font-semibold text-sm",children:((r=a==null?void 0:a.fullName)==null?void 0:r.charAt(0))||((l=a==null?void 0:a.email)==null?void 0:l.charAt(0))||"?"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-green-900",children:(a==null?void 0:a.fullName)||"Bilinmeyen Kullanıcı"}),e.jsx("div",{className:"text-xs text-green-700",children:a==null?void 0:a.email})]})]}),e.jsx(I,{className:"bg-green-100 text-green-800 hover:bg-green-100 border-green-200",children:"Onaylandı"})]},`assigned-${s}`)})})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-muted-foreground mb-2",children:"Bekleyen Talepler"}),e.jsxs("div",{className:"space-y-2",children:[(se=c==null?void 0:c.poolRequests)==null?void 0:se.map(s=>{var r,l;const a=v[s];return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center text-primary font-semibold text-sm",children:((r=a==null?void 0:a.fullName)==null?void 0:r.charAt(0))||((l=a==null?void 0:a.email)==null?void 0:l.charAt(0))||"?"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:(a==null?void 0:a.fullName)||"Bilinmeyen Kullanıcı"}),e.jsx("div",{className:"text-xs text-muted-foreground",children:a==null?void 0:a.email})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(b,{size:"icon",variant:"ghost",className:"h-8 w-8 text-destructive hover:text-destructive hover:bg-destructive/10",onClick:()=>Pe(c.id,s),children:e.jsx(ts,{className:"h-4 w-4"})}),e.jsx(b,{size:"icon",variant:"ghost",className:"h-8 w-8 text-green-600 hover:text-green-600 hover:bg-green-50",onClick:()=>Se(c.id,s,(a==null?void 0:a.fullName)||"Kullanıcı"),children:e.jsx(rs,{className:"h-4 w-4"})})]})]},`request-${s}`)}),(!(c!=null&&c.poolRequests)||c.poolRequests.length===0)&&e.jsx("div",{className:"text-center text-muted-foreground py-4 bg-muted/30 rounded-lg border border-dashed",children:"Henüz bekleyen talep yok."})]})]})]}),e.jsx(ys,{children:e.jsx(Ns,{onClick:()=>M(!1),children:"Kapat"})})]})}),e.jsx(K,{open:_.isOpen,onOpenChange:s=>O(a=>C(k({},a),{isOpen:s})),children:e.jsxs(Y,{children:[e.jsxs($,{children:[e.jsx(J,{children:"Onaylama İşlemi"}),e.jsxs(W,{children:[_.userName," kullanıcısının talebini onaylamak üzeresiniz."]})]}),e.jsxs("div",{className:"py-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(bs,{id:"keepInPool",checked:_.keepInPool,onCheckedChange:s=>O(a=>C(k({},a),{keepInPool:s}))}),e.jsx("label",{htmlFor:"keepInPool",className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 cursor-pointer",children:"Görevi havuzda tut (Diğer kişiler de talep edebilir)"})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Eğer işaretlemezseniz, görev havuzdan kaldırılacak ve sadece atanan kullanıcıya görünecektir."})]}),e.jsxs(ns,{children:[e.jsx(b,{variant:"outline",onClick:()=>O(s=>C(k({},s),{isOpen:!1})),children:"İptal"}),e.jsx(b,{onClick:Ae,children:"Onayla"})]})]})}),e.jsx(K,{open:ye,onOpenChange:B,children:e.jsxs(Y,{className:"max-w-4xl w-[95vw] overflow-y-auto max-h-[90vh]",children:[e.jsxs($,{children:[e.jsx(J,{children:"Havuza Görev Ekle"}),e.jsx(W,{children:"Görev havuzuna yeni bir görev ekleyin. Bu göreve uygun ekip üyeleri başvurabilir."})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx(Qe,{htmlFor:"project-select",children:"Proje Seçimi *"}),e.jsxs(le,{value:F||"",onValueChange:V,children:[e.jsx(oe,{id:"project-select",className:"mt-1",children:e.jsx(ce,{placeholder:"Bir proje seçin..."})}),e.jsx(de,{children:Ne.map(s=>e.jsx(E,{value:s.id,children:s.name},s.id))})]})]}),F?e.jsx(xe,{mode:"create",projectId:F,defaultStatus:Te,onCancel:()=>{B(!1),V(null)},onSuccess:()=>{B(!1),V(null),f()},className:"border-0 shadow-none p-0",isInPool:!0}):e.jsx("div",{className:"text-center py-8 text-muted-foreground border-2 border-dashed rounded-lg",children:"Lütfen devam etmek için bir proje seçin."})]})}),e.jsx(K,{open:ke,onOpenChange:R,children:e.jsxs(Y,{className:"max-w-4xl w-[95vw] overflow-y-auto max-h-[90vh]",children:[e.jsxs($,{children:[e.jsx(J,{children:"Görev Detayı"}),e.jsx(W,{children:"Görevi inceleyin ve talep oluşturun."})]}),Z&&e.jsx(xe,{mode:"edit",projectId:null,taskId:Z,onCancel:()=>R(!1),onSuccess:()=>{f(),R(!1)},className:"border-0 shadow-none p-0"})]})})]})})};export{Ks as default};

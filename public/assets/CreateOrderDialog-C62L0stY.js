const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/MainLayout-Dv9j77B5.js","assets/index-BQmY0BmM.js","assets/lucide-react-CAeuRJQk.js","assets/index-YbdY78QJ.css","assets/taskService-CI62TrOj.js"])))=>i.map(i=>d[i]);
var Z=Object.defineProperty,ee=Object.defineProperties;var te=Object.getOwnPropertyDescriptors;var F=Object.getOwnPropertySymbols;var re=Object.prototype.hasOwnProperty,se=Object.prototype.propertyIsEnumerable;var z=(n,d,o)=>d in n?Z(n,d,{enumerable:!0,configurable:!0,writable:!0,value:o}):n[d]=o,j=(n,d)=>{for(var o in d||(d={}))re.call(d,o)&&z(n,o,d[o]);if(F)for(var o of F(d))se.call(d,o)&&z(n,o,d[o]);return n},x=(n,d)=>ee(n,te(d));var $=(n,d,o)=>new Promise((N,v)=>{var D=a=>{try{y(o.next(a))}catch(l){v(l)}},S=a=>{try{y(o.throw(a))}catch(l){v(l)}},y=a=>a.done?N(a.value):Promise.resolve(a.value).then(D,S);y((o=o.apply(n,d)).next())});import{u as ae,_ as ne,a as b,j as e,L as _,I,l as w,B as O,C as de,S as R,c as B,d as V,e as Y,f,T as H}from"./index-BQmY0BmM.js";import{r as p,P as oe,T as ce,m as ue,o as ie}from"./lucide-react-CAeuRJQk.js";import{l as le,D as me,a as pe,b as he,c as _e,e as je,T as xe,k as ge,m as fe}from"./MainLayout-Dv9j77B5.js";import{C as ye}from"./CustomerCombobox-LwAUFZox.js";const be=n=>typeof n=="object"&&n!==null&&"toDate"in n&&typeof n.toDate=="function",Ne=n=>{if(n instanceof Date)return n;if(n instanceof H)return n.toDate();if(typeof n=="string"){const d=new Date(n);if(!Number.isNaN(d.getTime()))return d}if(be(n)){const d=n.toDate();if(d instanceof Date)return d}return new Date},Te=({open:n,onOpenChange:d,onSuccess:o})=>{const{user:N}=ae(),[v,D]=p.useState(!1),[S,y]=p.useState(!1),[a,l]=p.useState({order_number:"",customer_id:"",customer_name:"",due_date:"",priority:"0",status:"planned",notes:"",shipping_address:"",shipping_notes:"",deductMaterials:!0}),[h,q]=p.useState([{product_id:"",product_name:"",quantity:"1",unit:"Adet"}]),[u,M]=p.useState({}),[A,K]=p.useState([]),[ve,E]=p.useState(!1),L=p.useCallback(()=>$(void 0,null,function*(){try{const s=new Date,r=s.getFullYear(),t=String(s.getMonth()+1).padStart(2,"0"),c=String(s.getDate()).padStart(2,"0"),{getOrders:m}=yield ne(()=>$(void 0,null,function*(){const{getOrders:g}=yield import("./MainLayout-Dv9j77B5.js").then(C=>C.ae);return{getOrders:g}}),__vite__mapDeps([0,1,2,3,4])),i=yield m(),k=`${r}-${t}-${c}`,U=i.filter(g=>{const C=Ne(g.createdAt);return`${C.getFullYear()}-${String(C.getMonth()+1).padStart(2,"0")}-${String(C.getDate()).padStart(2,"0")}`===k}).length,W=String(U+1).padStart(3,"0"),X=`PROD-${r}${t}${c}-${W}`;l(g=>S&&g.order_number?g:x(j({},g),{order_number:X}))}catch(s){const r=`PROD-${Date.now()}`;l(t=>S&&t.order_number?t:x(j({},t),{order_number:r}))}}),[S]),T=p.useCallback(()=>$(void 0,null,function*(){try{E(!0);const s=yield le();K(s)}catch(s){console.error("Fetch products error:",s),b.error("Ürün listesi alınamadı")}finally{E(!1)}}),[]);p.useEffect(()=>{if(n){y(!1),L(),T();const s=setInterval(()=>{T()},3e4);return()=>clearInterval(s)}},[n,L,T]);const Q=()=>{q([...h,{product_id:"",product_name:"",quantity:"1",unit:"Adet"}])},G=s=>{if(h.length===1){b.error("En az bir ürün olmalıdır");return}q(h.filter((r,t)=>t!==s))},P=(s,r,t)=>{const c=[...h];if(c[s]=x(j({},c[s]),{[r]:t}),r==="product_id")if(t==="none"||t==="")c[s].product_name="";else if(t==="manual")c[s].product_name="";else{const m=A.find(i=>i.id===t);m&&(c[s].product_name=m.name)}q(c)},J=s=>$(void 0,null,function*(){s.preventDefault();const r={};if(a.order_number.trim()||(r.order_number="Sipariş numarası zorunludur"),a.due_date||(r.due_date="Termin tarihi zorunludur"),h.forEach((t,c)=>{(!t.product_id||t.product_id===""||t.product_id==="none")&&(r[`product_${c}`]="Ürün seçin veya 'Diğer' seçin"),t.product_id==="manual"&&!t.product_name.trim()&&(r[`product_name_${c}`]="Ürün adı zorunlu");const m=Number(t.quantity);(!t.quantity||isNaN(m)||m<=0)&&(r[`quantity_${c}`]="Miktar 0'dan büyük olmalı")}),Object.keys(r).length>0){M(r),b.error("Lütfen tüm zorunlu alanları doldurun");return}D(!0);try{if(!N){b.error("Oturum sona erdi"),D(!1);return}const t=a.due_date?H.fromDate(new Date(a.due_date)):null,c=h.map(i=>({productId:i.product_id==="manual"?null:i.product_id||null,product_id:i.product_id==="manual"?null:i.product_id||null,productName:i.product_name,product_name:i.product_name,quantity:Number(i.quantity),unitPrice:0,unit_price:0,total:0})),m=h.reduce((i,k)=>i+Number(k.quantity),0);yield fe({orderNumber:a.order_number,order_number:a.order_number,customerId:a.customer_id||null,customer_id:a.customer_id||null,customerName:a.customer_name||null,customer_name:a.customer_name||null,status:a.status||"planned",totalAmount:0,total_amount:0,currency:"TRY",dueDate:t,due_date:a.due_date||null,notes:a.notes||null,itemsCount:c.length,items_count:c.length,totalQuantity:m,total_quantity:m,createdBy:N.id,created_by:N.id,deductMaterials:a.deductMaterials},c),b.success("Üretim siparişi oluşturuldu"),o(),d(!1),l({order_number:"",customer_id:"",customer_name:"",due_date:"",priority:"0",status:"planned",notes:"",shipping_address:"",shipping_notes:"",deductMaterials:!0}),q([{product_id:"",product_name:"",quantity:"1",unit:"Adet"}]),M({})}catch(t){console.error("Create production order error:",t),b.error("Hata: "+((t==null?void 0:t.message)||"Bilinmeyen hata"))}finally{D(!1)}});return e.jsx(me,{open:n,onOpenChange:d,children:e.jsxs(pe,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(he,{children:[e.jsx(_e,{children:"Yeni Üretim Siparişi"}),e.jsx(je,{children:"Üretim için yeni bir sipariş oluşturun"})]}),e.jsxs("form",{onSubmit:J,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{htmlFor:"order_number",showRequired:!0,children:"Sipariş Numarası"}),e.jsx(I,{id:"order_number",value:a.order_number,onChange:s=>{l(x(j({},a),{order_number:s.target.value})),y(!0)},className:w(u.order_number&&"border-destructive"),required:!0}),u.order_number&&e.jsx("p",{className:"text-sm text-destructive",children:u.order_number})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{htmlFor:"due_date",showRequired:!0,children:"Termin Tarihi"}),e.jsx(I,{id:"due_date",type:"date",value:a.due_date,onChange:s=>l(x(j({},a),{due_date:s.target.value})),className:w(u.due_date&&"border-destructive"),required:!0}),u.due_date&&e.jsx("p",{className:"text-sm text-destructive",children:u.due_date})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:"Müşteri"}),e.jsx(ye,{value:a.customer_id,onChange:(s,r)=>l(x(j({},a),{customer_id:s,customer_name:r})),placeholder:"Müşteri seçin"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(_,{className:"text-base font-semibold",children:"Ürünler"}),e.jsxs(O,{type:"button",onClick:Q,size:"sm",variant:"outline",children:[e.jsx(oe,{className:"h-4 w-4 mr-1"}),"Ürün Ekle"]})]}),h.map((s,r)=>e.jsx(de,{className:"p-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-sm font-medium",children:["Ürün ",r+1]}),h.length>1&&e.jsx(O,{type:"button",variant:"ghost",size:"sm",onClick:()=>G(r),children:e.jsx(ce,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:"Ürün Seçin"}),e.jsxs(R,{value:s.product_id,onValueChange:t=>P(r,"product_id",t),onOpenChange:t=>{t&&T()},children:[e.jsx(B,{className:w(u[`product_${r}`]&&"border-destructive"),children:e.jsx(V,{placeholder:"Ürün seçin"})}),e.jsxs(Y,{children:[e.jsx(f,{value:"none",children:"Ürün seçin"}),A.map(t=>e.jsx(f,{value:t.id,children:t.name},t.id)),e.jsx(f,{value:"manual",children:"Diğer"})]})]}),u[`product_${r}`]&&e.jsx("p",{className:"text-sm text-destructive",children:u[`product_${r}`]})]}),s.product_id==="manual"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:"Ürün Adı"}),e.jsx(I,{value:s.product_name,onChange:t=>P(r,"product_name",t.target.value),placeholder:"Ürün adı girin",className:w(u[`product_name_${r}`]&&"border-destructive")}),u[`product_name_${r}`]&&e.jsx("p",{className:"text-sm text-destructive",children:u[`product_name_${r}`]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:"Miktar"}),e.jsx(I,{type:"number",value:s.quantity,onChange:t=>P(r,"quantity",t.target.value),className:w(u[`quantity_${r}`]&&"border-destructive")}),u[`quantity_${r}`]&&e.jsx("p",{className:"text-sm text-destructive",children:u[`quantity_${r}`]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:"Birim"}),e.jsxs(R,{value:s.unit,onValueChange:t=>P(r,"unit",t),children:[e.jsx(B,{children:e.jsx(V,{})}),e.jsxs(Y,{children:[e.jsx(f,{value:"Adet",children:"Adet"}),e.jsx(f,{value:"Kg",children:"Kg"}),e.jsx(f,{value:"Litre",children:"Litre"}),e.jsx(f,{value:"Metre",children:"Metre"})]})]})]})]})]})},r))]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:"Notlar"}),e.jsx(xe,{value:a.notes,onChange:s=>l(x(j({},a),{notes:s.target.value})),placeholder:"Sipariş notları",rows:3})]}),e.jsxs(ge,{children:[e.jsx(O,{type:"button",variant:"outline",onClick:()=>d(!1),children:"İptal"}),e.jsx(O,{type:"submit",disabled:v,children:v?e.jsxs(e.Fragment,{children:[e.jsx(ue,{className:"mr-2 h-4 w-4 animate-spin"}),"Oluşturuluyor..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"mr-2 h-4 w-4"}),"Oluştur"]})})]})]})]})})};export{Te as C};

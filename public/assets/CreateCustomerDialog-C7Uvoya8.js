var P=Object.defineProperty,Q=Object.defineProperties;var U=Object.getOwnPropertyDescriptors;var b=Object.getOwnPropertySymbols;var S=Object.prototype.hasOwnProperty,B=Object.prototype.propertyIsEnumerable;var z=(a,r,s)=>r in a?P(a,r,{enumerable:!0,configurable:!0,writable:!0,value:s}):a[r]=s,p=(a,r)=>{for(var s in r||(r={}))S.call(r,s)&&z(a,s,r[s]);if(b)for(var s of b(r))B.call(r,s)&&z(a,s,r[s]);return a},w=(a,r)=>Q(a,U(r));var I=a=>typeof a=="symbol"?a:a+"",L=(a,r)=>{var s={};for(var l in a)S.call(a,l)&&r.indexOf(l)<0&&(s[l]=a[l]);if(a!=null&&b)for(var l of b(a))r.indexOf(l)<0&&B.call(a,l)&&(s[l]=a[l]);return s};var C=(a,r,s)=>new Promise((l,i)=>{var o=m=>{try{d(s.next(m))}catch(h){i(h)}},t=m=>{try{d(s.throw(m))}catch(h){i(h)}},d=m=>m.done?l(m.value):Promise.resolve(m.value).then(o,t);d((s=s.apply(a,r)).next())});import{A as q,D,E,G as V,F as Y,H as O,J as R,K as J,Q as X,M as $,T as W,u as Z,j as e,B as G,C as ee,b as se,L as x,I as v,a as k,z as ae}from"./index-BQmY0BmM.js";import{r as y,l as te,X as re,m as ne,I as le}from"./lucide-react-CAeuRJQk.js";import{D as me,a as ie,b as oe,c as ce,e as de,T as H,P as he}from"./MainLayout-Dv9j77B5.js";const T="customerNotes",ve=a=>C(void 0,null,function*(){var r;try{const s=q(D(E,T),V("customerId","==",a),Y("createdAt","desc"));return(yield O(s)).docs.map(i=>p({id:i.id},i.data()))}catch(s){if((s==null?void 0:s.code)==="failed-precondition"||(r=s==null?void 0:s.message)!=null&&r.includes("index")){console.warn("Customer notes index bulunamadı, basit query kullanılıyor");try{const l=q(D(E,T));let o=(yield O(l)).docs.map(t=>p({id:t.id},t.data()));return o=o.filter(t=>t.customerId===a),o.sort((t,d)=>{var N,g;const m=((N=t.createdAt)==null?void 0:N.toMillis())||0;return(((g=d.createdAt)==null?void 0:g.toMillis())||0)-m}),o}catch(l){return console.error("Fallback query de başarısız:",l),[]}}throw console.error("Get customer notes error:",s),s}}),ue=a=>C(void 0,null,function*(){var r;try{const s=w(p({},a),{createdAt:R(),updatedAt:R()}),l=yield J(D(E,T),s),i=yield X(l);if(!i.exists())throw new Error("Not oluşturulamadı");return yield $("CREATE","customerNotes",l.id,a.createdBy,null,i.data()),w(p({id:l.id},i.data()),{createdAt:((r=i.data())==null?void 0:r.createdAt)||W.now()})}catch(s){throw console.error("Create customer note error:",s),s}}),ye=({open:a,onOpenChange:r,onSuccess:s})=>{const{user:l}=Z(),[i,o]=y.useState(!1),[t,d]=y.useState({name:"",email:"",phone:"",company:"",address:"",tax_number:"",notes:""}),[m,h]=y.useState({}),[N,g]=y.useState({}),F=()=>{d({name:"",email:"",phone:"",company:"",address:"",tax_number:"",notes:""}),h({}),g({})};y.useEffect(()=>{a&&F()},[a]);const u=(n,j)=>{d(c=>w(p({},c),{[n]:j})),N[n]&&m[n]&&h(c=>{const _=c,{[n]:f}=_;return L(_,[I(n)])})},K=()=>{const n={};return t.name.trim()||(n.name="İsim alanı zorunludur."),t.email&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t.email)&&(n.email="Geçerli bir email adresi girin."),t.phone&&t.phone.replace(/\D/g,"").length<10&&(n.phone="Geçerli bir telefon numarası girin."),n},A=n=>C(void 0,null,function*(){n.preventDefault();const j=K();if(Object.keys(j).length>0){const c=["name","email","phone","company","address","tax_number","notes"],f={};c.forEach(M=>{f[M]=!0}),g(f),h(j);return}o(!0);try{if(!l){k.error("Oturumunuz sona erdi. Lütfen tekrar giriş yapın."),o(!1);return}const c=yield he({name:t.name,company:t.company||null,email:t.email||null,phone:ae(t.phone),address:t.address||null,taxId:t.tax_number||null,notes:t.notes||null,createdBy:l.id});if(t.notes&&t.notes.trim())try{yield ue({customerId:c.id,type:"general",title:"Müşteri Oluşturulurken Eklenen Not",content:t.notes.trim(),createdBy:l.id})}catch(f){console.warn("Müşteri notu oluşturulamadı:",f)}k.success("Müşteri başarıyla oluşturuldu"),s(),r(!1),F()}catch(c){console.error("Create customer error:",c),k.error(c.message||"Müşteri oluşturulurken hata oluştu")}finally{o(!1)}});return e.jsx(me,{open:a,onOpenChange:r,children:e.jsx(ie,{className:"!max-w-[100vw] sm:!max-w-[95vw] !w-[100vw] sm:!w-[95vw] !h-[100vh] sm:!h-[90vh] !max-h-[100vh] sm:!max-h-[90vh] !left-0 sm:!left-[2.5vw] !top-0 sm:!top-[5vh] !right-0 sm:!right-auto !bottom-0 sm:!bottom-auto !translate-x-0 !translate-y-0 overflow-hidden !p-0 gap-0 bg-white flex flex-col !m-0 !rounded-none sm:!rounded-lg !border-0 sm:!border",children:e.jsxs("div",{className:"flex flex-col h-full min-h-0",children:[e.jsx(oe,{className:"p-3 sm:p-4 border-b bg-white flex-shrink-0 relative pr-12 sm:pr-16",children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3 flex-1 min-w-0",children:[e.jsx("div",{className:"h-8 w-8 sm:h-10 sm:w-10 rounded-lg bg-primary/10 flex items-center justify-center border border-primary/20 flex-shrink-0",children:e.jsx(te,{className:"h-4 w-4 sm:h-5 sm:w-5 text-primary"})}),e.jsx(ce,{className:"text-lg sm:text-xl font-semibold text-foreground truncate",children:"Yeni Müşteri"}),e.jsx(de,{className:"sr-only",children:"Yeni müşteri eklemek için formu doldurun"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 flex-shrink-0",children:[e.jsxs(G,{variant:"outline",size:"sm",className:"border-primary/20 hover:bg-primary/5 rounded-lg px-3 py-1.5 font-medium text-xs sm:text-sm flex-shrink-0",onClick:()=>r(!1),disabled:i,children:[e.jsx(re,{className:"h-3 w-3 sm:h-4 sm:w-4 mr-1.5 flex-shrink-0"}),"İptal"]}),e.jsxs(G,{variant:"default",size:"sm",className:"bg-primary hover:bg-primary/90 rounded-lg px-3 py-1.5 font-medium text-xs sm:text-sm flex-shrink-0 text-white",onClick:A,disabled:i,children:[i?e.jsx(ne,{className:"h-3 w-3 sm:h-4 sm:w-4 mr-1.5 flex-shrink-0 animate-spin"}):e.jsx(le,{className:"h-3 w-3 sm:h-4 sm:w-4 mr-1.5 flex-shrink-0"}),"Kaydet"]})]})]})}),e.jsx("div",{className:"flex-1 overflow-hidden bg-gray-50/50 p-3 sm:p-4 min-h-0",children:e.jsx("div",{className:"max-w-full mx-auto h-full overflow-y-auto",children:e.jsx("form",{onSubmit:A,className:"space-y-4 sm:space-y-6",children:e.jsx(ee,{children:e.jsxs(se,{className:"p-4 sm:p-6 space-y-4 sm:space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-foreground mb-1",children:"Müşteri Bilgileri"}),e.jsx("p",{className:"text-xs sm:text-sm text-muted-foreground",children:"Temel müşteri bilgilerini girin"})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"name",showRequired:!0,className:"text-sm sm:text-base",children:"İsim"}),e.jsx(v,{id:"name",value:t.name,onChange:n=>u("name",n.target.value),className:"min-h-[44px] sm:min-h-0",required:!0}),m.name&&e.jsx("p",{className:"text-xs text-destructive",children:m.name})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"company",className:"text-sm sm:text-base",children:"Şirket"}),e.jsx(v,{id:"company",value:t.company,onChange:n=>u("company",n.target.value),className:"min-h-[44px] sm:min-h-0"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"email",className:"text-sm sm:text-base",children:"E-posta"}),e.jsx(v,{id:"email",type:"email",value:t.email,onChange:n=>u("email",n.target.value),className:"min-h-[44px] sm:min-h-0"}),m.email&&e.jsx("p",{className:"text-xs text-destructive",children:m.email})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"phone",className:"text-sm sm:text-base",children:"Telefon"}),e.jsx(v,{id:"phone",value:t.phone,onChange:n=>u("phone",n.target.value),className:"min-h-[44px] sm:min-h-0"}),m.phone&&e.jsx("p",{className:"text-xs text-destructive",children:m.phone})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"address",className:"text-sm sm:text-base",children:"Adres"}),e.jsx(H,{id:"address",value:t.address,onChange:n=>u("address",n.target.value),rows:3,className:"min-h-[44px] sm:min-h-0 resize-none"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"tax_number",className:"text-sm sm:text-base",children:"Vergi No"}),e.jsx(v,{id:"tax_number",value:t.tax_number,onChange:n=>u("tax_number",n.target.value),className:"min-h-[44px] sm:min-h-0"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"notes",className:"text-sm sm:text-base",children:"Notlar"}),e.jsx(H,{id:"notes",value:t.notes,onChange:n=>u("notes",n.target.value),rows:4,className:"min-h-[44px] sm:min-h-0 resize-none",placeholder:"Müşteri hakkında notlar..."})]})]})})})})})]})})})};export{ye as C,ue as c,ve as g};

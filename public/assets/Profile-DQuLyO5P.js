import{k as _,r as N,j as e,C as u,c as h,d as p,e as j,B as H,ak as K,b as A,T as F}from"./index-Xd90qdO9.js";import{B as D,s as S,w as G,M}from"./MainLayout-DW7UjMSA.js";import{T as R,a as P,b as v,c,d as B,e as o}from"./table-CHpYTcky.js";import{S as C}from"./skeleton-DkPhyqEs.js";import{b as O,a as Y}from"./taskService-CQO0i9v5.js";import{g as q}from"./pdfGenerator-H9L-JbYf.js";import{D as J}from"./download-Bq-rl9Ru.js";import{f as Q}from"./formatLastLogin-CD2ke5e-.js";import"./isSameDay-CmhUF_DM.js";import"./format-DuC-NjES.js";import"./subDays-BSPI1LCX.js";import"./addDays-b8IynWul.js";import"./isToday-C_-qpr0F.js";const V={pending:"Beklemede",accepted:"Kabul edildi",rejected:"Reddedildi",completed:"Tamamlandı",in_progress:"Devam ediyor"},k=s=>s?(s instanceof Date?s:new Date(s)).toLocaleString("tr-TR"):"-",W=()=>{const{user:s}=_(),[f,x]=N.useState(!0),[r,I]=N.useState([]),[L,U]=N.useState([]);N.useEffect(()=>{if(!(s!=null&&s.id))return;(async()=>{x(!0);try{const l=(await O()).slice(0,500),d=10,m=[];for(let n=0;n<l.length;n+=d){const E=l.slice(n,n+d),z=await Promise.all(E.map(async b=>{try{return(await Y(b.id)).filter(y=>y.assignedTo===s.id).map(y=>({...y,taskId:b.id,taskTitle:b.title,taskStatus:b.status}))}catch(w){return console.error(`Error fetching assignments for task ${b.id}:`,w),[]}}));m.push(...z.flat())}I(m);const g=await K({userId:s.id,limit:200}).catch(()=>[]);U(g)}catch(a){console.error("User personal insights error:",a),A.error((a==null?void 0:a.message)||"Profil istatistikleri alınamadı")}finally{x(!1)}})()},[s==null?void 0:s.id]);const i=N.useMemo(()=>({total:r.length,accepted:r.filter(a=>a.status==="accepted").length,rejected:r.filter(a=>a.status==="rejected").length,completed:r.filter(a=>a.status==="completed").length,pending:r.filter(a=>a.status==="pending").length,active:r.filter(a=>["pending","accepted"].includes(a.status)).length}),[r]),T=r.filter(t=>t.status==="rejected"&&t.rejectionReason&&t.rejectionReason.trim().length>0),$=async()=>{if(s)try{const t=await q({userName:s.fullName||s.email,userEmail:s.email,total:i.total,accepted:i.accepted,rejected:i.rejected,pending:i.pending,completed:i.completed,active:i.active,assignments:r.map(d=>{var m;return{taskTitle:d.taskTitle,status:d.status,assignedAt:d.assignedAt.toDate(),completedAt:((m=d.completedAt)==null?void 0:m.toDate())||null}})}),a=URL.createObjectURL(t),l=document.createElement("a");l.href=a,l.download=`kullanici-istatistikleri-${s.fullName||s.email}-${new Date().toISOString().split("T")[0]}.pdf`,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(a),A.success("PDF raporu indirildi")}catch(t){console.error("PDF export error:",t),A.error("PDF oluşturulurken hata: "+t.message)}};return s?f?e.jsxs("div",{className:"space-y-4",children:[e.jsx(C,{className:"h-32"}),e.jsx(C,{className:"h-48"})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs(u,{children:[e.jsx(h,{children:e.jsx(p,{children:"Görev İstatistiklerim"})}),e.jsx(j,{children:e.jsx("div",{className:"grid gap-4 md:grid-cols-3",children:[{label:"Toplam Görev",value:i.total},{label:"Aktif Görev",value:i.active},{label:"Reddedilen Görev",value:i.rejected},{label:"Tamamlanan Görev",value:i.completed},{label:"Bekleyen Görev",value:i.pending}].map(t=>e.jsxs(u,{className:"border-dashed",children:[e.jsx(h,{className:"pb-1",children:e.jsx(p,{className:"text-sm text-muted-foreground",children:t.label})}),e.jsx(j,{children:e.jsx("p",{className:"text-2xl font-semibold",children:t.value})})]},t.label))})})]}),e.jsxs(u,{children:[e.jsx(h,{children:e.jsxs(p,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Görevlerim"}),e.jsxs(H,{size:"sm",variant:"outline",onClick:$,children:[e.jsx(J,{className:"h-4 w-4 mr-2"}),"PDF İndir"]})]})}),e.jsx(j,{className:"space-y-4",children:r.length===0?e.jsx("div",{className:"text-center text-muted-foreground py-4",children:"Henüz size atanan görev bulunmuyor."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(R,{children:[e.jsx(P,{children:e.jsxs(v,{children:[e.jsx(c,{children:"Görev"}),e.jsx(c,{children:"Durum"}),e.jsx(c,{children:"Atama"}),e.jsx(c,{children:"Kabul"}),e.jsx(c,{children:"Tamamlanma"})]})}),e.jsx(B,{children:r.map(t=>{var a,l;return e.jsxs(v,{children:[e.jsx(o,{className:"font-medium",children:t.taskTitle}),e.jsx(o,{children:e.jsx(D,{variant:t.status==="rejected"?"destructive":t.status==="accepted"?"default":t.status==="completed"?"secondary":"outline",children:V[t.status]||t.status})}),e.jsx(o,{children:k((l=(a=t.assignedAt)==null?void 0:a.toDate)==null?void 0:l.call(a))}),e.jsx(o,{children:t.acceptedAt?k(t.acceptedAt.toDate()):"-"}),e.jsx(o,{children:t.completedAt?k(t.completedAt.toDate()):"-"})]},`${t.taskId}-${t.id}`)})})]})})})]}),T.length>0&&e.jsxs(u,{children:[e.jsx(h,{children:e.jsx(p,{children:"Reddetme Notlarım"})}),e.jsx(j,{className:"space-y-4",children:T.map(t=>e.jsxs("div",{className:"rounded-lg border border-border p-4 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm text-muted-foreground",children:[e.jsx("span",{children:t.taskTitle}),e.jsx("span",{children:t.assignedAt?S(t.assignedAt.toDate(),{addSuffix:!0,locale:G}):"-"})]}),e.jsx("p",{className:"text-sm whitespace-pre-line",children:t.rejectionReason})]},`${t.taskId}-${t.id}`))})]}),e.jsxs(u,{children:[e.jsx(h,{children:e.jsx(p,{children:"İşlem Geçmişim"})}),e.jsx(j,{className:"space-y-4",children:L.length===0?e.jsx("div",{className:"text-center text-muted-foreground py-4",children:"Henüz işlem kaydı bulunmuyor."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(R,{children:[e.jsx(P,{children:e.jsxs(v,{children:[e.jsx(c,{children:"İşlem"}),e.jsx(c,{children:"Bölüm"}),e.jsx(c,{children:"Açıklama"}),e.jsx(c,{children:"Tarih"})]})}),e.jsx(B,{children:L.slice(0,20).map(t=>{const a={CREATE:"Oluşturuldu",UPDATE:"Güncellendi",DELETE:"Silindi"},l={tasks:"Görevler",users:"Kullanıcılar",departments:"Departmanlar",orders:"Siparişler",production_orders:"Üretim Siparişleri",customers:"Müşteriler",products:"Ürünler",projects:"Projeler",audit_logs:"Loglar",role_permissions:"Yetkiler",raw_materials:"Hammaddeler",materials:"Malzemeler",user_logins:"Giriş Kayıtları"},d=a[t.action]||t.action,m=l[t.tableName]||t.tableName;let g=t.recordId?`Kayıt ID: ${t.recordId.slice(0,8)}...`:"Bilinmiyor";if(t.tableName==="user_logins"){const n=t.metadata;n!=null&&n.method?g={EMAIL:"E-posta ile giriş",GOOGLE:"Google ile giriş"}[n.method]||`Giriş (${n.method})`:g="Sistem girişi"}return e.jsxs(v,{children:[e.jsx(o,{children:e.jsx(D,{variant:t.action==="DELETE"?"destructive":t.action==="UPDATE"?"secondary":(t.tableName==="user_logins","default"),children:t.tableName==="user_logins"?"Giriş Yapıldı":d})}),e.jsx(o,{className:"font-medium",children:m}),e.jsx(o,{className:"text-sm text-muted-foreground",children:g}),e.jsx(o,{children:t.createdAt?S(t.createdAt.toDate(),{addSuffix:!0,locale:G}):"-"})]},t.id)})})]})})})]})]}):null},me=()=>{var f;const{user:s}=_();return e.jsx(M,{children:e.jsxs("div",{className:"space-y-3 sm:space-y-4 md:space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl sm:text-2xl md:text-3xl font-bold text-foreground",children:"Profil"}),e.jsx("p",{className:"text-muted-foreground mt-0.5 sm:mt-1 text-xs sm:text-sm",children:"Kişisel bilgilerinizi ve görev istatistiklerinizi görüntüleyin"})]}),s&&e.jsxs(u,{children:[e.jsx(h,{children:e.jsx(p,{className:"text-base sm:text-lg md:text-xl",children:"Kişisel Bilgiler"})}),e.jsxs(j,{className:"grid gap-3 sm:gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Ad Soyad"}),e.jsx("p",{className:"text-lg font-semibold",children:s.fullName||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"E-posta"}),e.jsx("p",{className:"text-lg font-semibold break-all",children:s.email||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Rol"}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-1",children:((f=s.roles)!=null&&f.length?s.roles:["personnel"]).map(x=>{const r={super_admin:"Süper Yönetici",admin:"Yönetici",team_leader:"Ekip Lideri",personnel:"Personel",viewer:"Görüntüleyici"};return e.jsx(D,{variant:"secondary",children:r[x]||x},x)})})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Son Giriş"}),e.jsx("p",{className:"text-lg font-semibold",children:s.lastLoginAt?Q((s.lastLoginAt instanceof F||s.lastLoginAt&&typeof s.lastLoginAt=="object"&&"toDate"in s.lastLoginAt,s.lastLoginAt)):"Hiç giriş yapmamış"})]})]})]}),e.jsx(W,{})]})})};export{me as default};

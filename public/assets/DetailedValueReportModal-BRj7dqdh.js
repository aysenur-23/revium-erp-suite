var _=(A,F,S)=>new Promise((c,u)=>{var x=f=>{try{v(S.next(f))}catch(h){u(h)}},n=f=>{try{v(S.throw(f))}catch(h){u(h)}},v=f=>f.done?c(f.value):Promise.resolve(f.value).then(x,n);v((S=S.apply(A,F)).next())});import{j as e,C as b,p as C,q as w,b as D}from"./index-BQmY0BmM.js";import{D as ne,a as oe,b as ie,c as ue,e as me,S as xe,B as q}from"./MainLayout-Dv9j77B5.js";import{T as B,a as K,b as p,c as o,d as E,e as i}from"./table-zhTdMUM_.js";import{r as z,D as U,o as de,p as he,q as G,s as W,i as je,j as ge}from"./lucide-react-CAeuRJQk.js";import{c as J}from"./exchangeRateService-Ba2gZPdu.js";import{C as Te}from"./currency-BpxR3_y8.js";const be=({open:A,onOpenChange:F,title:S,type:c,data:u,orders:x=[]})=>{const[n,v]=z.useState(null),[f,h]=z.useState(!0);z.useEffect(()=>{A&&(c==="customers"&&x&&x.length>0||c!=="customers"&&u.length>0)?(h(!0),_(void 0,null,function*(){if(c==="customers"){if(!Array.isArray(x)||x.length===0){v({totalValue:0,totalValueTRY:0,byCategory:[],byCurrency:[],byStatus:[],topItems:[],averageCost:0}),h(!1);return}let t=0,a=0;const R=new Map,d=new Map;for(const l of x){const r=Number(l.totalAmount)||0,k=l.currency||"TRY";let T=r;if(k!=="TRY")try{T=yield J(r,k)}catch(V){T=r}t+=r,a+=T;const y=l.customerId||l.customer_id;if(y){const V=u.find(ce=>ce.id===y),le=(V==null?void 0:V.name)||"Bilinmeyen Müşteri",I=R.get(y)||{name:le,orderCount:0,totalAmount:0,totalAmountTRY:0};I.orderCount+=1,I.totalAmount+=r,I.totalAmountTRY+=T,R.set(y,I)}const M=d.get(k)||{count:0,value:0,valueTRY:0};M.count+=1,M.value+=r,M.valueTRY+=T,d.set(k,M)}const Y=Array.from(R.entries()).map(([l,r])=>({category:r.name,count:r.orderCount,value:r.totalAmount,valueTRY:r.totalAmountTRY})).sort((l,r)=>r.valueTRY-l.valueTRY).slice(0,10),m=Array.from(d.entries()).map(([l,r])=>({currency:l,count:r.count,value:r.value,valueTRY:r.valueTRY})).sort((l,r)=>r.valueTRY-l.valueTRY),g=x.length>0?x.reduce((l,r)=>l+(Number(r.totalAmount)||0),0)/x.length:0;v({totalValue:t,totalValueTRY:a,byCategory:Y,byCurrency:m,byStatus:[],topItems:Y.map(l=>({name:l.category,value:l.value,valueTRY:l.valueTRY,stock:l.count,cost:g,currency:"TRY",category:"Müşteri"})),averageCost:g}),h(!1);return}if(!Array.isArray(u)||u.length===0){v({totalValue:0,totalValueTRY:0,byCategory:[],byCurrency:[],byStatus:[],topItems:[],averageCost:0}),h(!1);return}let j=0,P=0;const H=new Map,O=new Map,$=new Map,L=[];for(const t of u){let a=0,R=0,d="TRY",Y="Diğer",m=0;if(c==="rawMaterials")a=Number(t.currentStock!==void 0?t.currentStock:t.stock)||0,R=Number(t.unitPrice!==void 0?t.unitPrice:t.cost)||0,d=t.currency||"TRY",Y=t.category||"Diğer",m=a*R;else if(c==="products")a=Number(t.stock)||0,R=Number(t.price)||0,d=t.currency||"TRY",Y=t.category||"Diğer",m=a*R;else if(c==="customers")continue;let g=m;if(d!=="TRY")try{g=yield J(m,d)}catch(M){g=m}j+=m,P+=g;const l=H.get(Y)||{count:0,value:0,valueTRY:0};l.count+=1,l.value+=m,l.valueTRY+=g,H.set(Y,l);const r=O.get(d)||{count:0,value:0,valueTRY:0};r.count+=1,r.value+=m,r.valueTRY+=g,O.set(d,r);const k=Number(t.minStock!==void 0?t.minStock:t.min_stock)||0;let T="normal";a===0?T="tükenen":a<k&&(T="düşük");const y=$.get(T)||{count:0,value:0,valueTRY:0};y.count+=1,y.value+=m,y.valueTRY+=g,$.set(T,y),L.push({name:t.name||"İsimsiz",value:m,valueTRY:g,stock:a,cost:R,currency:d,category:Y})}const ee=Array.from(H.entries()).map(([t,a])=>({category:t,count:a.count,value:a.value,valueTRY:a.valueTRY})).sort((t,a)=>a.valueTRY-t.valueTRY),se=Array.from(O.entries()).map(([t,a])=>({currency:t,count:a.count,value:a.value,valueTRY:a.valueTRY})).sort((t,a)=>a.valueTRY-t.valueTRY),te=Array.from($.entries()).map(([t,a])=>({status:t,count:a.count,value:a.value,valueTRY:a.valueTRY})).sort((t,a)=>a.valueTRY-t.valueTRY),ae=L.sort((t,a)=>a.valueTRY-t.valueTRY).slice(0,10),re=u.length>0?u.reduce((t,a)=>t+(Number(a.unitPrice!==void 0?a.unitPrice:a.cost)||0),0)/u.length:0;v({totalValue:j,totalValueTRY:P,byCategory:ee,byCurrency:se,byStatus:te,topItems:ae,averageCost:re}),h(!1)})):(v(null),h(!1))},[A,u,x,c]);const N=(s,j="TRY")=>{try{return new Intl.NumberFormat("tr-TR",{style:"currency",currency:j,minimumFractionDigits:2}).format(s)}catch(P){return`${Te[j]||"₺"}${s.toFixed(2)}`}},Q=s=>({normal:"Normal Stok",düşük:"Düşük Stok",tükenen:"Tükenen"})[s]||s,X=s=>s==="normal"?je:s==="düşük"?W:ge,Z=s=>s==="normal"?"bg-green-100 text-green-700":s==="düşük"?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700";return e.jsx(ne,{open:A,onOpenChange:F,children:e.jsxs(oe,{className:"max-w-5xl w-[95vw] sm:w-[90vw] max-h-[90vh] flex flex-col p-0 !overflow-hidden",children:[e.jsxs(ie,{className:"p-3 sm:p-4 border-b bg-white flex-shrink-0",children:[e.jsx(ue,{className:"text-lg sm:text-xl font-semibold text-foreground",children:S}),e.jsx(me,{className:"sr-only",children:"Detaylı değer raporu"})]}),e.jsx(xe,{className:"flex-1 min-h-0",children:e.jsx("div",{className:"w-full p-3 sm:p-4 space-y-4",children:f?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):n?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 xs:grid-cols-2 sm:grid-cols-3 gap-3 sm:gap-4",children:[e.jsxs(b,{children:[e.jsx(C,{className:"pb-3",children:e.jsxs(w,{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(U,{className:"h-4 w-4 text-primary"}),"Toplam Değer (TRY)"]})}),e.jsxs(D,{children:[e.jsx("div",{className:"text-xl sm:text-2xl font-bold break-words",children:N(n.totalValueTRY,"TRY")}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Tüm para birimleri TRY'ye çevrildi"})]})]}),e.jsxs(b,{children:[e.jsx(C,{className:"pb-3",children:e.jsxs(w,{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(de,{className:"h-4 w-4 text-primary"}),"Ortalama Birim Maliyet"]})}),e.jsxs(D,{children:[e.jsx("div",{className:"text-xl sm:text-2xl font-bold break-words",children:N(n.averageCost,"TRY")}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Tüm hammaddelerin ortalaması"})]})]}),e.jsxs(b,{children:[e.jsx(C,{className:"pb-3",children:e.jsxs(w,{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(he,{className:"h-4 w-4 text-primary"}),"Toplam Kayıt"]})}),e.jsxs(D,{children:[e.jsx("div",{className:"text-xl sm:text-2xl font-bold",children:u.length}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Toplam hammadde sayısı"})]})]})]}),n.byCategory.length>0&&e.jsxs(b,{children:[e.jsx(C,{children:e.jsxs(w,{className:"text-lg flex items-center gap-2",children:[e.jsx(G,{className:"h-5 w-5"}),"Kategori Bazında Değer Dağılımı"]})}),e.jsx(D,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(B,{children:[e.jsx(K,{children:e.jsxs(p,{children:[e.jsx(o,{children:"Kategori"}),e.jsx(o,{className:"text-right",children:"Kayıt Sayısı"}),e.jsx(o,{className:"text-right",children:"Toplam Değer (TRY)"}),e.jsx(o,{className:"text-right",children:"Oran"})]})}),e.jsx(E,{children:n.byCategory.map(s=>e.jsxs(p,{children:[e.jsx(i,{className:"font-medium",children:s.category}),e.jsx(i,{className:"text-right",children:s.count}),e.jsx(i,{className:"text-right font-semibold",children:N(s.valueTRY,"TRY")}),e.jsx(i,{className:"text-right",children:n.totalValueTRY>0?`${(s.valueTRY/n.totalValueTRY*100).toFixed(1)}%`:"0%"})]},s.category))})]})})})]}),n.byCurrency.length>0&&e.jsxs(b,{children:[e.jsx(C,{children:e.jsxs(w,{className:"text-base sm:text-lg flex items-center gap-2",children:[e.jsx(U,{className:"h-4 w-4 sm:h-5 sm:w-5"}),"Para Birimi Bazında Değer Dağılımı"]})}),e.jsx(D,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(B,{children:[e.jsx(K,{children:e.jsxs(p,{children:[e.jsx(o,{children:"Para Birimi"}),e.jsx(o,{className:"text-right",children:"Kayıt Sayısı"}),e.jsx(o,{className:"text-right",children:"Orijinal Değer"}),e.jsx(o,{className:"text-right",children:"TRY Karşılığı"})]})}),e.jsx(E,{children:n.byCurrency.map(s=>e.jsxs(p,{children:[e.jsx(i,{className:"font-medium",children:e.jsx(q,{variant:"outline",children:s.currency})}),e.jsx(i,{className:"text-right",children:s.count}),e.jsx(i,{className:"text-right",children:N(s.value,s.currency)}),e.jsx(i,{className:"text-right font-semibold",children:N(s.valueTRY,"TRY")})]},s.currency))})]})})})]}),n.byStatus.length>0&&e.jsxs(b,{children:[e.jsx(C,{children:e.jsxs(w,{className:"text-base sm:text-lg flex items-center gap-2",children:[e.jsx(W,{className:"h-4 w-4 sm:h-5 sm:w-5"}),"Stok Durumuna Göre Değer Dağılımı"]})}),e.jsx(D,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(B,{children:[e.jsx(K,{children:e.jsxs(p,{children:[e.jsx(o,{children:"Stok Durumu"}),e.jsx(o,{className:"text-right",children:"Kayıt Sayısı"}),e.jsx(o,{className:"text-right",children:"Toplam Değer (TRY)"}),e.jsx(o,{className:"text-right",children:"Oran"})]})}),e.jsx(E,{children:n.byStatus.map(s=>{const j=X(s.status);return e.jsxs(p,{children:[e.jsx(i,{className:"font-medium",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(j,{className:`h-4 w-4 ${Z(s.status).split(" ")[1]}`}),Q(s.status)]})}),e.jsx(i,{className:"text-right",children:s.count}),e.jsx(i,{className:"text-right font-semibold",children:N(s.valueTRY,"TRY")}),e.jsx(i,{className:"text-right",children:n.totalValueTRY>0?`${(s.valueTRY/n.totalValueTRY*100).toFixed(1)}%`:"0%"})]},s.status)})})]})})})]}),n.topItems.length>0&&e.jsxs(b,{children:[e.jsx(C,{children:e.jsxs(w,{className:"text-base sm:text-lg flex items-center gap-2",children:[e.jsx(G,{className:"h-4 w-4 sm:h-5 sm:w-5"}),e.jsxs("span",{className:"break-words",children:[c==="rawMaterials"&&"En Değerli Hammaddeler (Top 10)",c==="products"&&"En Değerli Ürünler (Top 10)",c==="customers"&&"En Değerli Müşteriler (Top 10)"]})]})}),e.jsx(D,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(B,{children:[e.jsx(K,{children:e.jsxs(p,{children:[e.jsx(o,{children:c==="customers"?"Müşteri":c==="products"?"Ürün":"Hammadde"}),e.jsx(o,{children:c==="customers"?"Sipariş Sayısı":"Kategori"}),c!=="customers"&&e.jsx(o,{className:"text-right",children:"Stok"}),c!=="customers"&&e.jsxs(o,{className:"text-right",children:["Birim ",c==="products"?"Fiyat":"Maliyet"]}),e.jsx(o,{className:"text-right",children:"Toplam Değer (TRY)"})]})}),e.jsx(E,{children:n.topItems.map((s,j)=>e.jsxs(p,{children:[e.jsx(i,{className:"font-medium",children:s.name}),e.jsx(i,{children:c==="customers"?e.jsx("span",{children:s.stock}):e.jsx(q,{variant:"outline",children:s.category})}),c!=="customers"&&e.jsx(i,{className:"text-right",children:s.stock}),c!=="customers"&&e.jsx(i,{className:"text-right",children:N(s.cost,s.currency)}),e.jsx(i,{className:"text-right font-semibold",children:N(s.valueTRY,"TRY")})]},j))})]})})})]})]}):e.jsx("div",{className:"text-center text-muted-foreground py-12",children:"Veri bulunamadı"})})})]})})};export{be as D};

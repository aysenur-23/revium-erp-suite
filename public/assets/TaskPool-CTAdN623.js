const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/taskService-CQO0i9v5.js","assets/index-Xd90qdO9.js","assets/index-HS3kTX7E.css"])))=>i.map(i=>d[i]);
import{k as Oe,r as d,g as Ie,_ as ze,b as m,j as e,L as Ge,l as Le,m as Re,n as Z,B as j,C as _e,c as Ee,o as U,d as Me,S as ee,p as se,q as te,s as ae,t as B,e as Fe,f as Ve,U as qe,X as He,v as Ke,w as Ye,T as $e}from"./index-Xd90qdO9.js";import{M as re,B as T,D as _,a as E,b as M,c as F,d as V,e as Je}from"./MainLayout-DW7UjMSA.js";import{S as We}from"./search-input-QX7HVhJf.js";import{b as Xe,c as Qe,r as Ze,d as Ue,e as es,a as ss,f as ts,u as as}from"./taskService-CQO0i9v5.js";import{A as rs,a as ns,b as is,c as ls,d as os,e as cs,f as ds}from"./alert-dialog-BVp-ELLM.js";import{T as ne}from"./TaskInlineForm-CDqKbM2W.js";import{C as ms}from"./checkbox-BX7aNvy5.js";import{T as us}from"./TaskBoard-fwyGe4xh.js";import{P as xs}from"./plus-D9uLCipi.js";import"./storageService-pEqhfEwa.js";import"./driveService-020R8zku.js";import"./UserMultiSelect-KlPlOKAA.js";import"./popover-BA39Kv9C.js";import"./avatar-KtUT5CWN.js";import"./permissions-D79DzJt5.js";import"./rolePermissionsService-CoZ8Qmsy.js";import"./list-checks-CkcaKLuC.js";import"./user-plus-DWuSLDZe.js";import"./tag-EYbV-h0Y.js";import"./message-square-BAQ_w3zD.js";import"./folder-DUFwF4S_.js";import"./ellipsis-vertical-gVlTlFy-.js";import"./trash-2-DlZRXDqX.js";import"./format-DuC-NjES.js";import"./isToday-C_-qpr0F.js";import"./isSameDay-CmhUF_DM.js";import"./addDays-b8IynWul.js";const Fs=()=>{var W;const{user:i,isAdmin:k,isTeamLeader:C,isSuperAdmin:D}=Oe(),[ie,q]=d.useState(!0),[O,le]=d.useState([]),[y,oe]=d.useState([]),[p,ce]=d.useState({}),[de,me]=d.useState({}),[ue,I]=d.useState(!1),[c,H]=d.useState(null),[N,xe]=d.useState(""),[S,he]=d.useState("createdAt"),[pe,b]=d.useState(!1),[z,G]=d.useState(null),[ge,fe]=d.useState([]),[K,je]=d.useState("list"),[ve,L]=d.useState("pending"),[ye,A]=d.useState(!1),[Y,Ne]=d.useState(null),[P,w]=d.useState({isOpen:!1,taskId:"",userId:"",userName:"",keepInPool:!1});d.useEffect(()=>{h()},[]),d.useEffect(()=>{Se()},[O,N,S]);const h=async()=>{q(!0);try{const[s,t,a]=await Promise.all([Xe(),Qe(),Ie()]),l=s.filter(n=>n.isInPool===!0&&!n.onlyInMyTasks);le(l);const r={};t.forEach(n=>{var x,f;n.id==="general"||((x=n.name)==null?void 0:x.toLowerCase())==="genel görevler"||((f=n.name)==null?void 0:f.toLowerCase())==="genel"||(r[n.id]=n)}),me(r);const u=(await Promise.all(t.map(async n=>{if(!n.isPrivate||k||D||C||i!=null&&i.id&&n.createdBy===i.id)return n;if(i!=null&&i.id)try{const{getTasks:x,getTaskAssignments:f}=await ze(async()=>{const{getTasks:v,getTaskAssignments:X}=await import("./taskService-CQO0i9v5.js").then(Q=>Q.W);return{getTasks:v,getTaskAssignments:X}},__vite__mapDeps([0,1,2])),Be=await x({projectId:n.id});for(const v of Be)if(v.createdBy===i.id||v.assignedUsers&&v.assignedUsers.includes(i.id)||(await f(v.id)).some(R=>R.assignedTo===i.id&&(R.status==="accepted"||R.status==="pending")))return n}catch(x){console.error("Error checking project tasks:",x)}return null}))).filter(n=>{var x,f;return!(n===null||n.status!=="active"||n.id==="general"||((x=n.name)==null?void 0:x.toLowerCase())==="genel görevler"||((f=n.name)==null?void 0:f.toLowerCase())==="genel"||n.name==="Gizli Görevler"&&n.isPrivate===!0&&n.description==="Projesi olmayan gizli görevler için otomatik oluşturulan proje")});fe(u);const g={};a.forEach(n=>{g[n.id]=n}),ce(g)}catch(s){m.error("Görev havuzu yüklenirken hata: "+s.message)}finally{q(!1)}},be=async s=>{if(!(i!=null&&i.id)){m.error("Kullanıcı bilgisi bulunamadı");return}try{await Ze(s,i.id),m.success("Görev talebi gönderildi"),h()}catch(t){m.error("Talep hatası: "+t.message)}},we=(s,t,a)=>{w({isOpen:!0,taskId:s,userId:t,userName:a,keepInPool:!1})},Te=async()=>{const{taskId:s,userId:t,keepInPool:a}=P;if(i!=null&&i.id)try{if(await Ue(s,t,i.id,a),m.success("Görev talebi onaylandı"),c){const l=(c.poolRequests||[]).filter(u=>u!==t),r=[...c.assignedUsers||[],t],o={...c,poolRequests:a?l:[],isInPool:a,assignedUsers:r};H(o)}w(l=>({...l,isOpen:!1})),h()}catch(l){m.error("Onaylama hatası: "+l.message)}},ke=async(s,t)=>{try{await es(s,t),m.success("Görev talebi reddedildi"),h()}catch(a){m.error("Reddetme hatası: "+a.message)}},Ce=s=>{H(s),I(!0)},$=s=>{Ne(s),A(!0)},De=(s,t)=>{if(s==="new"){t&&["pending","in_progress","completed"].includes(t)?L(t):L("pending"),b(!0);return}$(s)},Se=()=>{let s=[...O];if(N.trim()){const t=N.toLocaleLowerCase("tr-TR");s=s.filter(a=>{var l,r;return(((l=a.title)==null?void 0:l.toLocaleLowerCase("tr-TR"))||"").includes(t)||(((r=a.description)==null?void 0:r.toLocaleLowerCase("tr-TR"))||"").includes(t)})}s.sort((t,a)=>{var l,r,o,u;if(S==="title")return(t.title||"").localeCompare(a.title||"");if(S==="dueDate"){const g=((l=t.dueDate)==null?void 0:l.toMillis())||0,n=((r=a.dueDate)==null?void 0:r.toMillis())||0;return g-n}else{const g=((o=t.createdAt)==null?void 0:o.toMillis())||0;return(((u=a.createdAt)==null?void 0:u.toMillis())||0)-g}}),oe(s)},J=k||C||D,Ae=d.useMemo(()=>y.map(s=>{const t=r=>{if(!r)return null;if(r instanceof $e||typeof(r==null?void 0:r.toDate)=="function")return r.toDate().toISOString();try{return new Date(r).toISOString()}catch{return null}};let a=[];if(Array.isArray(s.labels))a=s.labels.map(r=>typeof r=="string"?{name:r,color:"#61BD4F"}:r);else if(typeof s.labels=="string")try{const r=JSON.parse(s.labels);Array.isArray(r)&&(a=r.map(o=>typeof o=="string"?{name:o,color:"#61BD4F"}:o))}catch{a=[]}const l=(s.assignedUsers||[]).map(r=>{const o=p[r];return{assigned_to:r,assigned_to_name:(o==null?void 0:o.fullName)||(o==null?void 0:o.email)||"Kullanıcı",assigned_to_email:(o==null?void 0:o.email)||""}});return{id:s.id,title:s.title,description:s.description||"",status:s.status||"pending",priority:s.priority||0,due_date:t(s.dueDate),created_at:t(s.createdAt)||new Date().toISOString(),createdBy:s.createdBy,labels:a,assignments:l}}),[y,p]),Pe=async(s,t)=>{if(i)try{const a=t,l=O.find(u=>u.id===s);if(!l){m.error("Görev bulunamadı");return}if(!k&&!C&&!D&&!(await ss(s)).map(x=>x.assignedTo).includes(i.id)){m.error("Bu görevin durumunu değiştirme yetkiniz yok. Sadece size atanan görevlerin durumunu değiştirebilirsiniz.");return}const r=(l==null?void 0:l.createdBy)===i.id;if(a==="completed"&&!(k||C||D||r)){await ts(s,i.id),m.success("Görev tamamlandı olarak işaretlendi ve onay için gönderildi."),h();return}await as(s,a),m.success("Görev durumu güncellendi"),h()}catch(a){console.error("Task pool status change error:",a),m.error(a.message||"Durum güncellenemedi")}};return ie?e.jsx(re,{children:e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(Ge,{className:"h-8 w-8 animate-spin text-primary"})})}):e.jsx(re,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-foreground",children:"Görev Havuzu"}),e.jsx("p",{className:"text-muted-foreground mt-1 text-sm sm:text-base",children:"Henüz atanmamış görevleri görüntüleyin ve talep edin"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Le,{value:K,onValueChange:s=>je(s),children:e.jsxs(Re,{children:[e.jsx(Z,{value:"list",children:"Liste"}),e.jsx(Z,{value:"board",children:"Pano"})]})}),J&&e.jsxs(j,{onClick:()=>{L("pending"),b(!0)},children:[e.jsx(xs,{className:"h-4 w-4 mr-2"}),"Havuza Görev Ekle"]})]})]}),e.jsxs(_e,{children:[e.jsx(Ee,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{className:"h-5 w-5"}),e.jsx(Me,{children:"Açık Görevler"})]}),e.jsxs(T,{variant:"secondary",children:[y.length," görev"]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-center gap-3",children:[e.jsx(We,{placeholder:"Görev ara...",value:N,onChange:s=>xe(s.target.value),containerClassName:"flex-1 w-full"}),e.jsxs(ee,{value:S,onValueChange:s=>he(s),children:[e.jsx(se,{className:"w-full sm:w-[180px]",children:e.jsx(te,{placeholder:"Sırala"})}),e.jsxs(ae,{children:[e.jsx(B,{value:"createdAt",children:"Yeni Önce"}),e.jsx(B,{value:"title",children:"Başlığa Göre"}),e.jsx(B,{value:"dueDate",children:"Bitiş Tarihine Göre"})]})]})]})]})}),e.jsx(Fe,{children:K==="list"?y.length===0?e.jsx("div",{className:"text-center py-12 text-muted-foreground border-2 border-dashed rounded-xl",children:N?"Arama sonucu bulunamadı":"Görev havuzunda şu an açık görev yok."}):e.jsx("div",{className:"space-y-4",children:y.map(s=>{const t=s.poolRequests||[],a=(i==null?void 0:i.id)&&t.includes(i.id),l=s.createdBy===(i==null?void 0:i.id),r=s.dueDate?s.dueDate.toDate():null,o=s.projectId?de[s.projectId]:null;return e.jsx("div",{className:"flex flex-col gap-4 p-4 rounded-lg border bg-card hover:bg-accent/5 transition-colors cursor-pointer",onClick:()=>$(s.id),children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-start justify-between gap-4",children:[e.jsxs("div",{className:"space-y-2 flex-1",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("h3",{className:"font-semibold text-lg",children:s.title}),o&&e.jsx(T,{variant:"secondary",className:"text-xs font-normal",children:o.name}),s.priority===5&&e.jsx(T,{variant:"destructive",className:"text-xs",children:"Kritik"})]}),s.description&&e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2",children:s.description}),e.jsxs("div",{className:"flex flex-wrap items-center gap-4 text-sm text-muted-foreground",children:[r&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ve,{className:"h-4 w-4"}),e.jsx("span",{children:r.toLocaleDateString("tr-TR")})]}),s.createdBy&&p[s.createdBy]&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(qe,{className:"h-4 w-4"}),e.jsxs("span",{children:["Oluşturan: ",p[s.createdBy].fullName||p[s.createdBy].email||"Bilinmeyen"]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(U,{className:"h-4 w-4"}),e.jsxs("span",{children:[t.length," talep"]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 self-end sm:self-start",onClick:u=>u.stopPropagation(),children:[a?e.jsx(T,{variant:"outline",className:"bg-primary/10 text-primary border-primary/20",children:"Talep Gönderildi"}):e.jsx(j,{size:"sm",onClick:()=>be(s.id),disabled:t.includes((i==null?void 0:i.id)||""),children:"Görevi Talep Et"}),(J||l)&&t.length>0&&e.jsx(j,{size:"sm",variant:"outline",onClick:()=>Ce(s),children:"Talepleri Yönet"})]})]})},s.id)})}):e.jsx("div",{className:"-mx-4 sm:mx-0",children:e.jsx(us,{tasks:Ae,onTaskClick:De,onStatusChange:Pe})})})]}),e.jsx(rs,{open:ue,onOpenChange:I,children:e.jsxs(ns,{children:[e.jsxs(is,{children:[e.jsx(ls,{children:"Görev Taleplerini Yönet"}),e.jsxs(os,{children:['"',c==null?void 0:c.title,'" görevi için gelen talepleri onaylayın veya reddedin.']})]}),e.jsxs("div",{className:"py-4 space-y-4 max-h-[60vh] overflow-y-auto",children:[(c==null?void 0:c.assignedUsers)&&c.assignedUsers.length>0&&e.jsxs("div",{className:"mb-4",children:[e.jsx("h4",{className:"text-sm font-medium text-muted-foreground mb-2",children:"Atanan Kullanıcılar"}),e.jsx("div",{className:"space-y-2",children:c.assignedUsers.map(s=>{var a,l;const t=p[s];return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 border border-green-100 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-green-100 flex items-center justify-center text-green-700 font-semibold text-sm",children:((a=t==null?void 0:t.fullName)==null?void 0:a.charAt(0))||((l=t==null?void 0:t.email)==null?void 0:l.charAt(0))||"?"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-green-900",children:(t==null?void 0:t.fullName)||"Bilinmeyen Kullanıcı"}),e.jsx("div",{className:"text-xs text-green-700",children:t==null?void 0:t.email})]})]}),e.jsx(T,{className:"bg-green-100 text-green-800 hover:bg-green-100 border-green-200",children:"Onaylandı"})]},`assigned-${s}`)})})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-muted-foreground mb-2",children:"Bekleyen Talepler"}),e.jsxs("div",{className:"space-y-2",children:[(W=c==null?void 0:c.poolRequests)==null?void 0:W.map(s=>{var a,l;const t=p[s];return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center text-primary font-semibold text-sm",children:((a=t==null?void 0:t.fullName)==null?void 0:a.charAt(0))||((l=t==null?void 0:t.email)==null?void 0:l.charAt(0))||"?"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:(t==null?void 0:t.fullName)||"Bilinmeyen Kullanıcı"}),e.jsx("div",{className:"text-xs text-muted-foreground",children:t==null?void 0:t.email})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(j,{size:"icon",variant:"ghost",className:"h-8 w-8 text-destructive hover:text-destructive hover:bg-destructive/10",onClick:()=>ke(c.id,s),children:e.jsx(He,{className:"h-4 w-4"})}),e.jsx(j,{size:"icon",variant:"ghost",className:"h-8 w-8 text-green-600 hover:text-green-600 hover:bg-green-50",onClick:()=>we(c.id,s,(t==null?void 0:t.fullName)||"Kullanıcı"),children:e.jsx(Ke,{className:"h-4 w-4"})})]})]},`request-${s}`)}),(!(c!=null&&c.poolRequests)||c.poolRequests.length===0)&&e.jsx("div",{className:"text-center text-muted-foreground py-4 bg-muted/30 rounded-lg border border-dashed",children:"Henüz bekleyen talep yok."})]})]})]}),e.jsx(cs,{children:e.jsx(ds,{onClick:()=>I(!1),children:"Kapat"})})]})}),e.jsx(_,{open:P.isOpen,onOpenChange:s=>w(t=>({...t,isOpen:s})),children:e.jsxs(E,{children:[e.jsxs(M,{children:[e.jsx(F,{children:"Onaylama İşlemi"}),e.jsxs(V,{children:[P.userName," kullanıcısının talebini onaylamak üzeresiniz."]})]}),e.jsxs("div",{className:"py-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ms,{id:"keepInPool",checked:P.keepInPool,onCheckedChange:s=>w(t=>({...t,keepInPool:s}))}),e.jsx("label",{htmlFor:"keepInPool",className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 cursor-pointer",children:"Görevi havuzda tut (Diğer kişiler de talep edebilir)"})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Eğer işaretlemezseniz, görev havuzdan kaldırılacak ve sadece atanan kullanıcıya görünecektir."})]}),e.jsxs(Je,{children:[e.jsx(j,{variant:"outline",onClick:()=>w(s=>({...s,isOpen:!1})),children:"İptal"}),e.jsx(j,{onClick:Te,children:"Onayla"})]})]})}),e.jsx(_,{open:pe,onOpenChange:b,children:e.jsxs(E,{className:"max-w-4xl w-[95vw] overflow-y-auto max-h-[90vh]",children:[e.jsxs(M,{children:[e.jsx(F,{children:"Havuza Görev Ekle"}),e.jsx(V,{children:"Görev havuzuna yeni bir görev ekleyin. Bu göreve uygun ekip üyeleri başvurabilir."})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx(Ye,{htmlFor:"project-select",children:"Proje Seçimi *"}),e.jsxs(ee,{value:z||"",onValueChange:G,children:[e.jsx(se,{id:"project-select",className:"mt-1",children:e.jsx(te,{placeholder:"Bir proje seçin..."})}),e.jsx(ae,{children:ge.map(s=>e.jsx(B,{value:s.id,children:s.name},s.id))})]})]}),z?e.jsx(ne,{mode:"create",projectId:z,defaultStatus:ve,onCancel:()=>{b(!1),G(null)},onSuccess:()=>{b(!1),G(null),h()},className:"border-0 shadow-none p-0",isInPool:!0}):e.jsx("div",{className:"text-center py-8 text-muted-foreground border-2 border-dashed rounded-lg",children:"Lütfen devam etmek için bir proje seçin."})]})}),e.jsx(_,{open:ye,onOpenChange:A,children:e.jsxs(E,{className:"max-w-4xl w-[95vw] overflow-y-auto max-h-[90vh]",children:[e.jsxs(M,{children:[e.jsx(F,{children:"Görev Detayı"}),e.jsx(V,{children:"Görevi inceleyin ve talep oluşturun."})]}),Y&&e.jsx(ne,{mode:"edit",projectId:null,taskId:Y,onCancel:()=>A(!1),onSuccess:()=>{h(),A(!1)},className:"border-0 shadow-none p-0"})]})})]})})};export{Fs as default};

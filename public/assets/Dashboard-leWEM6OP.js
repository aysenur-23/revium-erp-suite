var _=(e,i,o)=>new Promise((f,a)=>{var d=p=>{try{h(o.next(p))}catch(g){a(g)}},N=p=>{try{h(o.throw(p))}catch(g){a(g)}},h=p=>p.done?f(p.value):Promise.resolve(p.value).then(d,N);h((o=o.apply(e,i)).next())});import{T as se,h as re,u as ne,j as t,C as Q,p as z,q as E,b as K}from"./index-BQmY0BmM.js";import{r as ae,m as W,U as oe,H as ce,o as ie,f as le,q as X,s as de,h as me}from"./lucide-react-CAeuRJQk.js";import{w as ue,g as xe,l as ee,M as Z,B as A}from"./MainLayout-Dv9j77B5.js";import{u as P,S as D}from"./StatCard-qsBkiUPn.js";import{b as te,c as pe}from"./taskService-CI62TrOj.js";import{getSavedReports as he}from"./reportService-yUgxtgcG.js";import{getRawMaterials as ge}from"./materialService-BHW8dEom.js";import"./storageService-BUAGZT8Z.js";import"./driveService-ChwQKMyd.js";const H=(e,i)=>{if(isNaN(e)||isNaN(i))return 0;if(i===0)return e>0?100:0;const o=(e-i)/i*100;return isNaN(o)?0:o},fe=e=>typeof e=="object"&&e!==null&&"toDate"in e&&typeof e.toDate=="function",b=e=>{if(e instanceof Date)return e;if(e instanceof se)return e.toDate();if(typeof e=="string"){const i=new Date(e);if(!Number.isNaN(i.getTime()))return i}if(fe(e)){const i=e.toDate();if(i instanceof Date)return i}return new Date},ke=e=>typeof e=="object"&&e!==null,ye=e=>{if(!ke(e))return 0;const i=e.grandTotal;if(typeof i=="number")return i;if(typeof i=="string"){const o=Number(i);return Number.isFinite(o)?o:0}return 0},ve=()=>P({queryKey:["dashboard-stats"],queryFn:()=>_(void 0,null,function*(){let e=[];try{e=yield he({reportType:"sales_quote"})}catch(s){console.warn("Sales quotes yüklenemedi, devam ediliyor:",s),e=[]}const[i,o,f,a]=yield Promise.all([ue().then(s=>s.slice(0,100)),xe().then(s=>s.slice(0,200)),ee().then(s=>s.slice(0,100)),te().then(s=>s.slice(0,50))]),d=new Date().getMonth(),N=d===0?11:d-1,h=new Date().getFullYear(),p=d===0?h-1:h,g=o.filter(s=>{const n=b(s.createdAt);return n.getMonth()===d&&n.getFullYear()===h}),C=o.filter(s=>{const n=b(s.createdAt);return n.getMonth()===N&&n.getFullYear()===p}),k=g.reduce((s,n)=>{const x=Number(n.totalAmount)||0;return s+(isNaN(x)?0:x)},0),j=C.reduce((s,n)=>{const x=Number(n.totalAmount)||0;return s+(isNaN(x)?0:x)},0),B=o.filter(s=>s.status!=="completed"&&s.status!=="cancelled"),S=f.filter(s=>{const n=s.stock||0,x=s.minStock||0;return n<=x}),q=o.slice(0,5).map(s=>({id:s.id,order_number:s.orderNumber||s.order_number||"",customer_name:s.customerName||s.customer_name||"",total:Number(s.totalAmount||s.total_amount||0)||0,order_date:b(s.createdAt).toISOString(),status:s.status})),F=i.filter(s=>{const n=b(s.createdAt);return n.getMonth()===d&&n.getFullYear()===h}),L=i.filter(s=>{const n=b(s.createdAt);return n.getMonth()===N&&n.getFullYear()===p}),I=f.filter(s=>{const n=b(s.createdAt);return n.getMonth()===d&&n.getFullYear()===h}),$=f.filter(s=>{const n=b(s.createdAt);return n.getMonth()===N&&n.getFullYear()===p}),O=(Array.isArray(e)?e:[]).reduce((s,n)=>{const x=ye(n.metadata);return s+x},0),w=new Set;e.forEach(s=>{if(s.metadata&&typeof s.metadata=="object"){const n=s.metadata.customerId;n&&typeof n=="string"&&w.add(n)}});const T=new Set;o.forEach(s=>{s.customerId&&T.add(s.customerId)});const M=w.size,Y=Array.from(w).filter(s=>T.has(s)).length,R=M>0?Y/M*100:0;return{customers:{total:i.length,trend:H(F.length,L.length)},orders:{total:o.length,active:B.length,trend:H(g.length,C.length)},products:{total_stock:f.reduce((s,n)=>{const x=Number(n.stock)||0;return s+(isNaN(x)?0:x)},0),low_stock_count:S.length,trend:H(I.length,$.length)},revenue:{current_month:k,trend:H(k,j)},recent_orders:q,low_stock_products:S.map(s=>({id:s.id,name:s.name,stock:s.stock||0,min_stock:s.minStock||0})),quotes:{total_amount:O,count:Array.isArray(e)?e.length:0},quote_conversion_rate:R}}),refetchInterval:18e4,refetchOnWindowFocus:!1,refetchOnMount:!1,retry:1,retryDelay:2e3,staleTime:12e4,placeholderData:e=>e||{customers:{total:0,trend:0},orders:{total:0,active:0,trend:0},products:{total_stock:0,low_stock_count:0,trend:0},revenue:{current_month:0,trend:0},recent_orders:[],low_stock_products:[],quotes:{total_amount:0,count:0},quote_conversion_rate:0}}),qe=()=>{var q,F,L,I,$,O,w,T,M,Y,R,G,s,n,x,U;const{data:e,isLoading:i}=ve(),o=re(),{isAdmin:f,user:a}=ne(),{data:d=[],isLoading:N}=P({queryKey:["dashboard-tasks",a==null?void 0:a.id],queryFn:()=>_(void 0,null,function*(){try{const r=yield te();if(a!=null&&a.id){const m=r.filter(y=>y.createdBy===a.id).slice(0,20);if(m.length>0)return m}return r.slice(0,20)}catch(r){return console.error("Tasks yüklenirken hata:",r),[]}}),enabled:!!(a!=null&&a.id),refetchInterval:18e4,refetchOnWindowFocus:!1,staleTime:12e4,placeholderData:[]}),{data:h=new Map,isLoading:p}=P({queryKey:["dashboard-task-assignments",d.slice(0,10).map(r=>r.id).join(",")],queryFn:()=>_(void 0,null,function*(){if(!(a!=null&&a.id)||d.length===0)return new Map;try{const r=new Map,m=d.slice(0,10);return yield Promise.all(m.map(y=>_(void 0,null,function*(){try{const v=yield pe(y.id);r.set(y.id,v)}catch(v){r.set(y.id,[])}}))),r}catch(r){return new Map}}),enabled:d.length>0&&!!(a!=null&&a.id),refetchInterval:18e4,refetchOnWindowFocus:!1,staleTime:12e4}),{data:g=[],isLoading:C}=P({queryKey:["dashboard-low-stock-items"],queryFn:()=>_(void 0,null,function*(){try{const[r,m]=yield Promise.all([ee().then(c=>c.slice(0,50)),ge().then(c=>c.slice(0,50))]),y=r.filter(c=>{const l=Number(c.stock)||0,u=Number(c.minStock)||0;return l===0||u>0&&l<u}).map(c=>({id:c.id,name:c.name,stock:c.stock||0,min_stock:c.minStock||0,type:"product",unit:c.unit||"Adet"})),v=m.filter(c=>{const l=Number(c.currentStock)||0,u=Number(c.minStock)||0;return l===0||u>0&&l<u}).map(c=>({id:c.id,name:c.name,stock:c.currentStock||0,min_stock:c.minStock||0,type:"rawMaterial",unit:c.unit||"Adet"}));return[...y,...v].sort((c,l)=>c.stock===0&&l.stock!==0?-1:c.stock!==0&&l.stock===0?1:c.stock-l.stock)}catch(r){return console.error("Düşük stoklu ürünler ve hammaddeler yüklenirken hata:",r),[]}}),refetchInterval:18e4,refetchOnWindowFocus:!1,staleTime:12e4}),{overdueTasks:k,upcomingTasks:j,myTasksCount:B}=ae.useMemo(()=>{if(!(a!=null&&a.id)||d.length===0)return{overdueTasks:[],upcomingTasks:[],myTasksCount:0};const r=new Date;r.setHours(0,0,0,0);const m=new Date(r);m.setDate(m.getDate()+7);const v=d.slice(0,50).filter(l=>{if(l.status==="completed"||l.status==="cancelled"||l.isArchived)return!1;if(l.createdBy===a.id)return!0;if(l.onlyInMyTasks)return l.createdBy===a.id;const u=h.get(l.id);return!!(u&&u.length>0&&u.find(J=>J.assignedTo===a.id&&J.status==="accepted"))}),V=v.filter(l=>{if(!l.dueDate)return!1;const u=l.dueDate.toDate();return u.setHours(0,0,0,0),u<r}),c=v.filter(l=>{if(!l.dueDate)return!1;const u=l.dueDate.toDate();return u.setHours(0,0,0,0),u>=r&&u<=m});return{overdueTasks:V,upcomingTasks:c,myTasksCount:v.length}},[d,a==null?void 0:a.id,h]),S=i||N||p;return S?t.jsx(Z,{children:t.jsx("div",{className:"flex items-center justify-center h-[60vh]",children:t.jsx(W,{className:"h-8 w-8 animate-spin text-primary"})})}):t.jsx(Z,{children:t.jsxs("div",{className:"space-y-2 sm:space-y-3 md:space-y-4",children:[t.jsxs("div",{children:[t.jsx("h1",{className:"text-xl sm:text-2xl md:text-3xl font-bold text-foreground",children:"Dashboard"}),t.jsx("p",{className:"text-muted-foreground mt-0.5 sm:mt-1 text-xs sm:text-sm",children:"Hoş geldiniz, işte bugünkü özet"})]}),t.jsxs("div",{className:f?"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 sm:gap-4 md:gap-5 lg:gap-6":"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4 md:gap-5 lg:gap-6",children:[t.jsx(D,{title:"Toplam Müşteri",value:((q=e==null?void 0:e.customers)==null?void 0:q.total)!=null&&!isNaN(e.customers.total)?e.customers.total.toString():"0",icon:oe,trend:{value:((F=e==null?void 0:e.customers)==null?void 0:F.trend)!==void 0&&!isNaN(e.customers.trend)?`${e.customers.trend>0?"+":""}${e.customers.trend.toFixed(1)}% bu ay`:"Veri yok",positive:(((L=e==null?void 0:e.customers)==null?void 0:L.trend)!=null&&!isNaN(e.customers.trend)?e.customers.trend:0)>=0},variant:"primary",onClick:()=>o("/customers"),clickable:!0}),t.jsx(D,{title:"Aktif Siparişler",value:((I=e==null?void 0:e.orders)==null?void 0:I.active)!=null&&!isNaN(e.orders.active)?e.orders.active.toString():"0",icon:ce,trend:{value:(($=e==null?void 0:e.orders)==null?void 0:$.trend)!==void 0&&!isNaN(e.orders.trend)?`${e.orders.trend>0?"+":""}${e.orders.trend.toFixed(1)}% bu ay`:"Veri yok",positive:(((O=e==null?void 0:e.orders)==null?void 0:O.trend)!=null&&!isNaN(e.orders.trend)?e.orders.trend:0)>=0},variant:"success",onClick:()=>o("/orders"),clickable:!0}),t.jsx(D,{title:"Ürün Stok",value:((w=e==null?void 0:e.products)==null?void 0:w.total_stock)!=null&&!isNaN(e.products.total_stock)?e.products.total_stock.toString():"0",icon:ie,trend:{value:(((T=e==null?void 0:e.products)==null?void 0:T.low_stock_count)||0)>0?`${e.products.low_stock_count} ürün düşük`:"Stoklar yeterli",positive:(((M=e==null?void 0:e.products)==null?void 0:M.low_stock_count)||0)===0},variant:"info",onClick:()=>o("/products"),clickable:!0}),t.jsx(D,{title:"Görevlerim",value:B.toString(),icon:le,trend:{value:`${k.length} gecikmiş, ${j.length} yaklaşan`,positive:k.length===0},variant:"primary",onClick:()=>o("/tasks?tab=my-tasks"),clickable:!0}),f&&t.jsx(D,{title:"Aylık Ciro",value:`₺${(((Y=e==null?void 0:e.revenue)==null?void 0:Y.current_month)!=null&&!isNaN(e.revenue.current_month)?e.revenue.current_month:0).toLocaleString("tr-TR")}`,icon:X,trend:{value:((R=e==null?void 0:e.revenue)==null?void 0:R.trend)!==void 0&&!isNaN(e.revenue.trend)?`${e.revenue.trend>0?"+":""}${e.revenue.trend.toFixed(1)}% bu ay`:"Veri yok",positive:(((G=e==null?void 0:e.revenue)==null?void 0:G.trend)!=null&&!isNaN(e.revenue.trend)?e.revenue.trend:0)>=0},variant:"warning",onClick:()=>{o("/reports")},clickable:!0}),f&&(e==null?void 0:e.quote_conversion_rate)!==void 0&&t.jsx(D,{title:"Teklif Dönüşüm Oranı",value:`${e.quote_conversion_rate.toFixed(1)}%`,icon:X,trend:{value:`${(n=(s=e.quotes)==null?void 0:s.count)!=null?n:0} teklif, ${Math.round(((U=(x=e.quotes)==null?void 0:x.count)!=null?U:0)*(e.quote_conversion_rate/100))} sipariş`,positive:e.quote_conversion_rate>=50},variant:"info",onClick:()=>o("/reports"),clickable:!0})]}),t.jsxs("div",{className:"grid gap-3 sm:gap-4 md:gap-5 lg:gap-6 grid-cols-1 lg:grid-cols-2",children:[t.jsxs(Q,{children:[t.jsx(z,{className:"p-4 sm:p-6",children:t.jsx(E,{className:"text-base sm:text-lg md:text-xl",children:"Son Siparişler"})}),t.jsx(K,{className:"p-4 sm:p-6",children:!(e!=null&&e.recent_orders)||e.recent_orders.length===0?t.jsx("p",{className:"text-muted-foreground text-center py-6 sm:py-8 text-xs sm:text-sm md:text-base",children:"Henüz sipariş yok"}):t.jsx("div",{className:"space-y-2 sm:space-y-3 md:space-y-4",children:(Array.isArray(e.recent_orders)?e.recent_orders:[]).map(r=>t.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 sm:gap-3 py-2 sm:py-2.5 border-b last:border-0 cursor-pointer hover:bg-muted/50 rounded-lg px-2 sm:px-3 transition-colors",onClick:()=>o("/orders"),children:[t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center gap-1.5 sm:gap-2 flex-wrap",children:[t.jsx("p",{className:"font-medium truncate text-xs sm:text-sm md:text-base",children:r.order_number}),r.status&&t.jsx(A,{variant:r.status==="confirmed"||r.status==="in_progress"?"default":r.status==="completed"?"secondary":"outline",className:"text-[10px] sm:text-xs",children:r.status==="confirmed"?"Onaylandı":r.status==="pending"?"Beklemede":r.status==="in_progress"?"İşlemde":r.status==="completed"?"Tamamlandı":r.status==="cancelled"?"İptal":r.status})]}),t.jsx("p",{className:"text-[10px] sm:text-xs md:text-sm text-muted-foreground truncate",children:r.customer_name})]}),t.jsxs("div",{className:"text-left sm:text-right sm:ml-4 flex-shrink-0",children:[t.jsxs("p",{className:"font-medium text-xs sm:text-sm md:text-base",children:["₺",(Number(r.total)||0).toLocaleString("tr-TR")]}),t.jsx("p",{className:"text-[10px] sm:text-xs md:text-sm text-muted-foreground",children:new Date(r.order_date).toLocaleDateString("tr-TR")})]})]},r.id))})})]}),t.jsxs(Q,{children:[t.jsx(z,{className:"p-4 sm:p-6",children:t.jsx(E,{className:"text-base sm:text-lg md:text-xl",children:"Gecikmiş ve Yaklaşan Görevler"})}),t.jsx(K,{className:"p-4 sm:p-6",children:S?t.jsx("div",{className:"flex items-center justify-center py-6 sm:py-8",children:t.jsx(W,{className:"h-5 w-5 sm:h-6 sm:w-6 animate-spin text-primary"})}):k.length===0&&j.length===0?t.jsx("p",{className:"text-muted-foreground text-center py-6 sm:py-8 text-xs sm:text-sm md:text-base",children:"Gecikmiş veya yaklaşan görev yok"}):t.jsxs("div",{className:"space-y-3 sm:space-y-4",children:[k.length>0&&t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[t.jsx(de,{className:"h-4 w-4 text-destructive"}),t.jsxs("p",{className:"text-sm font-semibold text-destructive",children:["Gecikmiş (",k.length,")"]})]}),t.jsx("div",{className:"space-y-1.5 sm:space-y-2",children:k.slice(0,5).map(r=>{var m;return t.jsxs("div",{className:"flex items-center justify-between gap-2 p-2 sm:p-2.5 rounded border border-destructive/20 bg-destructive/5 cursor-pointer hover:bg-destructive/10 transition-colors",onClick:()=>o(`/tasks/${r.id}`),children:[t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("p",{className:"font-medium text-xs sm:text-sm truncate",children:r.title}),t.jsx("p",{className:"text-[10px] sm:text-xs text-muted-foreground",children:(m=r.dueDate)==null?void 0:m.toDate().toLocaleDateString("tr-TR")})]}),t.jsx(A,{variant:"destructive",className:"text-[10px] sm:text-xs flex-shrink-0",children:"Gecikmiş"})]},r.id)})})]}),j.length>0&&t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[t.jsx(me,{className:"h-4 w-4 text-warning"}),t.jsxs("p",{className:"text-sm font-semibold",children:["Yaklaşan (",j.length,")"]})]}),t.jsx("div",{className:"space-y-1.5 sm:space-y-2",children:j.slice(0,5).map(r=>{var m;return t.jsxs("div",{className:"flex items-center justify-between gap-2 p-2 sm:p-2.5 rounded border border-warning/20 bg-warning/5 cursor-pointer hover:bg-warning/10 transition-colors",onClick:()=>o(`/tasks/${r.id}`),children:[t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("p",{className:"font-medium text-xs sm:text-sm truncate",children:r.title}),t.jsx("p",{className:"text-[10px] sm:text-xs text-muted-foreground",children:(m=r.dueDate)==null?void 0:m.toDate().toLocaleDateString("tr-TR")})]}),t.jsx(A,{variant:"outline",className:"text-[10px] sm:text-xs flex-shrink-0",children:"Yaklaşan"})]},r.id)})})]})]})})]}),t.jsxs(Q,{children:[t.jsx(z,{className:"p-4 sm:p-6",children:t.jsx(E,{className:"text-base sm:text-lg md:text-xl",children:"Düşük Stoklu Ürünler ve Hammaddeler"})}),t.jsx(K,{className:"p-4 sm:p-6",children:C?t.jsx("div",{className:"flex items-center justify-center py-6 sm:py-8",children:t.jsx(W,{className:"h-5 w-5 sm:h-6 sm:w-6 animate-spin text-primary"})}):!g||g.length===0?t.jsx("p",{className:"text-muted-foreground text-center py-6 sm:py-8 text-xs sm:text-sm md:text-base",children:"Düşük stoklu ürün veya hammadde yok"}):t.jsx("div",{className:"space-y-2 sm:space-y-3 md:space-y-4",children:(Array.isArray(g)?g:[]).map(r=>t.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 sm:gap-3 py-2 sm:py-2.5 border-b last:border-0 hover:bg-muted/50 rounded-lg px-2 sm:px-3 transition-colors cursor-pointer",onClick:()=>o(r.type==="rawMaterial"?"/raw-materials":"/products"),children:[t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center gap-1.5 sm:gap-2 flex-wrap",children:[t.jsx("p",{className:"font-medium text-xs sm:text-sm md:text-base truncate",children:r.name}),t.jsx(A,{variant:"outline",className:"text-[10px] sm:text-xs",children:r.type==="rawMaterial"?"Hammadde":"Ürün"})]}),t.jsxs("p",{className:"text-[10px] sm:text-xs md:text-sm text-muted-foreground",children:["Min: ",r.min_stock," ",r.unit]})]}),t.jsx("div",{className:"text-left sm:text-right sm:ml-4 flex-shrink-0",children:t.jsxs(A,{variant:r.stock===0?"destructive":"secondary",className:"text-[10px] sm:text-xs",children:[r.stock," ",r.unit]})})]},r.id))})})]})]})]})})};export{qe as default};

import{O as l,ag as m,ah as h}from"./index-Xd90qdO9.js";const p="revium_drive_token",u="revium_drive_token_expiry",A=async()=>{var o;if(!((o=l)!=null&&o.currentUser))throw new Error("Kullanıcı giriş yapmamış. Lütfen önce giriş yapın.");if(!l.currentUser.providerData.some(r=>r.providerId==="google.com")){const r=new m;r.addScope("https://www.googleapis.com/auth/drive.file");try{const a=await h(l,r),s=m.credentialFromResult(a);if(!(s!=null&&s.accessToken))throw new Error("Google Drive erişim token'ı alınamadı");return k(s.accessToken,3600),s.accessToken}catch(a){throw console.error("Google token alma hatası:",a),a.code==="auth/popup-closed-by-user"?new Error("Google bağlantısı iptal edildi."):new Error((a==null?void 0:a.message)||"Google token alınamadı")}}const t=v();if(!t){const r=new m;r.addScope("https://www.googleapis.com/auth/drive.file");try{const a=await h(l,r),s=m.credentialFromResult(a);if(!(s!=null&&s.accessToken))throw new Error("Google Drive erişim token'ı alınamadı");return k(s.accessToken,3600),s.accessToken}catch(a){throw console.error("Google token alma hatası:",a),a.code==="auth/popup-closed-by-user"?new Error("Google bağlantısı iptal edildi."):new Error((a==null?void 0:a.message)||"Google token alınamadı")}}return t},k=(e,n)=>{const t=Date.now()+n*1e3;localStorage.setItem(p,e),localStorage.setItem(u,t.toString())},v=()=>{const e=localStorage.getItem(p),n=localStorage.getItem(u);return!e||!n?null:Date.now()>parseInt(n,10)?(localStorage.removeItem(p),localStorage.removeItem(u),null):e},T=async()=>{const e=v();return e||await A()},$=async()=>{try{if(!l)throw new Error("Firebase Authentication başlatılmamış");const e=new m;e.addScope("https://www.googleapis.com/auth/drive.file");const n=await h(l,e),t=m.credentialFromResult(n);if(!(t!=null&&t.accessToken))throw new Error("Google Drive erişim token'ı alınamadı");return k(t.accessToken,3600),!0}catch(e){throw console.error("Drive authorization error:",e),e.code==="auth/popup-closed-by-user"?new Error("Google bağlantısı iptal edildi."):new Error((e==null?void 0:e.message)||"Google Drive yetkilendirmesi başarısız oldu")}},B=async()=>{var e;try{return v()?!0:(e=l)!=null&&e.currentUser?l.currentUser.providerData.some(o=>o.providerId==="google.com"):!1}catch{return!1}},U=async()=>{try{localStorage.removeItem(p),localStorage.removeItem(u)}catch(e){console.error("Drive revoke error:",e)}},O=async(e,n={})=>{var t;try{const o=await T(),r=e instanceof File?e:new File([e],n.fileName||"file",{type:e.type}),a={name:n.fileName||r.name,mimeType:r.type||"application/octet-stream"};n.folderId?a.parents=[n.folderId]:n.type==="task"||n.type,n.metadata&&(a.properties=n.metadata);const s="----WebKitFormBoundary"+Math.random().toString(36).substring(2),w=`\r
--`+s+`\r
`,E=`\r
--`+s+"--",G=`Content-Type: application/json; charset=UTF-8\r
\r
${JSON.stringify(a)}`,S=`Content-Type: ${r.type||"application/octet-stream"}\r
\r
`,L=await r.arrayBuffer(),F=new Uint8Array(L),g=new TextEncoder,D=[g.encode(w),g.encode(G),g.encode(w),g.encode(S),F,g.encode(E)],z=D.reduce((i,d)=>i+d.length,0),b=new Uint8Array(z);let I=0;for(const i of D)b.set(i,I),I+=i.length;const P=new Blob([b],{type:`multipart/related; boundary=${s}`}),c=await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webViewLink,webContentLink",{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":`multipart/related; boundary=${s}`},body:P});if(!c.ok){let d=((t=(await c.json().catch(()=>({}))).error)==null?void 0:t.message)||"Dosya yükleme başarısız oldu";throw c.status===401?(localStorage.removeItem(p),localStorage.removeItem(u),d="Yetkilendirme hatası. Lütfen tekrar deneyin."):c.status===403?d="Google Drive izni yok. Lütfen yetkilendirme yapın.":c.status===507&&(d="Google Drive depolama kotası dolmuş."),new Error(d)}const f=await c.json();if(!f.id)throw new Error("Dosya yükleme başarısız oldu");const y=f.id;if(n.makePublic!==!1)try{await fetch(`https://www.googleapis.com/drive/v3/files/${y}/permissions`,{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify({role:"reader",type:"anyone"})})}catch(i){console.warn("Public permission eklenemedi:",i)}const x=f.webViewLink||`https://drive.google.com/file/d/${y}/view`;return{success:!0,fileId:y,webViewLink:x,webContentLink:f.webContentLink}}catch(o){console.error("Drive upload error:",o);let r="Google Drive yüklemesi başarısız oldu";throw o!=null&&o.message?r=o.message:typeof o=="string"&&(r=o),r.includes("auth")||r.includes("unauthorized")||r.includes("401")?r="Google Drive yetkilendirmesi gerekli. Lütfen Google ile giriş yapın.":r.includes("quota")||r.includes("storage")||r.includes("507")?r="Google Drive depolama kotası dolmuş. Lütfen depolama alanını kontrol edin.":r.includes("403")&&(r="Google Drive izni yok. Lütfen Google ile giriş yapın."),new Error(r)}},K=async e=>{var n;if(!e||e.trim()==="")throw new Error("Geçerli bir Drive dosya ID'si gerekli");try{const t=await T(),o=await fetch(`https://www.googleapis.com/drive/v3/files/${e}`,{method:"DELETE",headers:{Authorization:`Bearer ${t}`}});if(!o.ok){let a=((n=(await o.json().catch(()=>({}))).error)==null?void 0:n.message)||"Drive dosyası silinemedi";throw o.status===401&&(localStorage.removeItem(p),localStorage.removeItem(u),a="Yetkilendirme hatası. Lütfen tekrar deneyin."),new Error(a)}}catch(t){console.error("Drive delete error:",t);let o="Drive dosyası silinemedi";throw t!=null&&t.message?o=t.message:typeof t=="string"&&(o=t),new Error(o)}};export{$ as a,K as d,B as i,U as r,O as u};

const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-Xd90qdO9.js","assets/index-HS3kTX7E.css","assets/permissions-D79DzJt5.js","assets/rolePermissionsService-CoZ8Qmsy.js"])))=>i.map(i=>d[i]);
import{x as T,M as w,D as b,N as z,aM as M,z as R,aN as W,I as E,G as f,E as S,H as C,Q as k,F as j,aO as at,P as D,J as K,T as P,O as B,_ as q,g as x,a9 as G,a8 as st,aP as F}from"./index-Xd90qdO9.js";const it=(t,e)=>{const a={code:(t==null?void 0:t.code)||"unknown",message:(t==null?void 0:t.message)||"Unknown error",operation:e.operation,collection:e.collection,documentId:e.documentId,userId:e.userId,timestamp:new Date().toISOString(),data:X(e.data)};console.error("ðŸš« Permission Error:",{...a,fullError:t});const s=`
Permission HatasÄ± DetaylarÄ±:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Ä°ÅŸlem: ${e.operation}
Collection: ${e.collection||"N/A"}
Document ID: ${e.documentId||"N/A"}
KullanÄ±cÄ± ID: ${e.userId||"N/A"}
Hata Kodu: ${a.code}
Hata MesajÄ±: ${a.message}
Zaman: ${a.timestamp}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
`;console.error(s),e.collection&&(console.warn("ðŸ“‹ Firebase Console'da Security Rules'u kontrol edin:"),console.warn("   https://console.firebase.google.com/project/revpad-15232/firestore/rules"),console.warn(`   Collection: ${e.collection}`),console.warn(`   Operation: ${e.operation}`))},X=t=>{if(!t||typeof t!="object")return t;const e=["password","token","secret","key","apiKey"],a={...t};for(const s of e)s in a&&(a[s]="[REDACTED]");for(const s in a)typeof a[s]=="object"&&a[s]!==null&&(a[s]=X(a[s]));return a},Y=(t,e)=>{var a,s,o;if((t==null?void 0:t.code)==="permission-denied"||(t==null?void 0:t.code)===7||(a=t==null?void 0:t.message)!=null&&a.includes("Missing or insufficient permissions")||(s=t==null?void 0:t.message)!=null&&s.includes("permission-denied")||(o=t==null?void 0:t.message)!=null&&o.includes("PERMISSION_DENIED")){it(t,e),{create:"oluÅŸturma",update:"gÃ¼ncelleme",delete:"silme",read:"okuma"}[e.operation]||e.operation;const n="Yetkiniz yok. Bu iÅŸlemi yapmak iÃ§in ekip lideri veya yÃ¶neticiye ulaÅŸabilirsiniz.";return new Error(n)}return t instanceof Error?t:new Error((t==null?void 0:t.message)||"Bilinmeyen hata")},H=t=>{var e,a,s;return(t==null?void 0:t.code)==="permission-denied"||(t==null?void 0:t.code)===7||((e=t==null?void 0:t.message)==null?void 0:e.includes("Missing or insufficient permissions"))||((a=t==null?void 0:t.message)==null?void 0:a.includes("permission-denied"))||((s=t==null?void 0:t.message)==null?void 0:s.includes("PERMISSION_DENIED"))},nt=async(t,e)=>{var a;try{let s=R(T(w,"notifications"),b("userId","==",t),z("createdAt","desc"));return e!=null&&e.unreadOnly&&(s=R(s,b("read","==",!1))),e!=null&&e.limit&&(s=R(s,M(e.limit))),(await S(s)).docs.map(r=>({id:r.id,...r.data()}))}catch(s){if(console.error("Get notifications error:",s),typeof s=="object"&&s!==null&&"code"in s&&s.code==="failed-precondition"&&"message"in s&&typeof s.message=="string"&&s.message.includes("index")){const n=(a=s.message.match(/https:\/\/[^\s]+/))==null?void 0:a[0];if(n){console.warn("âš ï¸ Firestore index gerekiyor! LÃ¼tfen ÅŸu linke tÄ±klayarak index'i oluÅŸturun:"),console.warn(n);const i=new Error("Firestore index gerekiyor. LÃ¼tfen index'i oluÅŸturun.");throw i.indexUrl=n,i.code="index-required",i}}throw s}},N=async t=>{try{const e=await C(T(w,"notifications"),{...t,createdAt:k()}),a=await j(e);if(!a.exists())throw new Error("Bildirim oluÅŸturulamadÄ±");const s={id:a.id,...a.data()};try{const o=await j(f(w,"users",t.userId));if(o.exists()){const r=o.data();if(r!=null&&r.email)try{const n=await at(r.email,t.title,t.message,t.type,t.relatedId||null);n.success,n.success}catch{}}}catch{}return s}catch(e){throw console.error("Create notification error:",e),e}},J=async(t,e)=>{try{await E(f(w,"notifications",t),e)}catch(a){throw console.error("Update notification error:",a),a}},rt=async t=>{try{await E(f(w,"notifications",t),{read:!0})}catch(e){throw console.error("Mark notification as read error:",e),e}},ot=async t=>{try{const e=R(T(w,"notifications"),b("userId","==",t),b("read","==",!1)),s=(await S(e)).docs.map(o=>E(o.ref,{read:!0}));await Promise.all(s)}catch(e){throw console.error("Mark all notifications as read error:",e),e}},ct=(t,e={},a)=>{try{const s=T(w,"notifications");let r=(()=>{const i=[b("userId","==",t),z("createdAt","desc")];return e!=null&&e.unreadOnly&&i.push(b("read","==",!1)),e!=null&&e.limit&&i.push(M(e.limit)),R(s,...i)})();return W(r,i=>{try{const u=i.docs.map(l=>({id:l.id,...l.data()}));a(u)}catch(u){console.error("Subscribe to notifications error:",u),a([])}},i=>{var u,l,c,d;if((i==null?void 0:i.code)==="unavailable"||(i==null?void 0:i.code)==="not-found"||(u=i==null?void 0:i.message)!=null&&u.includes("404")||(l=i==null?void 0:i.message)!=null&&l.includes("network")||(c=i==null?void 0:i.message)!=null&&c.includes("transport errored")){a([]);return}if((i==null?void 0:i.code)==="failed-precondition"||(d=i==null?void 0:i.message)!=null&&d.includes("index"))try{const m=R(s,b("userId","==",t),z("createdAt","desc"));return W(m,p=>{try{let y=p.docs.map(h=>({id:h.id,...h.data()}));e!=null&&e.unreadOnly&&(y=y.filter(h=>!h.read)),e!=null&&e.limit&&(y=y.slice(0,e.limit)),a(y)}catch(y){console.error("Fallback subscribe to notifications error:",y),a([])}},p=>{console.error("Fallback notifications snapshot error:",p),a([])})}catch(m){console.error("Fallback query setup error:",m),a([])}else a([])})}catch(s){return console.error("Subscribe to notifications setup error:",s),()=>{}}},Q=Object.freeze(Object.defineProperty({__proto__:null,createNotification:N,getNotifications:nt,markAllNotificationsAsRead:ot,markNotificationAsRead:rt,subscribeToNotifications:ct,updateNotification:J},Symbol.toStringTag,{value:"Module"})),O="projects",dt=async t=>{var e;try{let a=R(T(w,O),z("createdAt","desc"));return t!=null&&t.status&&(a=R(a,b("status","==",t.status))),t!=null&&t.createdBy&&(a=R(a,b("createdBy","==",t.createdBy))),(await S(a)).docs.map(o=>({id:o.id,...o.data()}))}catch(a){if((a==null?void 0:a.code)==="failed-precondition"||(e=a==null?void 0:a.message)!=null&&e.includes("index"))try{const s=R(T(w,O),z("createdAt","desc"));let r=(await S(s)).docs.map(n=>({id:n.id,...n.data()}));return t!=null&&t.status&&(r=r.filter(n=>n.status===t.status)),t!=null&&t.createdBy&&(r=r.filter(n=>n.createdBy===t.createdBy)),r}catch(s){console.error("Fallback query de baÅŸarÄ±sÄ±z:",s);let r=(await S(T(w,O))).docs.map(n=>({id:n.id,...n.data()}));return t!=null&&t.status&&(r=r.filter(n=>n.status===t.status)),t!=null&&t.createdBy&&(r=r.filter(n=>n.createdBy===t.createdBy)),r.sort((n,i)=>{var c,d;const u=((c=n.createdAt)==null?void 0:c.toMillis())||0;return(((d=i.createdAt)==null?void 0:d.toMillis())||0)-u}),r}throw console.error("Get projects error:",a),a}},L=async t=>{try{const e=await j(f(w,O,t));return e.exists()?{id:e.id,...e.data()}:null}catch(e){throw console.error("Get project by id error:",e),e}},lt=async t=>{try{const e={...t,createdAt:k(),updatedAt:k()},a=await C(T(w,O),e),s=await L(a.id);if(!s)throw new Error("Proje oluÅŸturulamadÄ±");return await D("CREATE","projects",a.id,t.createdBy,null,s),s}catch(e){throw console.error("Create project error:",e),e}},ut=async(t,e,a)=>{try{const s=await L(t);await E(f(w,O,t),{...e,updatedAt:k()});const o=await L(t);a&&await D("UPDATE","projects",t,a,s,o)}catch(s){throw console.error("Update project error:",s),s}},mt=async(t,e)=>{try{const a=await L(t),s=await I({projectId:t});await Promise.all(s.map(o=>tt(o.id,e))),await K(f(w,O,t)),e&&await D("DELETE","projects",t,e,a,null)}catch(a){throw console.error("Delete project error:",a),a}},Kt=Object.freeze(Object.defineProperty({__proto__:null,createProject:lt,deleteProject:mt,getProjectById:L,getProjects:dt,updateProject:ut},Symbol.toStringTag,{value:"Module"})),I=async t=>{var e,a,s,o,r;try{const n=T(w,"tasks"),i=c=>{const d=[];return c!=null&&c.skipOrder||d.push(z("createdAt","desc")),t!=null&&t.createdBy&&d.push(b("createdBy","==",t.createdBy)),t!=null&&t.status&&d.push(b("status","==",t.status)),t!=null&&t.projectId&&d.push(b("projectId","==",t.projectId)),t!=null&&t.productionOrderId&&d.push(b("productionOrderId","==",t.productionOrderId)),t!=null&&t.approvalStatus&&d.push(b("approvalStatus","==",t.approvalStatus)),d.push(M(500)),d.length?R(n,...d):R(n,M(500))};let u;try{u=await S(i())}catch(c){if(typeof(c==null?void 0:c.message)=="string"&&c.message.includes("requires an index"))console.warn("âš ï¸ Firestore index gerekiyor, sÄ±ralama olmadan gÃ¶revler getiriliyor. Index linki:",((e=c.message.match(/https:\/\/[^\s]+/))==null?void 0:e[0])||"â€“"),u=await S(i({skipOrder:!0}));else throw c}let l=u.docs.map(c=>({id:c.id,...c.data()}));if(t!=null&&t.projectId&&(l=l.filter(c=>c.projectId===t.projectId&&c.projectId!==null&&c.projectId!==void 0).sort((c,d)=>{const m=c.createdAt instanceof P?c.createdAt.toMillis():0;return(d.createdAt instanceof P?d.createdAt.toMillis():0)-m})),t!=null&&t.assignedTo)l=(await Promise.all(l.map(async d=>d.isPrivate?d.createdBy===t.assignedTo||(await U(d.id)).some(h=>h.assignedTo===t.assignedTo&&h.status!=="rejected")?d:null:(await U(d.id)).some(p=>p.assignedTo===t.assignedTo&&p.status!=="rejected")?d:null))).filter(d=>d!==null);else{const c=(s=(a=B)==null?void 0:a.currentUser)==null?void 0:s.uid;c?l=await Promise.all(l.map(async d=>d.onlyInMyTasks?d.createdBy===c?d:null:!d.isPrivate||d.createdBy===c||(await U(d.id)).some(p=>p.assignedTo===c)?d:null)).then(d=>d.filter(m=>m!==null)):l=l.filter(d=>!d.onlyInMyTasks)}return l}catch(n){throw console.error("Get tasks error:",n),H(n)?Y(n,{operation:"read",collection:"tasks",userId:(r=(o=B)==null?void 0:o.currentUser)==null?void 0:r.uid}):n}},pt=(t={},e)=>{try{const a=T(w,"tasks");let o=(n=>{const i=[];return n!=null&&n.skipOrder||i.push(z("createdAt","desc")),t!=null&&t.createdBy&&i.push(b("createdBy","==",t.createdBy)),t!=null&&t.status&&i.push(b("status","==",t.status)),t!=null&&t.projectId&&i.push(b("projectId","==",t.projectId)),t!=null&&t.productionOrderId&&i.push(b("productionOrderId","==",t.productionOrderId)),t!=null&&t.approvalStatus&&i.push(b("approvalStatus","==",t.approvalStatus)),i.push(M(500)),i.length?R(a,...i):R(a,M(500))})();return W(o,async n=>{var i,u;try{let l=n.docs.map(c=>({id:c.id,...c.data()}));if(t!=null&&t.projectId&&(l=l.filter(c=>c.projectId===t.projectId&&c.projectId!==null&&c.projectId!==void 0).sort((c,d)=>{const m=c.createdAt instanceof P?c.createdAt.toMillis():0;return(d.createdAt instanceof P?d.createdAt.toMillis():0)-m})),t!=null&&t.assignedTo)l=(await Promise.all(l.map(async d=>d.isPrivate?d.createdBy===t.assignedTo||(await U(d.id)).some(h=>h.assignedTo===t.assignedTo&&h.status!=="rejected")?d:null:(await U(d.id)).some(p=>p.assignedTo===t.assignedTo&&p.status!=="rejected")?d:null))).filter(d=>d!==null);else{const c=(u=(i=B)==null?void 0:i.currentUser)==null?void 0:u.uid;c?l=await Promise.all(l.map(async d=>d.onlyInMyTasks?d.createdBy===c?d:null:!d.isPrivate||d.createdBy===c||(await U(d.id)).some(p=>p.assignedTo===c)?d:null)).then(d=>d.filter(m=>m!==null)):l=l.filter(d=>!d.onlyInMyTasks)}e(l)}catch(l){console.error("Subscribe to tasks error:",l),e([])}},n=>{var i,u,l;if((n==null?void 0:n.code)==="unavailable"||(n==null?void 0:n.code)==="not-found"||(i=n==null?void 0:n.message)!=null&&i.includes("404")||(u=n==null?void 0:n.message)!=null&&u.includes("network")||(l=n==null?void 0:n.message)!=null&&l.includes("transport errored")){e([]);return}e([])})}catch(a){return console.error("Subscribe to tasks setup error:",a),()=>{}}},_=async t=>{var e,a;try{const s=await j(f(w,"tasks",t));return s.exists()?{id:s.id,...s.data()}:null}catch(s){throw console.error("Get task by id error:",s),H(s)?Y(s,{operation:"read",collection:"tasks",documentId:t,userId:(a=(e=B)==null?void 0:e.currentUser)==null?void 0:a.uid}):s}},wt=async t=>{try{const e={...t,createdAt:k(),updatedAt:k()};t.dueDate!==void 0&&t.dueDate!==null?t.dueDate instanceof Date?e.dueDate=P.fromDate(t.dueDate):typeof t.dueDate=="string"&&(e.dueDate=P.fromDate(new Date(t.dueDate))):e.dueDate=null;const a=await C(T(w,"tasks"),e),s=await _(a.id);if(!s)throw new Error("GÃ¶rev oluÅŸturulamadÄ±");await D("CREATE","tasks",a.id,t.createdBy,null,s);try{const o=await Z(s),{createNotification:r}=await q(async()=>{const{createNotification:l}=await Promise.resolve().then(()=>Q);return{createNotification:l}},void 0),{getUserProfile:n}=await q(async()=>{const{getUserProfile:l}=await import("./index-Xd90qdO9.js").then(c=>c.bA);return{getUserProfile:l}},__vite__mapDeps([0,1])),i=await n(t.createdBy),u=(i==null?void 0:i.fullName)||(i==null?void 0:i.displayName)||(i==null?void 0:i.email)||"Bir kullanÄ±cÄ±";await Promise.all(o.map(async l=>{try{if(l===t.createdBy)return;await r({userId:l,type:"task_created",title:"Yeni gÃ¶rev oluÅŸturuldu",message:`${u} "${s.title}" adlÄ± yeni bir gÃ¶rev oluÅŸturdu.`,read:!1,relatedId:a.id,metadata:{createdBy:t.createdBy}})}catch(c){console.error("Error sending task creation notification to team leader:",l,c)}}))}catch(o){console.error("Error sending task creation notifications:",o)}return s}catch(e){throw console.error("Create task error:",e),H(e)?Y(e,{operation:"create",collection:"tasks",userId:t.createdBy,data:t}):e}},Z=async t=>{if(!t)return[];try{const e=await st(),a=[];if(t.createdBy){const s=await G(t.createdBy);if(s!=null&&s.approvedTeams&&s.approvedTeams.length>0)for(const o of s.approvedTeams){const r=e.find(n=>n.id===o);r!=null&&r.managerId&&!a.includes(r.managerId)&&a.push(r.managerId)}}if(t.projectId)try{const s=await L(t.projectId)}catch(s){console.error("Error fetching project:",s)}return a}catch(e){return console.error("Error getting team leaders:",e),[]}},gt=async(t,e,a)=>{var s,o;try{const r=await _(t),n={...e,updatedAt:k()};e.dueDate!==void 0&&(e.dueDate===null?n.dueDate=null:e.dueDate instanceof Date&&(n.dueDate=P.fromDate(e.dueDate))),await E(f(w,"tasks",t),n);const i=await _(t);if(a&&await D("UPDATE","tasks",t,a,r,i),i&&a)try{const u=await U(t),c=(await x()).find(m=>m.id===a),d=u.filter(m=>m.status==="accepted"||m.status==="pending").map(m=>m.assignedTo).filter(m=>m!==a);await Promise.all(d.map(async m=>{try{await N({userId:m,type:"task_updated",title:"GÃ¶rev gÃ¼ncellendi",message:`${(c==null?void 0:c.fullName)||(c==null?void 0:c.email)||"Bir kullanÄ±cÄ±"} "${i.title}" gÃ¶revinde deÄŸiÅŸiklik yaptÄ±.`,read:!1,relatedId:t,metadata:null})}catch(g){console.error("Error sending notification to user:",m,g)}}))}catch(u){console.error("Error sending task update notifications:",u)}}catch(r){throw console.error("Update task error:",r),H(r)?Y(r,{operation:"update",collection:"tasks",documentId:t,userId:a||((o=(s=B)==null?void 0:s.currentUser)==null?void 0:o.uid),data:e}):r}},yt=async(t,e)=>{var a,s,o,r,n;try{const i=await _(t);if(!i)throw new Error("GÃ¶rev bulunamadÄ±");const u=i.status,l=(s=(a=B)==null?void 0:a.currentUser)==null?void 0:s.uid,c={status:e,updatedAt:k()};if(u!==e&&l&&(c.statusUpdatedBy=l,c.statusUpdatedAt=k()),await E(f(w,"tasks",t),c),await D("UPDATE","tasks",t,((r=(o=B)==null?void 0:o.currentUser)==null?void 0:r.uid)||"system",{status:u},{status:e}),u!==e)try{const d=await U(t),m=await x(),g=(n=B)==null?void 0:n.currentUser,p=m.find(A=>A.id===(g==null?void 0:g.uid)),y={pending:"Beklemede",in_progress:"Devam Ediyor",completed:"TamamlandÄ±",cancelled:"Ä°ptal Edildi"},h=y[e]||e,$=y[u]||u;if(i.createdBy&&i.createdBy!==(g==null?void 0:g.uid))try{await N({userId:i.createdBy,type:"task_updated",title:"GÃ¶rev durumu deÄŸiÅŸti",message:`${(p==null?void 0:p.fullName)||(p==null?void 0:p.email)||"Bir kullanÄ±cÄ±"} "${i.title}" gÃ¶revinin durumunu "${$}" â†’ "${h}" olarak deÄŸiÅŸtirdi.`,read:!1,relatedId:t,metadata:{oldStatus:u,newStatus:e}})}catch(A){console.error("Error sending notification to task creator:",A)}const v=d.filter(A=>(A.status==="accepted"||A.status==="pending")&&A.assignedTo!==(g==null?void 0:g.uid)).map(A=>A.assignedTo);await Promise.all(v.map(async A=>{try{await N({userId:A,type:"task_updated",title:"GÃ¶rev durumu deÄŸiÅŸti",message:`${(p==null?void 0:p.fullName)||(p==null?void 0:p.email)||"Bir kullanÄ±cÄ±"} "${i.title}" gÃ¶revinin durumunu "${$}" â†’ "${h}" olarak deÄŸiÅŸtirdi.`,read:!1,relatedId:t,metadata:{oldStatus:u,newStatus:e}})}catch(V){console.error("Error sending notification to assigned user:",A,V)}}))}catch(d){console.error("Error sending task status change notifications:",d)}}catch(i){throw console.error("Update task status error:",i),i}},tt=async(t,e)=>{var a;try{const s=await _(t);if(!s)throw new Error("GÃ¶rev bulunamadÄ±");let o=[],r=[],n;try{o=await U(t),r=await x(),n=r.find(i=>i.id===e)}catch(i){console.error("Error fetching data for notifications:",i)}await K(f(w,"tasks",t)),e&&await D("DELETE","tasks",t,e,s,null);try{const i=(a=B)==null?void 0:a.currentUser;if(s.createdBy&&s.createdBy!==(i==null?void 0:i.uid))try{await N({userId:s.createdBy,type:"task_deleted",title:"GÃ¶rev silindi",message:`${(n==null?void 0:n.fullName)||(n==null?void 0:n.email)||"Bir kullanÄ±cÄ±"} "${s.title}" gÃ¶revini sildi.`,read:!1,relatedId:t,metadata:{taskTitle:s.title}})}catch(l){console.error("Error sending notification to task creator:",l)}const u=o.filter(l=>(l.status==="accepted"||l.status==="pending")&&l.assignedTo!==(i==null?void 0:i.uid)).map(l=>l.assignedTo);await Promise.all(u.map(async l=>{try{await N({userId:l,type:"task_deleted",title:"GÃ¶rev silindi",message:`${(n==null?void 0:n.fullName)||(n==null?void 0:n.email)||"Bir kullanÄ±cÄ±"} "${s.title}" gÃ¶revini sildi.`,read:!1,relatedId:t,metadata:{taskTitle:s.title}})}catch(c){console.error("Error sending notification to assigned user:",l,c)}}))}catch(i){console.error("Error sending task deletion notifications:",i)}}catch(s){throw console.error("Delete task error:",s),s}},et=async(t,e,a,s)=>{try{const o={taskId:t,assignedTo:e,assignedBy:a,status:"pending",notes:s||null,assignedAt:P.now(),acceptedAt:null,completedAt:null},r=await C(T(w,"tasks",t,"assignments"),o),n=f(w,"tasks",t),i=await j(n);if(i.exists()){const l=i.data().assignedUsers||[];l.includes(e)||await E(n,{assignedUsers:[...l,e]})}try{const[u,l]=await Promise.all([_(t),G(a)]);u&&await N({userId:e,type:"task_assigned",title:"Yeni gÃ¶rev atandÄ±",message:`${(l==null?void 0:l.fullName)||(l==null?void 0:l.email)||"Bir yÃ¶netici"} size "${u.title}" gÃ¶revini atadÄ±. Bildirim Ã¼zerinden kabul veya reddedebilirsiniz.`,read:!1,relatedId:t,metadata:{assignment_id:r.id}})}catch{}return await D("CREATE","task_assignments",r.id,a,null,o),{id:r.id,...o}}catch(o){throw console.error("Assign task error:",o),o}},ft=async(t,e)=>{var a,s;try{await E(f(w,"tasks",t,"assignments",e),{status:"accepted",acceptedAt:k()});const o=await _(t);await D("UPDATE","task_assignments",e,((s=(a=B)==null?void 0:a.currentUser)==null?void 0:s.uid)||"system",{status:"pending"},{status:"accepted",taskId:t,taskTitle:o==null?void 0:o.title});try{const n=(await j(f(w,"tasks",t,"assignments",e))).data();if(n){const{getNotifications:i}=await q(async()=>{const{getNotifications:c}=await Promise.resolve().then(()=>Q);return{getNotifications:c}},void 0),l=(await i(n.assignedTo,{limit:100})).find(c=>{if(c.type!=="task_assigned"||c.relatedId!==t)return!1;const d=c.metadata;return d&&typeof d=="object"&&"assignment_id"in d?d.assignment_id===e:!1});if(l){const c={...l.metadata,action:"accepted"};await J(l.id,{metadata:c,read:!0})}}}catch(r){console.error("Error updating assignment notification:",r)}try{const r=await _(t),i=(await j(f(w,"tasks",t,"assignments",e))).data();if(r&&i){const u=await Z(r),c=(await x()).find(d=>d.id===i.assignedTo);await Promise.all(u.map(async d=>{try{await N({userId:d,type:"task_assigned",title:"GÃ¶rev kabul edildi",message:`${(c==null?void 0:c.fullName)||(c==null?void 0:c.email)||"Bir kullanÄ±cÄ±"} "${r.title}" gÃ¶revini kabul etti.`,read:!1,relatedId:t,metadata:{assignment_id:e,action:"accepted"}})}catch(m){console.error("Error sending notification to team leader:",d,m)}}))}}catch(r){console.error("Error sending acceptance notifications:",r)}}catch(o){throw console.error("Accept task assignment error:",o),o}},ht=async(t,e,a)=>{var s,o,r,n,i,u;try{if(a.trim().length<20)throw new Error("Red sebebi en az 20 karakter olmalÄ±dÄ±r");await E(f(w,"tasks",t,"assignments",e),{status:"rejected",rejectionReason:a.trim()});const l=await _(t);await D("UPDATE","task_assignments",e,((o=(s=B)==null?void 0:s.currentUser)==null?void 0:o.uid)||"system",{status:"pending"},{status:"rejected",rejectionReason:a.trim(),taskId:t,taskTitle:l==null?void 0:l.title});try{const d=(await j(f(w,"tasks",t,"assignments",e))).data();if(d){const{getNotifications:m}=await q(async()=>{const{getNotifications:y}=await Promise.resolve().then(()=>Q);return{getNotifications:y}},void 0),p=(await m(d.assignedTo,{limit:100})).find(y=>{if(y.type!=="task_assigned"||y.relatedId!==t)return!1;const h=y.metadata;return h&&typeof h=="object"&&"assignment_id"in h?h.assignment_id===e:!1});if(p){const y={...p.metadata,action:"rejected"};await J(p.id,{metadata:y,read:!0})}}}catch(c){console.error("Error updating assignment notification:",c)}try{const c=await _(t),m=(await j(f(w,"tasks",t,"assignments",e))).data();if(c&&m){const g=await x(),p=g.find(v=>v.id===m.assignedTo),y=g.find(v=>v.id===c.createdBy),h=g.find(v=>v.id===m.assignedBy);if(m.assignedBy&&m.assignedBy!==((n=(r=B)==null?void 0:r.currentUser)==null?void 0:n.uid))try{await N({userId:m.assignedBy,type:"task_assigned",title:"GÃ¶rev reddedildi",message:`${(p==null?void 0:p.fullName)||(p==null?void 0:p.email)||"Bir kullanÄ±cÄ±"} "${c.title}" gÃ¶revini reddetti. Sebep: ${a.trim().substring(0,100)}${a.trim().length>100?"...":""}`,read:!1,relatedId:t,metadata:{assignment_id:e,action:"rejected",reason:a.trim(),assigned_user_id:m.assignedTo}})}catch(v){console.error("Error sending notification to task assigner:",v)}if(c.createdBy&&c.createdBy!==((u=(i=B)==null?void 0:i.currentUser)==null?void 0:u.uid)&&c.createdBy!==m.assignedBy)try{await N({userId:c.createdBy,type:"task_assigned",title:"GÃ¶rev reddedildi - OnayÄ±nÄ±z gerekiyor",message:`${(p==null?void 0:p.fullName)||(p==null?void 0:p.email)||"Bir kullanÄ±cÄ±"} "${c.title}" gÃ¶revini reddetti. Sebep: ${a.trim().substring(0,100)}${a.trim().length>100?"...":""}. LÃ¼tfen reddi onaylayÄ±n veya reddedin.`,read:!1,relatedId:t,metadata:{assignment_id:e,action:"rejection_pending_approval",reason:a.trim(),assigned_user_id:m.assignedTo}})}catch(v){console.error("Error sending notification to task creator:",v)}const $=await Z(c);await Promise.all($.filter(v=>v!==c.createdBy&&v!==m.assignedBy).map(async v=>{try{await N({userId:v,type:"task_assigned",title:"GÃ¶rev reddedildi",message:`${(p==null?void 0:p.fullName)||(p==null?void 0:p.email)||"Bir kullanÄ±cÄ±"} "${c.title}" gÃ¶revini reddetti. Sebep: ${a.trim().substring(0,100)}${a.trim().length>100?"...":""}`,read:!1,relatedId:t,metadata:{assignment_id:e,action:"rejected",reason:a.trim()}})}catch(A){console.error("Error sending notification to team leader:",v,A)}}))}}catch(c){console.error("Error sending rejection notifications:",c)}}catch(l){throw console.error("Reject task assignment error:",l),l}},U=async t=>{try{return(await S(T(w,"tasks",t,"assignments"))).docs.map(a=>({id:a.id,...a.data()}))}catch(e){throw console.error("Get task assignments error:",e),e}},kt=async(t,e,a)=>{try{const s=f(w,"tasks",t,"assignments",e),o=await j(s);if(!o.exists())return;const r=o.data();if(await K(s),r){const n=f(w,"tasks",t),i=await j(n);if(i.exists()){const l=i.data().assignedUsers||[];l.includes(r.assignedTo)&&await E(n,{assignedUsers:l.filter(c=>c!==r.assignedTo)})}if(r)try{const[u,l,c]=await Promise.all([_(t),a?G(a):Promise.resolve(null),G(r.assignedTo)]);if(u&&c){const d=await N({userId:r.assignedTo,type:"task_updated",title:"GÃ¶rev atamanÄ±z kaldÄ±rÄ±ldÄ±",message:`${(l==null?void 0:l.fullName)||(l==null?void 0:l.email)||"Bir yÃ¶netici"} sizi "${u.title}" gÃ¶revinden kaldÄ±rdÄ±.`,read:!1,relatedId:t,metadata:{assignment_id:e,action:"removed"}});if(u.createdBy&&u.createdBy!==a&&u.createdBy!==r.assignedTo){const m=await N({userId:u.createdBy,type:"task_updated",title:"GÃ¶rev atamasÄ± kaldÄ±rÄ±ldÄ±",message:`${(l==null?void 0:l.fullName)||(l==null?void 0:l.email)||"Bir yÃ¶netici"} "${(c==null?void 0:c.fullName)||(c==null?void 0:c.email)||"bir kullanÄ±cÄ±"}" kullanÄ±cÄ±sÄ±nÄ± "${u.title}" gÃ¶revinden kaldÄ±rdÄ±.`,read:!1,relatedId:t,metadata:{assignment_id:e,action:"removed",removed_user_id:r.assignedTo}})}}}catch{}}}catch(s){throw s}},vt=async(t,e,a)=>{try{const s={taskId:t,title:e,items:a.map(r=>({id:`${Date.now()}-${Math.random()}`,text:r.text,completed:r.completed||!1,createdAt:P.now(),completedAt:null})),createdAt:P.now(),updatedAt:P.now()};return{id:(await C(T(w,"tasks",t,"checklists"),s)).id,...s}}catch(s){throw console.error("Create checklist error:",s),s}},Et=async(t,e,a,s,o)=>{var r,n;try{if(o){const d=await _(t);if(!d)throw new Error("GÃ¶rev bulunamadÄ±");const{isAdmin:m,isMainAdmin:g}=await q(async()=>{const{isAdmin:h,isMainAdmin:$}=await import("./permissions-D79DzJt5.js");return{isAdmin:h,isMainAdmin:$}},__vite__mapDeps([2,3,0,1])),{getUserProfile:p}=await q(async()=>{const{getUserProfile:h}=await import("./index-Xd90qdO9.js").then($=>$.bA);return{getUserProfile:h}},__vite__mapDeps([0,1])),y=await p(o);if(!(y&&(m(y)||g(y)))){if(!(await U(t)).some(v=>v.assignedTo===o&&(v.status==="accepted"||v.status==="pending"))&&d.createdBy!==o)throw new Error("Checklist iÅŸaretleme yetkiniz yok. Sadece size atanan gÃ¶revlerin checklist'lerini iÅŸaretleyebilirsiniz.")}}const i=f(w,"tasks",t,"checklists",e),u=await j(i);if(!u.exists())throw new Error("Checklist bulunamadÄ±");const c=u.data().items.map(d=>d.id===a?{...d,completed:s,completedAt:s?P.now():null}:d);await E(i,{items:c,updatedAt:k()}),await D("UPDATE","checklist_items",`${t}/${e}/${a}`,o||((n=(r=B)==null?void 0:r.currentUser)==null?void 0:n.uid)||"system",{completed:!s},{completed:s})}catch(i){throw console.error("Update checklist item error:",i),i}},At=async t=>{try{return(await S(T(w,"tasks",t,"checklists"))).docs.map(a=>({id:a.id,...a.data()}))}catch(e){throw console.error("Get checklists error:",e),e}},Tt=async(t,e,a)=>{try{const s=f(w,"tasks",t,"checklists",e),o=await j(s);if(!o.exists())throw new Error("Checklist bulunamadÄ±");const r=o.data(),n={id:`${Date.now()}-${Math.random()}`,text:a,completed:!1,createdAt:P.now(),completedAt:null};await E(s,{items:[...r.items,n],updatedAt:k()})}catch(s){throw console.error("Add checklist item error:",s),s}},_t=async(t,e)=>{try{await K(f(w,"tasks",t,"checklists",e))}catch(a){throw console.error("Delete checklist error:",a),a}},bt=async(t,e,a)=>{try{const s=f(w,"tasks",t,"checklists",e),o=await j(s);if(!o.exists())throw new Error("Checklist bulunamadÄ±");const n=o.data().items.filter(i=>i.id!==a);await E(s,{items:n,updatedAt:k()})}catch(s){throw console.error("Delete checklist item error:",s),s}},Bt=async t=>{try{return(await S(R(T(w,"tasks",t,"comments"),z("createdAt","desc")))).docs.map(a=>({id:a.id,...a.data()}))}catch(e){throw console.error("Get task comments error:",e),e}},Dt=async(t,e,a,s,o,r,n)=>{try{const i={taskId:t,userId:e,userName:r,userEmail:n,action:a,description:s,metadata:o||{},createdAt:P.now()};return(await C(T(w,"tasks",t,"activities"),i)).id}catch(i){return console.error("Add task activity error:",i),""}},jt=async t=>{try{return(await S(R(T(w,"tasks",t,"activities"),z("createdAt","desc")))).docs.map(a=>({id:a.id,...a.data()}))}catch(e){throw console.error("Get task activities error:",e),e}},Rt=async(t,e)=>{var a,s,o,r,n,i;try{const u=await _(t);if(!u)throw new Error("GÃ¶rev bulunamadÄ±");const l=(s=(a=B)==null?void 0:a.currentUser)==null?void 0:s.uid;if(!l)throw new Error("KullanÄ±cÄ± oturumu bulunamadÄ±");const c=await G(l);if(!c)throw new Error("KullanÄ±cÄ± profili bulunamadÄ±");if(!(((o=c.role)==null?void 0:o.includes("admin"))||((r=c.role)==null?void 0:r.includes("super_admin"))||((n=c.role)==null?void 0:n.includes("main_admin")))&&!(u.createdBy===l)&&!(await U(t)).filter(A=>A.status==="accepted").map(A=>A.assignedTo).includes(l))throw new Error("Bu gÃ¶reve dosya eklemek iÃ§in yetkiniz yok. Sadece size atanan gÃ¶revlere veya oluÅŸturduÄŸunuz gÃ¶revlere dosya ekleyebilirsiniz.");const m={...e,uploadedAt:k()},g=await C(T(w,"tasks",t,"attachments"),m),p=await j(g);return{id:g.id,...p.data(),uploadedAt:((i=p.data())==null?void 0:i.uploadedAt)||P.now()}}catch(u){throw console.error("Add task attachment error:",u),u}},Nt=async t=>{try{return(await S(R(T(w,"tasks",t,"attachments"),z("uploadedAt","desc")))).docs.map(a=>({id:a.id,...a.data()}))}catch(e){throw console.error("Get task attachments error:",e),e}},$t=async(t,e)=>{var a,s,o,r,n;try{const i=await _(t);if(!i)throw new Error("GÃ¶rev bulunamadÄ±");const u=(s=(a=B)==null?void 0:a.currentUser)==null?void 0:s.uid;if(!u)throw new Error("KullanÄ±cÄ± oturumu bulunamadÄ±");const l=await G(u);if(!l)throw new Error("KullanÄ±cÄ± profili bulunamadÄ±");if(!(((o=l.role)==null?void 0:o.includes("admin"))||((r=l.role)==null?void 0:r.includes("super_admin"))||((n=l.role)==null?void 0:n.includes("main_admin")))&&!(i.createdBy===u)&&!(await U(t)).filter(y=>y.status==="accepted").map(y=>y.assignedTo).includes(u))throw new Error("Bu gÃ¶revden dosya silmek iÃ§in yetkiniz yok. Sadece size atanan gÃ¶revlerden veya oluÅŸturduÄŸunuz gÃ¶revlerden dosya silebilirsiniz.");await K(f(w,"tasks",t,"attachments",e))}catch(i){throw console.error("Delete task attachment error:",i),i}},St=async(t,e)=>{try{const a=f(w,"tasks",t),s=await j(a);if(!s.exists())throw new Error("GÃ¶rev bulunamadÄ±");const o=s.data(),r=o.poolRequests||[];if(r.includes(e))throw new Error("Bu gÃ¶rev iÃ§in zaten talep yaptÄ±nÄ±z");await E(a,{poolRequests:[...r,e],updatedAt:k()}),await D("UPDATE","tasks",t,e,{poolRequests:r},{poolRequests:[...r,e]});const n=o.createdBy;if(n&&n!==e)try{const i=await G(e),u=(i==null?void 0:i.fullName)||(i==null?void 0:i.displayName)||(i==null?void 0:i.email)||"Bir kullanÄ±cÄ±";await N({userId:n,type:"task_pool_request",title:"GÃ¶rev Talebi",message:`${u} "${o.title}" gÃ¶revi iÃ§in talep gÃ¶nderdi.`,read:!1,metadata:{taskId:t,taskTitle:o.title,requestedBy:e,requestedByName:u,link:`/tasks/${t}`}})}catch(i){console.error("Bildirim gÃ¶nderme hatasÄ±:",i)}}catch(a){throw console.error("Request task from pool error:",a),a}},Pt=async(t,e,a,s=!1)=>{try{const o=f(w,"tasks",t),r=await j(o);if(!r.exists())throw new Error("GÃ¶rev bulunamadÄ±");const i=r.data().poolRequests||[];if(!i.includes(e))throw new Error("Bu kullanÄ±cÄ± iÃ§in talep bulunamadÄ±");await et(t,e,a);const u={poolRequests:i.filter(l=>l!==e),updatedAt:k()};s||(u.isInPool=!1,u.poolRequests=[]),await E(o,u),await D("UPDATE","tasks",t,a,{isInPool:!0,poolRequests:i},{isInPool:s,poolRequests:u.poolRequests,assignedTo:e})}catch(o){throw console.error("Approve pool request error:",o),o}},Ut=async(t,e)=>{var a,s;try{const o=f(w,"tasks",t),r=await j(o);if(!r.exists())throw new Error("GÃ¶rev bulunamadÄ±");const i=r.data().poolRequests||[];if(!i.includes(e))throw new Error("Bu kullanÄ±cÄ± iÃ§in talep bulunamadÄ±");await E(o,{poolRequests:i.filter(u=>u!==e),updatedAt:k()}),await D("UPDATE","tasks",t,((s=(a=B)==null?void 0:a.currentUser)==null?void 0:s.uid)||"system",{poolRequests:i},{poolRequests:i.filter(u=>u!==e),rejectedUser:e})}catch(o){throw console.error("Reject pool request error:",o),o}},Gt=async(t,e)=>{var a,s,o;try{const r=await _(t);if(!r)throw new Error("GÃ¶rev bulunamadÄ±");if(r.approvalStatus==="pending")return;if(r.approvalStatus==="approved")throw new Error("Bu gÃ¶rev zaten onaylanmÄ±ÅŸ.");const n=await G(e);if(!n)throw new Error("KullanÄ±cÄ± profili bulunamadÄ±");if(!(((a=n.role)==null?void 0:a.includes("admin"))||((s=n.role)==null?void 0:s.includes("super_admin"))||((o=n.role)==null?void 0:o.includes("main_admin")))&&!(await U(t)).filter(d=>d.status==="accepted").map(d=>d.assignedTo).includes(e))throw new Error("Bu gÃ¶revi onaya gÃ¶ndermek iÃ§in yetkiniz yok. Sadece size atanan gÃ¶revleri onaya gÃ¶nderebilirsiniz.");await E(f(w,"tasks",t),{approvalStatus:"pending",approvalRequestedBy:e,updatedAt:k()}),await D("UPDATE","tasks",t,e,{approvalStatus:r.approvalStatus||"none"},{approvalStatus:"pending"});try{if(r&&r.createdBy){const{getNotifications:u}=await q(async()=>{const{getNotifications:d}=await Promise.resolve().then(()=>Q);return{getNotifications:d}},void 0);(await u(r.createdBy,{unreadOnly:!0})).some(d=>{var m;return d.type==="task_approval"&&d.relatedId===t&&((m=d.metadata)==null?void 0:m.action)==="approval_requested"})||await N({userId:r.createdBy,type:"task_approval",title:"GÃ¶rev onayÄ± bekleniyor",message:`${(n==null?void 0:n.fullName)||(n==null?void 0:n.email)||"Bir kullanÄ±cÄ±"} "${r.title}" gÃ¶revini tamamladÄ± ve onayÄ±nÄ±zÄ± bekliyor.`,read:!1,relatedId:t,metadata:{action:"approval_requested"}})}}catch(u){console.error("Error sending approval request notification:",u)}}catch(r){throw console.error("Request task approval error:",r),r}},zt=async(t,e)=>{var a,s,o,r,n;try{const i=await _(t);if(!i)throw new Error("GÃ¶rev bulunamadÄ±");if(i.approvalStatus==="approved")throw new Error("Bu gÃ¶rev zaten onaylanmÄ±ÅŸ. Tekrar onaylanamaz.");if(i.approvalStatus!=="pending")throw new Error("Bu gÃ¶rev onay beklenmiyor.");const u=await G(e);if(!u)throw new Error("KullanÄ±cÄ± profili bulunamadÄ±");const l=((a=u.role)==null?void 0:a.includes("admin"))||((s=u.role)==null?void 0:s.includes("super_admin"))||((o=u.role)==null?void 0:o.includes("main_admin")),c=(r=u.role)==null?void 0:r.includes("team_leader"),d=i.createdBy===e;if(!l&&!(c&&d))throw new Error("Bu gÃ¶revi onaylamak iÃ§in yetkiniz yok. Sadece yÃ¶neticiler veya gÃ¶revi veren ekip liderleri onaylayabilir.");const m=i.status,g=(n=B)==null?void 0:n.currentUser;await E(f(w,"tasks",t),{approvalStatus:"approved",status:"completed",approvedBy:e,approvedAt:k(),updatedAt:k()}),m!=="completed"&&(g!=null&&g.uid)&&await E(f(w,"tasks",t),{statusUpdatedBy:g.uid,statusUpdatedAt:k()}),await D("UPDATE","tasks",t,e,{approvalStatus:"pending",status:m},{approvalStatus:"approved",status:"completed"});try{const p=await _(t),y=await G(e);if(p&&p.approvalRequestedBy){const{getNotifications:h}=await q(async()=>{const{getNotifications:A}=await Promise.resolve().then(()=>Q);return{getNotifications:A}},void 0);(await h(p.approvalRequestedBy,{unreadOnly:!0})).some(A=>{var V;return A.type==="task_approval"&&A.relatedId===t&&((V=A.metadata)==null?void 0:V.action)==="approved"})||await N({userId:p.approvalRequestedBy,type:"task_approval",title:"GÃ¶rev onaylandÄ±",message:`${(y==null?void 0:y.fullName)||(y==null?void 0:y.email)||"YÃ¶netici"} "${p.title}" gÃ¶revini onayladÄ± ve tamamlandÄ± olarak iÅŸaretlendi.`,read:!1,relatedId:t,metadata:{action:"approved"}})}}catch(p){console.error("Error sending approval notification:",p)}}catch(i){throw console.error("Approve task error:",i),i}},qt=async(t,e,a)=>{var s;try{const o=await _(t);if(!o)throw new Error("GÃ¶rev bulunamadÄ±");const r=o.status,n=(s=B)==null?void 0:s.currentUser;await E(f(w,"tasks",t),{approvalStatus:"rejected",status:"in_progress",rejectedBy:e,rejectedAt:k(),rejectionReason:a||null,updatedAt:k()}),r!=="in_progress"&&(n!=null&&n.uid)&&await E(f(w,"tasks",t),{statusUpdatedBy:n.uid,statusUpdatedAt:k()}),await D("UPDATE","tasks",t,e,{approvalStatus:"pending",status:r},{approvalStatus:"rejected",status:"in_progress",rejectionReason:a});try{const i=await _(t),u=await G(e);if(i){const c=(await U(t)).filter(g=>g.status!=="rejected").map(g=>g.assignedTo),d=new Set;c.forEach(g=>d.add(g)),i.createdBy&&!d.has(i.createdBy)&&d.add(i.createdBy),i.approvalRequestedBy&&!d.has(i.approvalRequestedBy)&&d.add(i.approvalRequestedBy);const m=a?`${(u==null?void 0:u.fullName)||(u==null?void 0:u.email)||"YÃ¶netici"} "${i.title}" gÃ¶revi iÃ§in tamamlanma onayÄ±nÄ± reddetti. Not: ${a}`:`${(u==null?void 0:u.fullName)||(u==null?void 0:u.email)||"YÃ¶netici"} "${i.title}" gÃ¶revi iÃ§in tamamlanma onayÄ±nÄ± reddetti.`;await Promise.all(Array.from(d).map(async g=>{try{await N({userId:g,type:"task_approval",title:"GÃ¶rev onayÄ± reddedildi",message:m,read:!1,relatedId:t,metadata:{action:"rejected",rejectionReason:a}})}catch{}}))}}catch{}}catch(o){throw console.error("Reject task approval error:",o),o}},Ot=async(t,e)=>{var a,s;try{const o=(s=(a=B)==null?void 0:a.currentUser)==null?void 0:s.uid;if(!o)throw new Error("KullanÄ±cÄ± kimliÄŸi bulunamadÄ±");const r=f(w,"tasks",t,"assignments",e),n=await j(r);if(!n.exists())throw new Error("GÃ¶rev atamasÄ± bulunamadÄ±");const i=n.data();if(i.status!=="rejected")throw new Error("GÃ¶rev reddedilmemiÅŸ");await E(r,{rejectionApprovedBy:o,rejectionApprovedAt:k()});const u=await _(t);await D("UPDATE","task_assignments",e,o,{rejectionApprovedBy:null},{rejectionApprovedBy:o,taskId:t,taskTitle:u==null?void 0:u.title});try{const l=await x(),c=l.find(m=>m.id===i.assignedTo),d=l.find(m=>m.id===o);c&&await N({userId:i.assignedTo,type:"task_assigned",title:"GÃ¶rev reddi onaylandÄ±",message:`${(d==null?void 0:d.fullName)||(d==null?void 0:d.email)||"YÃ¶netici"} "${u==null?void 0:u.title}" gÃ¶revi iÃ§in reddinizi onayladÄ±. GÃ¶rev artÄ±k baÅŸka birine atanabilir.`,read:!1,relatedId:t,metadata:{assignment_id:e,action:"rejection_approved"}})}catch(l){console.error("Error sending approval notification:",l)}}catch(o){throw console.error("Approve task rejection error:",o),o}},Ct=async(t,e,a)=>{var s,o;try{const r=(o=(s=B)==null?void 0:s.currentUser)==null?void 0:o.uid;if(!r)throw new Error("KullanÄ±cÄ± kimliÄŸi bulunamadÄ±");if(a.trim().length<20)throw new Error("Red sebebi en az 20 karakter olmalÄ±dÄ±r");const n=f(w,"tasks",t,"assignments",e),i=await j(n);if(!i.exists())throw new Error("GÃ¶rev atamasÄ± bulunamadÄ±");const u=i.data();if(u.status!=="rejected")throw new Error("GÃ¶rev reddedilmemiÅŸ");await E(n,{status:"pending",rejectionRejectedBy:r,rejectionRejectedAt:k(),rejectionRejectionReason:a.trim(),rejectionReason:null});const l=await _(t);await D("UPDATE","task_assignments",e,r,{status:"rejected"},{status:"pending",rejectionRejectedBy:r,rejectionRejectionReason:a.trim(),taskId:t,taskTitle:l==null?void 0:l.title});try{const c=await x(),d=c.find(g=>g.id===u.assignedTo),m=c.find(g=>g.id===r);d&&await N({userId:u.assignedTo,type:"task_assigned",title:"GÃ¶rev reddi reddedildi",message:`${(m==null?void 0:m.fullName)||(m==null?void 0:m.email)||"YÃ¶netici"} "${l==null?void 0:l.title}" gÃ¶revi iÃ§in reddinizi reddetti. GÃ¶rev tekrar size atandÄ±. Not: ${a.trim().substring(0,100)}${a.trim().length>100?"...":""}`,read:!1,relatedId:t,metadata:{assignment_id:e,action:"rejection_rejected",reason:a.trim()}})}catch(c){console.error("Error sending rejection notification:",c)}}catch(r){throw console.error("Reject task rejection error:",r),r}},xt=async(t,e)=>{try{await E(f(w,"tasks",t),{isArchived:!0,updatedAt:k()}),await D("UPDATE","tasks",t,e,{isArchived:!1},{isArchived:!0})}catch(a){throw console.error("Archive task error:",a),a}},Mt=async(t,e)=>{try{await E(f(w,"tasks",t),{isArchived:!1,updatedAt:k()}),await D("UPDATE","tasks",t,e,{isArchived:!0},{isArchived:!1})}catch(a){throw console.error("Unarchive task error:",a),a}},Lt=async t=>{try{const e=T(w,"tasks"),a=await S(e);let s=F(w),o=0;const r=500;for(const l of a.docs){const c=l.data(),d=l.id,m=c.assignedUsers||[];if(m.includes(t)){const y=m.filter(v=>v!==t),h=y.length===0,$={assignedUsers:y};h&&($.isInPool=!0,$.poolRequests=[]),s.update(l.ref,$),o++,o>=r&&(await s.commit(),o=0,s=F(w))}const g=T(w,`tasks/${d}/assignments`),p=await S(R(g,b("assignedTo","==",t)));for(const y of p.docs)s.delete(y.ref),o++,o>=r&&(await s.commit(),o=0,s=F(w))}o>0&&await s.commit();const n=await S(R(e,b("createdBy","==",t)));let i=F(w),u=0;for(const l of n.docs)i.update(l.ref,{createdBy:"deleted_user",createdByName:"SilinmiÅŸ KullanÄ±cÄ±"}),u++,u>=r&&(await i.commit(),u=0,i=F(w));u>0&&await i.commit()}catch(e){throw console.error("Error removing user from tasks:",e),e}},Qt=Object.freeze(Object.defineProperty({__proto__:null,acceptTaskAssignment:ft,addChecklistItem:Tt,addTaskActivity:Dt,addTaskAttachment:Rt,approvePoolRequest:Pt,approveTask:zt,approveTaskRejection:Ot,archiveTask:xt,assignTask:et,createChecklist:vt,createTask:wt,deleteChecklist:_t,deleteChecklistItem:bt,deleteTask:tt,deleteTaskAssignment:kt,deleteTaskAttachment:$t,getChecklists:At,getTaskActivities:jt,getTaskAssignments:U,getTaskAttachments:Nt,getTaskById:_,getTaskComments:Bt,getTasks:I,rejectPoolRequest:Ut,rejectTaskApproval:qt,rejectTaskAssignment:ht,rejectTaskRejection:Ct,removeUserFromAllTasks:Lt,requestTaskApproval:Gt,requestTaskFromPool:St,subscribeToTasks:pt,unarchiveTask:Mt,updateChecklistItem:Et,updateTask:gt,updateTaskStatus:yt},Symbol.toStringTag,{value:"Module"}));export{L as A,tt as B,xt as C,Mt as D,Bt as E,jt as F,At as G,Nt as H,Rt as I,$t as J,vt as K,_t as L,Tt as M,Et as N,bt as O,gt as P,kt as Q,et as R,Dt as S,wt as T,Q as U,Kt as V,Qt as W,U as a,I as b,dt as c,Pt as d,Ut as e,Gt as f,_ as g,Y as h,H as i,lt as j,ut as k,mt as l,N as m,rt as n,ot as o,ft as p,J as q,St as r,ct as s,ht as t,yt as u,Ot as v,Ct as w,zt as x,qt as y,pt as z};
